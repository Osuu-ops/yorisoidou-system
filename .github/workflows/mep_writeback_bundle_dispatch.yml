# PATCH_MARKER: gen-runstep 20260131_021740
# PATCH_MARKER: generate-via-compiler 20260131_021532
name: MEP Writeback Bundle (Evidence)

on:
  workflow_call:
    inputs:
      pr_number:
        description: 'PR number (0 = auto latest merged PR)'
        required: false
        type: string
        default: '0'
      write_handoff:
        description: 'Generate+Guard+Writeback HANDOFF_NEXT into Bundled'
        required: false
        type: string
        default: 'false'
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number (0 = auto latest merged PR)'
        required: false
        default: '0'
      write_handoff:
        description: 'Generate+Guard+Writeback HANDOFF_NEXT into Bundled'
        required: false
        default: 'false'

permissions:
  contents: write
  pull-requests: write

jobs:
  writeback:
    env:
      GH_TOKEN: ${{ github.token }}    permissions:
      contents: write
      pull-requests: write
      actions: read    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git identity
        shell: bash
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      - name: Generate Bundled (update docs/MEP/MEP_BUNDLE.md)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"

          # (re)generate Bundled so diff can exist BEFORE writeback
          pwsh -NoProfile -File tools/mep_bump_bundle_version.ps1 -BundlePath "docs/MEP/MEP_BUNDLE.md"

          # evidence (non-fatal)
          git status --porcelain -- docs/MEP/MEP_BUNDLE.md || true
      - name: Writeback evidence -> PR (slim)
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.MEP_PR_TOKEN }}
        run: |
          pwsh -NoProfile -File tools/mep_writeback_bundle.ps1 -Mode pr -PrNumber ${{ inputs.pr_number }} -BundlePath "docs/MEP/MEP_BUNDLE.md" -BundleScope "parent"

      - name: Create PR for writeback branch
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.MEP_PR_TOKEN }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = 'Stop'
          function Info([string]$m){ Write-Host ('[INFO] {0}' -f $m) }
          function Warn([string]$m){ Write-Host ('[WARN] {0}' -f $m) }
          
          # If current branch is auto/writeback-bundle_*, create PR (if not exists)
          $head = (git rev-parse --abbrev-ref HEAD).Trim()
          Info ('HEAD=' + $head)
          if ($head -notlike 'auto/writeback-bundle_*') {
            Warn 'Not on auto/writeback-bundle_* branch; skip PR create.'
            exit 0
          }
          
          # if PR already exists for this head, skip
          $exists = gh pr list --state open --head $head --json number --jq '.[0].number' 2>$null
          if ($exists) {
            Info ('PR already exists for head ' + $head + ': #' + $exists)
            exit 0
          }
          
          $title = ('Writeback bundle evidence ({0})' -f $head)
          $body  = ('Automated writeback: created from branch {0} (run_id=' + ${{ github.run_id }} + ')' -f $head)
          $url = gh pr create --title $title --body $body --base 'main' --head $head
          Info ('Created PR: ' + $url)
      - name: Writeback HANDOFF_NEXT -> PR (slim)
        if: ${{ inputs.write_handoff == 'true' }}
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.MEP_PR_TOKEN }}
        run: |
          pwsh -NoProfile -File tools/mep_writeback_handoff.ps1 -CI

      - name: GUARD_NO_PARENT_BUNDLED_WRITE
        shell: bash
        run: |
          set -euo pipefail
          if git diff --name-only | grep -q '^docs/MEP/MEP_BUNDLE\.md$'; then
            echo "ERROR: HANDOFF_NEXT must not modify docs/MEP/MEP_BUNDLE.md (parent Bundled)."
            echo "This prevents writeback-order rollback. Write to docs/MEP/MEP_BUNDLE.md instead."
            git diff -- docs/MEP/MEP_BUNDLE.md || true
            exit 1
          fi




name: Chat Packet Update (Schedule)

on:
  schedule:
    # 毎日 03:10 JST（= 18:10 UTC）
    - cron: "10 18 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: chat-packet-update-schedule
  cancel-in-progress: false

jobs:
  update-chat-packet:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main (with PAT for PR checks stability)
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.MEP_PR_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git config --global core.quotepath false

      - name: Abort if an auto chat-packet PR is already open
        env:
          GH_TOKEN: ${{ secrets.MEP_PR_TOKEN }}
        run: |
          set -euo pipefail
          COUNT=$(gh pr list --state open --base main --json number,headRefName \
            --jq '[.[] | select(.headRefName | startswith("auto/chat-packet-update-"))] | length')
          if [ "$COUNT" != "0" ]; then
            echo "An auto chat-packet PR is already open ($COUNT). Skip."
            exit 0
          fi

      - name: Build CHAT_PACKET on main
        run: |
          set -euo pipefail
          python3 docs/MEP/build_chat_packet.py

      - name: Detect changes (docs/MEP/CHAT_PACKET.md only)
        id: diff
        run: |
          set -euo pipefail

          if [ -z "$(git status --porcelain)" ]; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Strict: allow ONLY exactly one changed file: docs/MEP/CHAT_PACKET.md
          FILES=$(git diff --name-only | sed '/^$/d')
          echo "Changed files:"
          echo "$FILES"

          COUNT=$(printf "%s\n" "$FILES" | wc -l | tr -d ' ')
          if [ "$COUNT" -ne 1 ] || [ "$FILES" != "docs/MEP/CHAT_PACKET.md" ]; then
            echo "Unexpected changes detected. Refuse to create PR."
            git diff
            exit 1
          fi

          echo "has_changes=true" >> "$GITHUB_OUTPUT"

      - name: Create branch + commit + push
        if: ${{ steps.diff.outputs.has_changes == 'true' }}
        id: commit
        run: |
          set -euo pipefail
          TS=$(date +%Y%m%d-%H%M%S)
          BRANCH="auto/chat-packet-update-${TS}"
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"

          git checkout -b "$BRANCH"
          git add docs/MEP/CHAT_PACKET.md
          git commit -m "docs(MEP): update CHAT_PACKET"
          git push -u origin "$BRANCH"

      - name: Create PR + enable auto-merge (Required checks OK -> merge)
        if: ${{ steps.diff.outputs.has_changes == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.MEP_PR_TOKEN }}
        run: |
          set -euo pipefail
          BRANCH="${{ steps.commit.outputs.branch }}"
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          TITLE="docs(MEP): update CHAT_PACKET"
          BODY=$'Scheduled update of docs/MEP/CHAT_PACKET.md.\n\n- Generated by docs/MEP/build_chat_packet.py\n- Run: '"$RUN_URL"$'\n'

          PR_URL=$(gh pr create \
            --base main \
            --head "$BRANCH" \
            --title "$TITLE" \
            --body "$BODY" \
            --repo "${{ github.repository }}")

          echo "Created PR: $PR_URL"
          PR_NUMBER=$(echo "$PR_URL" | sed -E 's#.*/pull/([0-9]+).*#\1#')

          gh pr merge "$PR_NUMBER" --auto --squash --delete-branch --repo "${{ github.repository }}"

name: MEP Loop Engine
on:
  workflow_dispatch:
    inputs:
      iter:
        description: "current iteration (0..)"
        required: false
        default: "0"
      max_iter:
        description: "max iterations (hard stop). default 50"
        required: false
        default: "50"
      sleep_seconds:
        description: "throttle seconds between hops. default 5"
        required: false
        default: "5"
concurrency:
  group: mep-loop-engine
  cancel-in-progress: false
permissions:
  contents: write
  actions: write
  pull-requests: write
  contents: read
  actions: write
jobs:
  zone:
    runs-on: ubuntu-latest
    steps:
      - name: Emit MEP_COPYPASTE_ZONE
        shell: bash
        run: |
          echo "===== MEP_COPYPASTE_ZONE BEGIN ====="
          echo "RESTART_PACKET"
          echo "RUN_STATE_CODE=RUNNING"
          echo "MODE=DISPATCH_LOOP_ENGINE"
          echo "ITER=${{ inputs.iter }}"
          echo "MAX_ITER=${{ inputs.max_iter }}"
          echo "SLEEP_SECONDS=${{ inputs.sleep_seconds }}"
          echo "REPO_ORIGIN=https://github.com/${GITHUB_REPOSITORY}"
          echo "BRANCH=${GITHUB_REF_NAME}"
          echo "HEAD_SHA=${GITHUB_SHA}"
          echo "NEXT_ACTION=DISPATCH_ENTRY"
          echo "===== MEP_COPYPASTE_ZONE END ====="
      # TODO: ここに「本体処理」を差し込む（writeback/bundle/evidence/health 等）
      # いったんは“ループが安定して回る”ことを最優先。
      - name: Throttle
        shell: bash
        run: |
          set -euo pipefail
          S="${{ inputs.sleep_seconds }}"
          if [ -z "${S}" ]; then S="5"; fi
          if [ "${S}" -gt 30 ]; then S="30"; fi
          sleep "${S}"
      - name: Dispatch Entry (bounded, fail-fast)
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          ITER="${{ inputs.iter }}"
          MAX="${{ inputs.max_iter }}"
          if [ -z "${MAX}" ]; then MAX="50"; fi
          if [ "${MAX}" -gt 200 ]; then MAX="200"; fi
          NEXT=$((ITER+1))
          if [ "${NEXT}" -gt "${MAX}" ]; then
            echo "[STOP] reached max_iter: ${MAX}"
            exit 0
          fi
          echo "[GO] dispatch Entry: iter=${NEXT}/${MAX}"
          curl --fail-with-body -sS -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            "https://api.github.com/repos/${REPO}/actions/workflows/mep_loop_entry.yml/dispatches" \
            -d "{\"ref\":\"main\",\"inputs\":{\"iter\":\"${NEXT}\",\"max_iter\":\"${MAX}\",\"sleep_seconds\":\"${{ inputs.sleep_seconds }}\"}}"

      - name: Checkout (for PR)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Prepare heartbeat commit (auto/loop-heartbeat)
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          git config user.name  "mep-loop-bot"
          git config user.email "mep-loop-bot@users.noreply.github.com"
          BR="auto/loop-heartbeat"
          git checkout -B "${BR}"
          mkdir -p docs/MEP_SUB/STATE
          TS="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "${TS} ITER=${{ inputs.iter }} MAX=${{ inputs.max_iter }} SHA=${GITHUB_SHA}" >> docs/MEP_SUB/STATE/LOOP_HEARTBEAT.md
          git add docs/MEP_SUB/STATE/LOOP_HEARTBEAT.md
          if git diff --cached --quiet; then
            echo "[OK] no changes"
            exit 0
          fi
          git commit -m "chore(loop): heartbeat iter=${{ inputs.iter }} sha=${GITHUB_SHA}"
          git push -u origin "${BR}"
      - name: Open/Update PR (auto/loop-heartbeat)
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          BR="auto/loop-heartbeat"
          # If open PR exists, do nothing (branch push already updates it)
          PRNUM="$(gh pr list -R "${REPO}" --head "${BR}" --state open --json number --jq '.[0].number' 2>/dev/null || true)"
          if [ -n "${PRNUM}" ]; then
            echo "[OK] PR already open: #${PRNUM}"
            exit 0
          fi
          gh pr create -R "${REPO}" --base main --head "${BR}" \
            --title "chore(loop): heartbeat (auto/loop-heartbeat)" \
            --body "Auto heartbeat PR from MEP Loop Engine. Merge only when policy allows."

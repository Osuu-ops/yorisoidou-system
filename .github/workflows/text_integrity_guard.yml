name: Text Integrity Guard

on:
  pull_request:
  workflow_dispatch:
  push:

permissions:
  contents: read

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---- base/head をイベント別に安全に出す（push で PR 専用 context を参照しない） ----
      - name: Revs (pull_request)
        id: revs_pr
        if: github.event_name == 'pull_request'
        shell: bash
        run: |
          set -euo pipefail
          echo "base=${{ github.event.pull_request.base.sha }}" >> "$GITHUB_OUTPUT"
          echo "head=${{ github.sha }}" >> "$GITHUB_OUTPUT"

      - name: Revs (push/workflow_dispatch)
        id: revs_other
        if: github.event_name != 'pull_request'
        shell: bash
        run: |
          set -euo pipefail
          HEAD="${GITHUB_SHA}"
          BASE="${{ github.event.before }}"
          # 新規ブランチ初回push等で before が空/0 の場合がある
          if [ -z "$BASE" ] || echo "$BASE" | grep -qE '^0+$'; then
            BASE="$(git rev-parse "${HEAD}^" 2>/dev/null || true)"
          fi
          echo "base=$BASE" >> "$GITHUB_OUTPUT"
          echo "head=$HEAD" >> "$GITHUB_OUTPUT"

      - name: Detect changed files
        shell: bash
        run: |
          set -euo pipefail
          BASE="${{ steps.revs_pr.outputs.base || steps.revs_other.outputs.base }}"
          HEAD="${{ steps.revs_pr.outputs.head || steps.revs_other.outputs.head }}"
          if [ -z "$BASE" ]; then
            echo "BASE empty -> skip diff"
            : > changed_files.txt
            exit 0
          fi
          git diff --name-only "$BASE...$HEAD" > changed_files.txt
          echo "Changed files:"
          cat changed_files.txt || true

      - name: Validate encoding / EOL / newline and tripwire on sensitive large diffs
        shell: bash
        run: |
          set -euo pipefail
          BASE="${{ steps.revs_pr.outputs.base || steps.revs_other.outputs.base }}"
          HEAD="${{ steps.revs_pr.outputs.head || steps.revs_other.outputs.head }}"
          fail=0

          while IFS= read -r f; do
            [ -z "$f" ] && continue
            [ ! -f "$f" ] && continue

            bn="$(basename "$f")"
            is_sensitive=0
            if [ "$bn" = "master_spec" ] || [ "$bn" = "ui_spec.md" ]; then
              is_sensitive=1
            fi

            # 対象：*.md と、sensitive（master_spec / ui_spec.md）
            if [[ "$f" == *.md ]] || [ "$is_sensitive" -eq 1 ]; then
              # 1) CR(\r) 禁止
              if python3 - <<'PY' "$f"
import sys
p=sys.argv[1]
b=open(p,'rb').read()
sys.exit(1 if b.find(b'\r')!=-1 else 0)
PY
              then :; else
                echo "NG: CRLF/CR detected in $f"
                fail=1
              fi

              # 2) UTF-8 で decode できること
              python3 - <<'PY' "$f" || (echo "NG: invalid UTF-8 in $f"; exit 1)
import sys
p=sys.argv[1]
open(p,'rb').read().decode('utf-8')
PY

              # 3) 最終改行必須（空ファイルは除外）
              python3 - <<'PY' "$f" || (echo "NG: missing final newline in $f"; exit 1)
import sys
p=sys.argv[1]
b=open(p,'rb').read()
if len(b)>0 and b[-1:]!=b'\n':
  raise SystemExit(1)
PY
            fi

            # 4) sensitive の巨大差分トリガ（BASE が取れているときのみ）
            if [ "$is_sensitive" -eq 1 ] && [ -n "$BASE" ]; then
              numstat=$(git diff --numstat "$BASE...$HEAD" -- "$f" | awk '{print $1" "$2}')
              ins=$(echo "$numstat" | awk '{print $1}')
              del=$(echo "$numstat" | awk '{print $2}')
              ins=${ins:-0}; del=${del:-0}
              total=$((ins+del))
              echo "SENSITIVE_DIFF $f: +$ins -$del (total=$total)"
              if [ "$total" -gt 200 ]; then
                echo "NG: large diff detected on sensitive file ($f). total=$total > 200"
                fail=1
              fi
            fi

          done < changed_files.txt

          if [ "$fail" -ne 0 ]; then
            echo "Text Integrity Guard: FAILED"
            exit 1
          fi

          echo "Text Integrity Guard: OK"
name: MEP Handoff Dispatch (Manual)
on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "Target PR number (0=auto-resolve mode)."
        required: true
        default: "0"
permissions:
  contents: write
  pull-requests: write
concurrency:
  group: mep-handoff-dispatch-manual
  cancel-in-progress: false
jobs:
  handoff:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (main)
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
      - name: Prepare git identity
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
      - name: Generate HANDOFF.md (DRAFT)
        shell: bash
        run: |
          set -euo pipefail
          RUN_ID="${{ github.run_id }}"
          TS="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          PR_NUMBER="${{ inputs.pr_number }}"
          REPO="${{ github.repository }}"
          BASE_BRANCH="main"
          HEAD_SHA="$(git rev-parse HEAD)"
          PARENT_BUNDLED="docs/MEP/MEP_BUNDLE.md"
          EVIDENCE_BUNDLED="docs/MEP_SUB/EVIDENCE/MEP_BUNDLE.md"
          mkdir -p docs/MEP
          LAST_PARENT_LINE=""
          if [[ -f "$PARENT_BUNDLED" ]]; then
            LAST_PARENT_LINE="$(grep -E 'Merge pull request #[0-9]+' "$PARENT_BUNDLED" | tail -n 1 || true)"
          fi
          LAST_EVIDENCE_LINE=""
          if [[ -f "$EVIDENCE_BUNDLED" ]]; then
            LAST_EVIDENCE_LINE="$(grep -E 'Merge pull request #[0-9]+' "$EVIDENCE_BUNDLED" | tail -n 1 || true)"
          fi
          cat > docs/MEP/HANDOFF.md <<EOF
STATUS: DRAFT
source: mep_handoff_dispatch_manual.yml
generated_by: GitHub Actions
generated_at: ${TS}
# HANDOFF (DRAFT)
## Audit Anchors (best-effort)
REPO_ORIGIN
https://github.com/${REPO}.git
基準ブランチ
${BASE_BRANCH}
HEAD（${BASE_BRANCH}）
${HEAD_SHA}
PARENT_BUNDLED
${PARENT_BUNDLED}
EVIDENCE_BUNDLED
${EVIDENCE_BUNDLED}
EVIDENCE (run context)
- RUN_ID: ${RUN_ID}
- pr_number(input): ${PR_NUMBER}
Latest evidence lines (best-effort)
- parent_bundled_last_merge_line: ${LAST_PARENT_LINE}
- evidence_bundled_last_merge_line: ${LAST_EVIDENCE_LINE}
## Notes
- This is Step A: establish a manual, workflow_dispatch-capable HANDOFF generation path.
- Next steps (not executed here): health/readable/spec/extract generation and writeback, per SSOT v1.12 PART C.
EOF
      - name: Create auto PR with HANDOFF.md
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          # If no changes, exit gracefully
          if git diff --quiet -- docs/MEP/HANDOFF.md; then
            echo "No changes in HANDOFF.md; exiting."
            exit 0
          fi
          TS="$(date -u +%Y%m%d_%H%M%S)"
          AUTO_BRANCH="auto/handoff_${{ github.run_id }}_${TS}"
          git checkout -b "$AUTO_BRANCH"
          git add docs/MEP/HANDOFF.md
          git commit -m "chore(handoff): generate HANDOFF.md (DRAFT)"
          git push -u origin "$AUTO_BRANCH"
          gh pr create --base main --head "$AUTO_BRANCH" --title "chore(handoff): generate HANDOFF.md (DRAFT)" --body "Auto-generated by workflow_dispatch. This PR adds/updates docs/MEP/HANDOFF.md (STATUS: DRAFT)."
name: MEP BAT Report (Manual)

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "Pull Request number (e.g. 34)"
        required: true
        type: string

permissions:
  contents: read
  pull-requests: write

jobs:
  bat-report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve PR SHAs
        env:
        GH_TOKEN: ${{ secrets.MEP_BOT_PAT }}
        run: |
          set -e
          PR="${{ inputs.pr_number }}"
          API="/repos/${{ github.repository }}/pulls/$PR"
          BASE_SHA=$(gh api "$API" --jq .base.sha)
          HEAD_SHA=$(gh api "$API" --jq .head.sha)
          echo "BASE_SHA=$BASE_SHA" >> $GITHUB_ENV
          echo "HEAD_SHA=$HEAD_SHA" >> $GITHUB_ENV
          echo "PR_NUMBER=$PR" >> $GITHUB_ENV

      - name: Collect changed files (git diff -z)
        run: |
          set -e
          python3 tools/mep_integration_compiler/collect_changed_files.py \
            --base "$BASE_SHA" \
            --head "$HEAD_SHA" \
            --out-dir ".mep/tmp"

      - name: Upload counts artifact
        uses: actions/upload-artifact@v4
        with:
          name: mep-bat-counts
          path: .mep/tmp/counts.json

      - name: Comment counts on PR
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ inputs.pr_number }}
        with:
          script: |
            const fs = require('fs');
            const txt = fs.readFileSync('.mep/tmp/counts.json', 'utf8');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(process.env.PR_NUMBER, 10),
              body: "### MEP BAT Report (Manual)\n\n```json\n" + txt + "\n```"
            });


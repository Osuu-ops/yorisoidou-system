name: business-non-interference-guard
on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:
    inputs:
      business_declare:
        description: "true = allow business path changes for this run"
        required: false
        default: "false"
permissions:
  contents: read
jobs:
  merge_repair_pr:
    name: merge_repair_pr
    runs-on: ubuntu-latest
    steps:
      - name: no-op success
        run: echo "merge_repair_pr shim: success"
  guard:
    name: business-non-interference-guard
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history for diff)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Determine refs (PR vs dispatch)
        id: refs
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
            echo "mode=pr" >> "$GITHUB_OUTPUT"
            echo "base_ref=${{ github.base_ref }}" >> "$GITHUB_OUTPUT"
            echo "head_ref=${{ github.head_ref }}" >> "$GITHUB_OUTPUT"
          else
            echo "mode=dispatch" >> "$GITHUB_OUTPUT"
            # Dispatch compares current ref against default branch
            echo "base_ref=${{ github.event.repository.default_branch }}" >> "$GITHUB_OUTPUT"
            echo "head_ref=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          fi
      - name: Fetch base/head
        shell: bash
        run: |
          set -euo pipefail
          git fetch --no-tags --prune origin "+refs/heads/*:refs/remotes/origin/*"
      - name: Compute changed files
        id: diff
        shell: bash
        run: |
          set -euo pipefail
          BASE="origin/${{ steps.refs.outputs.base_ref }}"
          HEAD="origin/${{ steps.refs.outputs.head_ref }}"
          if ! git show-ref --verify --quiet "refs/remotes/$BASE"; then
            echo "BASE ref not found: $BASE" >&2
            exit 2
          fi
          if ! git show-ref --verify --quiet "refs/remotes/$HEAD"; then
            echo "HEAD ref not found: $HEAD" >&2
            exit 2
          fi
          git diff --name-only "${BASE}...${HEAD}" | sed '/^\s*$/d' > changed_files.txt
          echo "changed_count=$(wc -l < changed_files.txt | tr -d ' ')" >> "$GITHUB_OUTPUT"
      - name: Guard (business declare required to touch business paths)
        shell: bash
        env:
          BUSINESS_DECLARE: ${{ inputs.business_declare }}
        run: |
          set -euo pipefail
          # NOTE: declare is allowed only when explicitly set true.
          DECLARE="${BUSINESS_DECLARE:-false}"
          if [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
            # For PR, allow override via label "business-declare:true" (optional)
            # If the repo doesn't use labels, this has no effect.
            :
          fi
          # Business paths to protect
          # (adjust/add if you have additional business roots)
          PATTERNS=(
            "^platform/MEP/03_BUSINESS/"
          )
          HIT=0
          while IFS= read -r f; do
            for p in "${PATTERNS[@]}"; do
              if [[ "$f" =~ $p ]]; then
                HIT=1
                break
              fi
            done
            if [[ $HIT -eq 1 ]]; then break; fi
          done < changed_files.txt
          if [[ $HIT -eq 1 ]]; then
            if [[ "$DECLARE" != "true" ]]; then
              echo "::error::Business path change detected but BUSINESS_DECLARE=true is not set. Non-interference enforced."
              echo "Detected business-path changes (first 200 lines):"
              sed -n '1,200p' changed_files.txt
              exit 1
            fi
            echo "Business path changes detected, but BUSINESS_DECLARE=true set -> allowed for this run."
          else
            echo "No business path changes detected -> OK."
          fi
# mep-stamp: 2026-02-11T01:42:41+09:00

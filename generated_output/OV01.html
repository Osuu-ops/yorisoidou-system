<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= HtmlService.createHtmlOutputFromFile('common_ui').getContent(); ?>
</head>
<body onload="checkEnvironment(); initOV01();">
  <div class="app">
    <div class="header">
      <div class="titleWrap">
        <h1 class="title">OV01（カルテ閲覧）</h1>
        <p class="subtitle">Order の統合ビュー（健康スコア／AI違和感／写真・動画／部材／ログ）。</p>
      </div>
      <div id="scorePill" class="pill">HealthyScore: --</div>
    </div>

    <div class="card" style="margin-bottom:12px;">
      <div class="cardHeader"><h2>対象</h2></div>
      <div class="cardBody">
        <div class="row two">
          <div class="field">
            <label>OrderID</label>
            <input id="orderId" type="text" placeholder="orderPrefix-YYYYMMDD-00001-UP...">
          </div>
          <div class="field" style="align-self:end;">
            <div class="btns">
              <button class="btn primary" id="btnLoad" onclick="loadOV01();">表示</button>
            </div>
          </div>
        </div>
        <div id="warnings" class="pill danger" style="display:none; margin-top:10px;">AI違和感：--</div>
      </div>
    </div>

    <div class="grid two">
      <div class="card">
        <div class="cardHeader"><h2>基本情報</h2></div>
        <div class="cardBody">
          <div id="basic" class="notice">未読み込み</div>
        </div>
      </div>
      <div class="card">
        <div class="cardHeader"><h2>HistoryNotes</h2></div>
        <div class="cardBody">
          <div id="history" class="notice">未読み込み（Order_ID の自動リンク化はGAS側）</div>
        </div>
      </div>

      <div class="card">
        <div class="cardHeader"><h2>Before/After</h2></div>
        <div class="cardBody">
          <div class="notice">スライダー比較は仕様に定義されていますが、写真取得（Drive連携）をこの出力で推測実装しません。</div>
        </div>
      </div>
      <div class="card">
        <div class="cardHeader"><h2>部材（LOCATION含む）</h2></div>
        <div class="cardBody">
          <div id="parts" class="notice">未読み込み</div>
        </div>
      </div>

      <div class="card">
        <div class="cardHeader"><h2>ログ（logs/system）</h2></div>
        <div class="cardBody">
          <div id="logs" class="notice">未読み込み</div>
        </div>
      </div>
      <div class="card">
        <div class="cardHeader"><h2>動画（inspection）</h2></div>
        <div class="cardBody">
          <div class="notice">動画ビューアは仕様に定義されていますが、Drive連携をこの出力で推測実装しません。</div>
        </div>
      </div>
    </div>
  </div>

<script>
  function initOV01(){
    // URL ?orderId=... があれば反映（仕様外の推測にならない範囲の利便性）。
    try{
      var p = new URLSearchParams(location.search);
      var oid = p.get('orderId');
      if (oid) qs('#orderId').value = oid;
    }catch(e){}
  }

  function loadOV01(){
    var btn = qs('#btnLoad');
    showBusy(btn, true);
    var orderId = qs('#orderId').value || '';
    google.script.run
      .withSuccessHandler(function(res){
        showBusy(btn, false);
        renderOV01(res || {});
      })
      .withFailureHandler(function(err){
        showBusy(btn, false);
        alert('エラー: ' + (err && err.message ? err.message : err));
      })
      .getOV01Card({ orderId: orderId });
  }

  function renderOV01(res){
    var score = (typeof res.healthyScore === 'number') ? res.healthyScore : null;
    var pill = qs('#scorePill');
    pill.textContent = 'HealthyScore: ' + (score === null ? '--' : score);
    pill.classList.remove('danger','ok','warn');
    if (score !== null){
      if (score < 70) pill.classList.add('danger');
      else if (score < 85) pill.classList.add('warn');
      else pill.classList.add('ok');
    }

    qs('#basic').textContent = res.basicText || '（表示データなし）';
    qs('#history').textContent = res.historyNotes || '';
    qs('#parts').textContent = res.partsText || '（表示データなし）';
    qs('#logs').textContent = res.logsText || '（表示データなし）';

    var warns = res.aiWarnings && res.aiWarnings.length ? res.aiWarnings.join(' / ') : '';
    var w = qs('#warnings');
    if (warns){
      w.style.display = 'inline-flex';
      w.textContent = 'AI違和感：' + warns;
    }else{
      w.style.display = 'none';
    }
  }
</script>
</body>
</html>

name: Business Packet Guard (PR)

on:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  business_packet_guard:
    name: Business Packet Guard (PR)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Validate BUSINESS_PACKET and generated packets
        shell: bash
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          set -euo pipefail

          # pull_request 以外（workflow_dispatch等）の場合は全検査
          if [ -z "${BASE_SHA:-}" ] || [ -z "${HEAD_SHA:-}" ]; then
            echo "No BASE/HEAD; run full validation."
            python3 platform/infra/tools/packets/validate_business_packet.py
            exit 0
          fi

          # 変更が関係ない場合はスキップ（Required化しても常にCheckが出るように、成功で終了）
          changed="$(git diff --name-only "${BASE_SHA}..${HEAD_SHA}" || true)"
          if ! echo "$changed" | grep -E '^(platform/MEP/|platform/infra/tools/packets/|\.github/workflows/business_packet_)' >/dev/null; then
            echo "Business Packet Guard: skipped (no relevant changes)"
            exit 0
          fi

          python3 platform/infra/tools/packets/validate_business_packet.py
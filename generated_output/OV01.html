<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{
      --bg:#0b1020; --card:#111a33; --card2:#0f1730; --text:#e9ecf5; --muted:#a9b1cc;
      --accent:#4aa3ff; --danger:#ff5a7a; --ok:#45d483; --warn:#ffd36a; --line:rgba(255,255,255,.12);
      --radius:16px; --shadow:0 10px 25px rgba(0,0,0,.25);
      --tap:52px;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP";
    }
    body{ margin:0; background:linear-gradient(180deg,#070a14,#0b1020); color:var(--text); }
    .wrap{ max-width:1200px; margin:0 auto; padding:16px; }
    .top{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input{ flex:1; min-width:260px; border:1px solid var(--line); background:rgba(0,0,0,.15); color:var(--text); border-radius:12px; padding:12px; font-size:16px; }
    button{ border:1px solid rgba(74,163,255,.5); background:rgba(74,163,255,.20); color:var(--text); padding:12px 14px; border-radius:14px; min-height:var(--tap); font-size:15px; cursor:pointer; }
    .grid{ display:grid; gap:14px; margin-top:14px; }
    @media(min-width: 980px){ .grid{ grid-template-columns: 1fr 1fr; } }
    .card{ background:linear-gradient(180deg,var(--card),var(--card2)); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden; }
    .card h2{ margin:0; padding:14px 16px; font-size:16px; border-bottom:1px solid var(--line); }
    .body{ padding:16px; }
    .kv{ display:grid; grid-template-columns: 160px 1fr; gap:8px 12px; font-size:14px; }
    .k{ color:var(--muted); }
    .badge{ display:inline-flex; align-items:center; gap:8px; padding:10px 12px; border-radius:999px; border:1px solid var(--line); background:rgba(255,255,255,.06); }
    .badge.ok{ border-color: rgba(69,212,131,.5); background: rgba(69,212,131,.12); }
    .badge.ng{ border-color: rgba(255,90,122,.55); background: rgba(255,90,122,.12); }
    .badge.warn{ border-color: rgba(255,211,106,.55); background: rgba(255,211,106,.10); }
    .muted{ color:var(--muted); }
    .tiles{ display:grid; gap:10px; }
    @media(min-width: 720px){ .tiles{ grid-template-columns: 1fr 1fr; } }
    .tile{ border:1px solid var(--line); border-radius:14px; padding:12px; background:rgba(0,0,0,.10); }
    a{ color: var(--accent); text-decoration: none; }
    a:hover{ text-decoration: underline; }
    .imggrid{ display:grid; gap:10px; grid-template-columns: repeat(2, 1fr); }
    @media(min-width: 980px){ .imggrid{ grid-template-columns: repeat(3, 1fr);} }
    .thumb{ width:100%; aspect-ratio: 4/3; background:rgba(255,255,255,.06); border:1px solid var(--line); border-radius:14px; overflow:hidden; }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .status{ margin-top:10px; font-size:13px; color:var(--muted); }
    .danger{ color:var(--danger); }
  </style>
</head>
<body onload="checkEnvironment(); initFromUrl();">
  <div class="wrap">
    <div class="top">
      <input id="orderId" placeholder="OrderID を入力（ORD-...）">
      <button onclick="load()">表示</button>
    </div>

    <div class="status" id="status"></div>

    <div id="content" style="margin-top:14px;"></div>
  </div>

<script>
function checkEnvironment() {
  if (typeof google === "undefined" || !google.script || !google.script.run) {
    alert("このフォームは正しい方法で開かれていません。\nスプレッドシートのメニューから開いてください。");
  }
}

function setStatus(msg, cls){
  const el = document.getElementById('status');
  el.className = 'status ' + (cls||'');
  el.textContent = msg;
}

function esc(s){
  return String(s==null?'':s)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'",'&#39;');
}

function initFromUrl(){
  try{
    const p = new URLSearchParams(location.search);
    const oid = p.get('orderId');
    if(oid){ document.getElementById('orderId').value = oid; load(); }
  }catch(e){}
}

function badge(score){
  if(score>=70) return '<span class="badge ok">HealthyScore: ' + score + '</span>';
  return '<span class="badge ng">HealthyScore: ' + score + '（不備あり）</span>';
}

function renderAssets(title, files){
  if(!files || files.length===0) return '<div class="muted">' + title + '：なし</div>';
  const tiles = files.map(f => {
    const url = esc(f.url||'');
    const name = esc(f.name||'');
    return '<div class="tile"><div class="muted">' + name + '</div><a href="' + url + '" target="_blank" rel="noopener">開く</a></div>';
  }).join('');
  return '<div style="margin-top:8px;"><div class="muted">' + title + '</div><div class="tiles" style="margin-top:8px;">' + tiles + '</div></div>';
}

function renderThumbs(title, files){
  if(!files || files.length===0) return '<div class="muted">' + title + '：なし</div>';
  const grid = files.map(f => {
    const url = esc(f.url||'');
    const name = esc(f.name||'');
    // Drive直リンクの画像表示は権限/共有設定に依存。表示できない場合はリンクのみ。
    return '<a class="thumb" href="' + url + '" target="_blank" rel="noopener" title="' + name + '"><img loading="lazy" src="' + url + '"></a>';
  }).join('');
  return '<div style="margin-top:8px;"><div class="muted">' + title + '</div><div class="imggrid" style="margin-top:8px;">' + grid + '</div></div>';
}

function load(){
  const oid = document.getElementById('orderId').value.trim();
  if(!oid){ setStatus('OrderID を入力してください','danger'); return; }

  setStatus('読み込み中...');
  document.getElementById('content').innerHTML = '';

  google.script.run
    .withSuccessHandler(data => {
      setStatus('');

      const o = data.order || {};
      const cu = data.customer || {};
      const up = data.property || {};

      const parts = (data.parts||[]).map(p => {
        return '<div class="tile">'
          + '<div><b>' + esc(p['PART_ID']||'') + '</b></div>'
          + '<div class="muted">AA: ' + esc(p['AA番号']||'') + ' / 枝: ' + esc(p['PA/MA番号']||'') + ' / ' + esc(p['PART_TYPE（BP/BM）']||'') + '</div>'
          + '<div class="muted">品番: ' + esc(p['品番']||'') + ' / 数量: ' + esc(p['数量']||'') + ' / PRICE: ' + esc(p['PRICE']||'') + '</div>'
          + '<div class="muted">STATUS: ' + esc(p['STATUS（STOCK/ORDERED/DELIVERED/USED/STOCK_ORDERED）']||'') + ' / LOCATION: ' + esc(p['LOCATION（在庫位置）']||'') + '</div>'
          + '</div>';
      }).join('');

      const reasons = (data.healthyScoreReasons||[]).map(r => '<div class="muted">・' + esc(r) + '</div>').join('');

      const drive = data.drive || {};

      const html = ''
        + '<div class="grid">'
        + '  <div class="card">'
        + '    <h2>基本情報</h2>'
        + '    <div class="body">'
        + '      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">'
        +           badge(Number(data.healthyScore||0))
        + '        <span class="badge">OrderID: ' + esc(oid) + '</span>'
        + '        <span class="badge">STATUS: ' + esc(o['STATUS']||'') + '</span>'
        + '      </div>'
        + '      <div style="margin-top:12px;" class="kv">'
        + '        <div class="k">顧客名</div><div>' + esc(o['顧客名']||'') + '</div>'
        + '        <div class="k">住所</div><div>' + esc(o['addressFull']||o['住所']||'') + '</div>'
        + '        <div class="k">市+町</div><div>' + esc(o['addressCityTown']||'') + '</div>'
        + '        <div class="k">電話</div><div>' + esc(o['電話']||'') + '</div>'
        + '        <div class="k">媒体</div><div>' + esc(o['媒体コード']||'') + '</div>'
        + '        <div class="k">希望日</div><div>' + esc(o['希望日1']||'') + ' / ' + esc(o['希望日2']||'') + '</div>'
        + '        <div class="k">見積金額</div><div>' + esc(o['見積金額']||'') + '</div>'
        + '      </div>'
        + '      <div style="margin-top:12px;" class="muted">summary</div>'
        + '      <div style="margin-top:6px;">' + esc(o['summary']||'') + '</div>'
        + '      <div style="margin-top:12px;" class="muted">健康スコア 減点理由</div>'
        + '      <div style="margin-top:6px;">' + (reasons || '<div class="muted">なし</div>') + '</div>'
        + '    </div>'
        + '  </div>'

        + '  <div class="card">'
        + '    <h2>HistoryNotes</h2>'
        + '    <div class="body">'
        + '      <div>' + (data.historyNotesHtml || '<div class="muted">（空）</div>') + '</div>'
        + '    </div>'
        + '  </div>'

        + '  <div class="card">'
        + '    <h2>顧客 / 物件</h2>'
        + '    <div class="body">'
        + '      <div class="muted">CU</div>'
        + '      <div class="kv" style="margin-top:8px;">'
        + '        <div class="k">CU_ID</div><div>' + esc(o['CU_ID']||'') + '</div>'
        + '        <div class="k">顧客名</div><div>' + esc(cu['顧客名']||'') + '</div>'
        + '        <div class="k">電話1</div><div>' + esc(cu['電話1']||'') + '</div>'
        + '        <div class="k">注意事項</div><div>' + esc(cu['注意事項']||'') + '</div>'
        + '      </div>'
        + '      <div class="muted" style="margin-top:12px;">UP</div>'
        + '      <div class="kv" style="margin-top:8px;">'
        + '        <div class="k">UP_ID</div><div>' + esc(o['UP_ID']||'') + '</div>'
        + '        <div class="k">住所</div><div>' + esc(up['住所']||'') + '</div>'
        + '        <div class="k">注意事項</div><div>' + esc(up['注意事項']||'') + '</div>'
        + '      </div>'
        + '    </div>'
        + '  </div>'

        + '  <div class="card">'
        + '    <h2>部材</h2>'
        + '    <div class="body">'
        + '      <div class="tiles">' + (parts || '<div class="muted">なし</div>') + '</div>'
        + '    </div>'
        + '  </div>'

        + '  <div class="card">'
        + '    <h2>写真（before/after/parts/extra）</h2>'
        + '    <div class="body">'
        +          renderThumbs('before', (drive.photos||{}).before)
        + '      <div style="margin-top:10px;">' + renderThumbs('after', (drive.photos||{}).after) + '</div>'
        + '      <div style="margin-top:10px;">' + renderThumbs('parts', (drive.photos||{}).parts) + '</div>'
        + '      <div style="margin-top:10px;">' + renderThumbs('extra', (drive.photos||{}).extra) + '</div>'
        + '      <div class="muted" style="margin-top:10px;">Before/After スライダーは画像URLの安定化（直リンク/サムネ）確定後に実装します（仕様外推測を避けるため）。</div>'
        + '    </div>'
        + '  </div>'

        + '  <div class="card">'
        + '    <h2>動画 / ログ / docs</h2>'
        + '    <div class="body">'
        +          renderAssets('videos/inspection', (drive.videos||{}).inspection)
        + '      <div style="margin-top:10px;">' + renderAssets('logs/system（案件フォルダ）', (drive.logs||{}).system) + '</div>'
        + '      <div style="margin-top:10px;">' + renderAssets('docs', (drive.docs||{}).docs) + '</div>'
        + '    </div>'
        + '  </div>'

        + '</div>';

      document.getElementById('content').innerHTML = html;
    })
    .withFailureHandler(err => {
      setStatus('エラー：' + (err && err.message ? err.message : err), 'danger');
    })
    .getOV01Data(oid);
}
</script>
</body>
</html>

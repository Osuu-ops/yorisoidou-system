name: MEP Loop Engine
on:
  workflow_dispatch:
    inputs:
      iter:
        description: "current iteration (0..)"
        required: false
        default: "0"
      max_iter:
        description: "max iterations (hard stop). default 50"
        required: false
        default: "50"
      sleep_seconds:
        description: "throttle seconds between hops. default 5"
        required: false
        default: "5"
concurrency:
  group: mep-loop-engine
  cancel-in-progress: false
permissions:
  contents: read
  actions: write
jobs:
  zone:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: SSOT_SCAN
        shell: bash
        run: |
          set -euo pipefail
          echo "SSOT_SCAN_START"
          CANDIDATES=("MEP_SSOT_MASTER" "MEP_SSOT_MASTER.md" "docs/MEP/MEP_SSOT_MASTER" "docs/MEP/MEP_SSOT_MASTER.md" "docs/MEP/MEP_SSOT_MASTER.txt" ".mep/MEP_BOOT_SPEC.md" "docs/MEP/MEP_BOOT_SPEC.md")
          SSOT_PATH=""
          for p in "${CANDIDATES[@]}"; do [ -f "$p" ] && SSOT_PATH="$p" && break; done
          [ -z "$SSOT_PATH" ] && echo "::error::SSOT not found" && exit 1
          SSOT_HASH="$(sha256sum "$SSOT_PATH" | awk '{print $1}')"
          SSOT_VERSION="$(grep -Eo 'v[0-9]+\.[0-9]+\.[0-9]+\+[^[:space:]]+' "$SSOT_PATH" | head -n 1 || true)"
          [ -z "$SSOT_VERSION" ] && SSOT_VERSION="(unknown)"
          mkdir -p .mep
          printf "SSOT_PATH=%s\nSSOT_HASH=%s\nSSOT_VERSION=%s\nSSOT_VALID=true\n" "$SSOT_PATH" "$SSOT_HASH" "$SSOT_VERSION" > .mep/RESTART_PACKET.txt
          echo "SSOT_SCAN_OK"
      - name: Upload RESTART_PACKET
        uses: actions/upload-artifact@v4
        with:
          name: restart-packet
          path: .mep/RESTART_PACKET.txt
          if-no-files-found: error
      - name: Emit MEP_COPYPASTE_ZONE
        shell: bash
        run: |
          echo "===== MEP_COPYPASTE_ZONE BEGIN ====="
          echo "RESTART_PACKET"
          echo "RUN_STATE_CODE=RUNNING"
          echo "MODE=DISPATCH_LOOP_ENGINE"
          echo "ITER=${{ inputs.iter }}"
          echo "MAX_ITER=${{ inputs.max_iter }}"
          echo "SLEEP_SECONDS=${{ inputs.sleep_seconds }}"
          echo "REPO_ORIGIN=https://github.com/${GITHUB_REPOSITORY}"
          echo "BRANCH=${GITHUB_REF_NAME}"
          echo "HEAD_SHA=${GITHUB_SHA}"
          echo "NEXT_ACTION=DISPATCH_ENTRY"
          echo "===== MEP_COPYPASTE_ZONE END ====="
      # TODO: ここに「本体処理」を差し込む（writeback/bundle/evidence/health 等）
      # いったんは“ループが安定して回る”ことを最優先。
      - name: Throttle
        shell: bash
        run: |
          set -euo pipefail
          S="${{ inputs.sleep_seconds }}"
          if [ -z "${S}" ]; then S="5"; fi
          if [ "${S}" -gt 30 ]; then S="30"; fi
          sleep "${S}"
      - name: Dispatch Entry (bounded, fail-fast)
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          ITER="${{ inputs.iter }}"
          MAX="${{ inputs.max_iter }}"
          if [ -z "${MAX}" ]; then MAX="50"; fi
          if [ "${MAX}" -gt 200 ]; then MAX="200"; fi
          NEXT=$((ITER+1))
          if [ "${NEXT}" -gt "${MAX}" ]; then
            echo "[STOP] reached max_iter: ${MAX}"
            exit 0
          fi
          echo "[GO] dispatch Entry: iter=${NEXT}/${MAX}"
          curl --fail-with-body -sS -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            "https://api.github.com/repos/${REPO}/actions/workflows/mep_loop_entry.yml/dispatches" \
            -d "{\"ref\":\"main\",\"inputs\":{\"iter\":\"${NEXT}\",\"max_iter\":\"${MAX}\",\"sleep_seconds\":\"${{ inputs.sleep_seconds }}\"}}"

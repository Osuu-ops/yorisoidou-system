name: Status Context Bridge (PR)

on:
  workflow_dispatch:
permissions:
  contents: read
  actions: read
  statuses: write

jobs:
  bridge:
    runs-on: ubuntu-latest
    steps:
      - name: Mirror required check-runs into required status contexts
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const sha   = context.payload.pull_request ? context.payload.pull_request.head.sha : context.sha;

            const required = [
              "semantic-audit",
              "semantic-audit-business",
              "Text Integrity Guard (PR)",
              "Scope Guard (PR)",
              "Business Packet Guard (PR)",
            ];

            const sleep = (ms) => new Promise(r => setTimeout(r, ms));

            async function listCheckRuns() {
              const res = await github.rest.checks.listForRef({ owner, repo, ref: sha, per_page: 100 });
              return res.data.check_runs || [];
            }

            function pickLatestByName(checkRuns) {
              const m = new Map();
              for (const cr of checkRuns) {
                const prev = m.get(cr.name);
                if (!prev) { m.set(cr.name, cr); continue; }
                const prevTime = prev.completed_at || prev.started_at || "";
                const curTime  = cr.completed_at  || cr.started_at  || "";
                if (curTime > prevTime) m.set(cr.name, cr);
              }
              return m;
            }

            function allCompleted(byName) {
              for (const name of required) {
                const cr = byName.get(name);
                if (!cr) return false;
                if (cr.status !== "completed") return false;
              }
              return true;
            }

            // Wait for required check-runs to complete (max ~10 min)
            let byName;
            for (let i = 0; i < 60; i++) {
              const runs = await listCheckRuns();
              byName = pickLatestByName(runs);
              if (allCompleted(byName)) break;
              await sleep(10000);
            }

            // Create commit statuses that mirror check-run conclusions
            for (const name of required) {
              const cr = byName.get(name);
              let state = "pending";
              let desc  = "waiting for check-run";

              if (!cr) {
                state = "pending";
                desc  = "check-run not found yet";
              } else if (cr.status !== "completed") {
                state = "pending";
                desc  = `check-run ${cr.status}`;
              } else if (cr.conclusion === "success") {
                state = "success";
                desc  = "mirrored from check-run success";
              } else {
                state = "failure";
                desc  = `mirrored from check-run: ${cr.conclusion}`;
              }

              await github.rest.repos.createCommitStatus({
                owner, repo, sha,
                state,
                context: name,
                description: desc,
              });

              core.info(`status context '${name}' => ${state} (${desc})`);
            }


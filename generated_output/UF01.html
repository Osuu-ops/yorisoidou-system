<!doctype html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      :root{
        --bg:#0b1220;
        --panel:#111a2e;
        --card:#0f1730;
        --text:#e9eefc;
        --muted:#a9b5d6;
        --line:#24304e;
        --accent:#6aa6ff;
        --danger:#ff6a6a;
        --ok:#6affb3;
      }
      *{box-sizing:border-box;}
      body{
        margin:0;
        font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
        background: linear-gradient(180deg, var(--bg), #070b14);
        color: var(--text);
      }
      .wrap{ padding: 14px; }
      .title{
        display:flex; align-items:center; justify-content:space-between;
        gap:10px; margin-bottom: 10px;
      }
      .title h1{ font-size:16px; margin:0; font-weight:700; }
      .badge{
        font-size:12px; color: var(--muted);
        border:1px solid var(--line);
        padding:6px 10px; border-radius:999px;
        background: rgba(255,255,255,0.03);
      }
      .grid{
        display:grid;
        grid-template-columns: 1fr;
        gap: 12px;
      }
      @media (min-width: 980px){
        .grid{ grid-template-columns: 1.2fr 0.8fr; }
        .sticky{ position: sticky; top: 12px; }
      }
      .card{
        border:1px solid var(--line);
        background: rgba(17,26,46,0.55);
        backdrop-filter: blur(6px);
        border-radius: 14px;
        padding: 12px;
      }
      .card h2{
        margin:0 0 10px 0; font-size:14px;
      }
      .row{ display:grid; grid-template-columns: 1fr; gap: 10px; }
      @media (min-width: 720px){
        .row.two{ grid-template-columns: 1fr 1fr; }
      }
      label{ display:block; font-size: 12px; color: var(--muted); margin-bottom:6px; }
      textarea, input, select{
        width:100%;
        padding: 12px 12px;
        border-radius: 12px;
        border: 1px solid var(--line);
        background: rgba(15,23,48,0.9);
        color: var(--text);
        outline: none;
        font-size: 16px;
      }
      textarea{ min-height: 160px; resize: vertical; }
      .actions{ display:flex; gap:10px; flex-wrap: wrap; margin-top: 12px; }
      button{
        border:0;
        padding: 12px 14px;
        border-radius: 12px;
        font-weight: 700;
        cursor: pointer;
        font-size: 16px;
      }
      .primary{ background: var(--accent); color:#061021; }
      .ghost{ background: transparent; color: var(--text); border:1px solid var(--line); }
      .danger{ background: rgba(255,106,106,0.16); color: var(--danger); border:1px solid rgba(255,106,106,0.35); }
      .msg{
        margin-top:10px;
        font-size: 13px;
        color: var(--muted);
        border-left: 3px solid var(--line);
        padding: 8px 10px;
        background: rgba(0,0,0,0.15);
        border-radius: 10px;
        white-space: pre-wrap;
      }
      .mutedNote{ color: var(--muted); font-size: 12px; line-height: 1.5; }
      .required{ color: var(--danger); font-weight: 800; margin-left:6px; }
      .kpi{ display:flex; gap:10px; flex-wrap: wrap; }
      .kpi .pill{
        border:1px solid var(--line);
        background: rgba(255,255,255,0.03);
        padding:8px 10px;
        border-radius: 12px;
        font-size: 12px;
        color: var(--muted);
      }
    </style>
  </head>
  <body onload="checkEnvironment(); init();">
    <div class="wrap">
      <div class="title">
        <h1>UF01（受注フォーム）</h1>
        <div class="badge">レスポンシブ（PC/スマホ/タブレット）</div>
      </div>

      <div class="grid">
        <div class="card">
          <h2>入力</h2>

          <div class="row">
            <div>
              <label>raw（通知全文 or 1行メモ）<span class="required">必須</span></label>
              <textarea id="raw" placeholder="通知全文を貼り付ける／または1行メモ"></textarea>
              <div class="mutedNote">AI補助（一次解析）は今回は無効です（UI判断）。rawは必ず入力してください。</div>
            </div>
          </div>

          <div class="row two">
            <div>
              <label>顧客名</label>
              <input id="name" placeholder="例：山田 太郎">
            </div>
            <div>
              <label>電話</label>
              <input id="phone" placeholder="例：090-1234-5678">
            </div>
          </div>

          <div class="row">
            <div>
              <label>住所（addressFull）</label>
              <input id="addressFull" placeholder="例：兵庫県西宮市...">
              <div class="mutedNote">addressCityTown は GAS 専権。今回は住所解析（推測）を行わないため空で保存されます。</div>
            </div>
          </div>

          <div class="row two">
            <div>
              <label>希望日1</label>
              <input id="preferred1" placeholder="例：2025-12-25">
            </div>
            <div>
              <label>希望日2</label>
              <input id="preferred2" placeholder="例：2025-12-26">
            </div>
          </div>

          <div class="row two">
            <div>
              <label>見積金額（price）</label>
              <input id="price" placeholder="例：12000">
            </div>
            <div>
              <label>媒体コード</label>
              <select id="media">
                <option value="unknown">unknown</option>
                <option value="Kurama">Kurama（くらしのマーケット）</option>
                <option value="Mitsumore">Mitsumore（ミツモア）</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>summary（スタンプ）</label>
              <input id="summary" placeholder="例：エアコン清掃_通常_2台">
              <div class="mutedNote">summary は UF01 画面のスタンプ方式。AI要約は禁止（本仕様）。</div>
            </div>
          </div>

          <div class="actions">
            <button class="primary" onclick="submitUF01()">登録</button>
            <button class="ghost" onclick="fillFromRaw()">raw→入力補助（無効表示）</button>
            <button class="danger" onclick="closeMe()">閉じる</button>
          </div>

          <div id="msg" class="msg" style="display:none;"></div>
        </div>

        <div class="card sticky">
          <h2>確認</h2>
          <div class="kpi">
            <div class="pill">AI一次解析：無効（UI判断）</div>
            <div class="pill">ClickUp：無効（UI判断）</div>
            <div class="pill">Todoist：無効（UI判断）</div>
            <div class="pill">Geolonia：無効（UI判断）</div>
          </div>
          <div class="mutedNote" style="margin-top:10px;">
            1) raw は必須です。<br>
            2) このフォームはスプレッドシートのメニューから開いてください（環境チェック必須）。<br>
            3) メンテナンス中は更新系フォームがブロックされます。
          </div>
        </div>
      </div>
    </div>

    <script>
      // master_spec 11.x: 環境チェック（削除禁止）
      function checkEnvironment() {
        if (typeof google === "undefined" || !google.script || !google.script.run) {
          alert("このフォームは正しい方法で開かれていません。\nスプレッドシートのメニューから開いてください。");
        }
      }

      function init(){
        // no-op
      }

      function closeMe(){
        google.script.host.close();
      }

      function showMsg(text){
        var el = document.getElementById('msg');
        el.style.display = 'block';
        el.textContent = text;
      }

      // UI判断によりAI補助は無効。誤認防止のためメッセージのみ。
      function fillFromRaw(){
        showMsg('AI補助（raw→候補抽出）は今回は無効です（UI判断）。\n必要なら手入力してください。');
      }

      function submitUF01(){
        var payload = {
          raw: document.getElementById('raw').value,
          name: document.getElementById('name').value,
          phone: document.getElementById('phone').value,
          addressFull: document.getElementById('addressFull').value,
          preferred1: document.getElementById('preferred1').value,
          preferred2: document.getElementById('preferred2').value,
          price: document.getElementById('price').value,
          media: document.getElementById('media').value,
          summary: document.getElementById('summary').value
        };

        showMsg('送信中...');

        google.script.run
          .withSuccessHandler(function(res){
            if (res && res.ok) {
              showMsg('登録しました。\nOrder_ID: ' + res.orderId + '\nSheet: ' + res.sheetName + ' / row ' + res.rowNumber);
            } else {
              showMsg('登録に失敗しました。\n' + (res && res.message ? res.message : 'unknown error'));
            }
          })
          .withFailureHandler(function(err){
            showMsg('通信エラーの可能性があります。\n' + (err && err.message ? err.message : String(err)));
          })
          .onUF01Submit(payload);
      }
    </script>
  </body>
</html>

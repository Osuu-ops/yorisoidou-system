name: MEP Auto PR + Gate (GitHub-only)

on:
  workflow_dispatch:
    inputs:
      artifact_title:
        description: "Artifact title (short)"
        required: true
        type: string
      artifact_markdown:
        description: "Artifact body (markdown). This is the ONLY input content."
        required: true
        type: string
      pr_body:
        description: "PR body"
        required: true
        type: string
      merge_if_ok:
        description: "Merge automatically if Gate OK (true/false)"
        required: true
        default: "true"
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-pr-gate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main (fixed)
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git config --global core.quotepath false

      - name: Preflight (minimal acceptance)
        id: preflight
        env:
          ART_TITLE: ${{ inputs.artifact_title }}
          ART_BODY: ${{ inputs.artifact_markdown }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .mep/tmp
          TS="$(date -u +%Y%m%d-%H%M%S)"
          ART_IN=".mep/tmp/input_artifact_${TS}.md"
          {
            echo "# ${ART_TITLE}"
            echo ""
            echo "- created_at_utc: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo "- source: workflow_dispatch"
            echo ""
            printf "%s\n" "${ART_BODY}"
            echo ""
          } > "$ART_IN"

          if grep -nE '^(<{7}|={7}|>{7})' "$ART_IN" >/dev/null 2>&1; then
            echo "NG: conflict markers detected" >&2
            exit 2
          fi
          if grep -nF 'ここまで全部採用' "$ART_IN" >/dev/null 2>&1; then
            echo "NG: ambiguous bulk-adoption phrase detected" >&2
            exit 3
          fi

          echo "ts=$TS" >> "$GITHUB_OUTPUT"
          echo "artifact_in=$ART_IN" >> "$GITHUB_OUTPUT"

      - name: Create branch + commit artifact (fixed path)
        id: commit
        env:
          ART_TITLE: ${{ inputs.artifact_title }}
        shell: bash
        run: |
          set -euo pipefail
          TS="${{ steps.preflight.outputs.ts }}"
          BRANCH="auto/pr-gate-${TS}"
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"

          git checkout -b "$BRANCH"
          mkdir -p .mep/artifacts
          ART_PATH=".mep/artifacts/artifact_${TS}.md"
          cp "${{ steps.preflight.outputs.artifact_in }}" "$ART_PATH"

          git add "$ART_PATH"
          git commit -m "MEP artifact: ${ART_TITLE}"
          git push -u origin "$BRANCH"

          echo "artifact_path=$ART_PATH" >> "$GITHUB_OUTPUT"

      - name: Create PR
        id: pr
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          BRANCH="${{ steps.commit.outputs.branch }}"
          TITLE="MEP artifact: ${{ inputs.artifact_title }}"
          PR_URL=$(gh pr create --base main --head "$BRANCH" --title "$TITLE" --body "${{ inputs.pr_body }}" --repo "${{ github.repository }}")
          echo "pr_url=$PR_URL" >> "$GITHUB_OUTPUT"
          PR_NUMBER=$(echo "$PR_URL" | sed -E 's#.*/pull/([0-9]+).*#\1#')
          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"

      - name: Resolve PR SHAs
        id: shas
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          PR="${{ steps.pr.outputs.pr_number }}"
          API="/repos/${{ github.repository }}/pulls/$PR"
          BASE_SHA=$(gh api "$API" --jq .base.sha)
          HEAD_SHA=$(gh api "$API" --jq .head.sha)
          echo "base_sha=$BASE_SHA" >> "$GITHUB_OUTPUT"
          echo "head_sha=$HEAD_SHA" >> "$GITHUB_OUTPUT"

      - name: Checkout PR head (for gate)
        shell: bash
        run: |
          set -euo pipefail
          PR="${{ steps.pr.outputs.pr_number }}"
          git fetch --no-tags --prune origin "+refs/pull/${PR}/head:refs/remotes/pull/${PR}/head"
          git checkout --detach "refs/remotes/pull/${PR}/head"

      - name: Collect changed files (git diff -z)
        shell: bash
        run: |
          set -euo pipefail
          python3 tools/mep_integration_compiler/collect_changed_files.py --base "${{ steps.shas.outputs.base_sha }}" --head "${{ steps.shas.outputs.head_sha }}" --out-dir ".mep/tmp"

      - name: Run Gate (best-effort)
        id: gate
        shell: bash
        run: |
          set +e
          if [ -s ".mep/tmp/core_audit.txt" ]; then python3 tools/mep_integration_compiler/semantic_audit_core.py .mep/tmp/core_audit.txt > core_audit.log 2>&1; CORE_AUDIT_RC=$?; else CORE_AUDIT_RC=0; fi
          if [ -s ".mep/tmp/biz_audit.txt" ]; then python3 tools/mep_integration_compiler/semantic_audit_business.py .mep/tmp/biz_audit.txt > biz_audit.log 2>&1; BIZ_AUDIT_RC=$?; else BIZ_AUDIT_RC=0; fi
          if [ -s ".mep/tmp/core_binary.txt" ] && [ -f ".mep/allowlists/core.sha256" ]; then python3 tools/mep_integration_compiler/binary_guard.py .mep/tmp/core_binary.txt .mep/allowlists/core.sha256 > core_binary_guard.log 2>&1; CORE_BIN_RC=$?; else CORE_BIN_RC=0; fi
          if [ -s ".mep/tmp/biz_binary.txt" ] && [ -f ".mep/allowlists/business.sha256" ]; then python3 tools/mep_integration_compiler/binary_guard.py .mep/tmp/biz_binary.txt .mep/allowlists/business.sha256 > biz_binary_guard.log 2>&1; BIZ_BIN_RC=$?; else BIZ_BIN_RC=0; fi
          echo "core_audit_rc=$CORE_AUDIT_RC" >> "$GITHUB_OUTPUT"
          echo "biz_audit_rc=$BIZ_AUDIT_RC" >> "$GITHUB_OUTPUT"
          echo "core_bin_rc=$CORE_BIN_RC" >> "$GITHUB_OUTPUT"
          echo "biz_bin_rc=$BIZ_BIN_RC" >> "$GITHUB_OUTPUT"
          if [ "$CORE_AUDIT_RC" = "0" ] && [ "$BIZ_AUDIT_RC" = "0" ] && [ "$CORE_BIN_RC" = "0" ] && [ "$BIZ_BIN_RC" = "0" ]; then echo "result=OK" >> "$GITHUB_OUTPUT"; else echo "result=NG" >> "$GITHUB_OUTPUT"; fi
          exit 0

      - name: Comment Gate result on PR
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          PR="${{ steps.pr.outputs.pr_number }}"
          RESULT="${{ steps.gate.outputs.result }}"
          ART="${{ steps.commit.outputs.artifact_path }}"
          gh pr comment "$PR" --repo "${{ github.repository }}" --body "$(cat <<EOF
### MEP Auto PR + Gate : ${RESULT}
- artifact_path: ${ART}
- core_audit_rc: ${{ steps.gate.outputs.core_audit_rc }}
- biz_audit_rc: ${{ steps.gate.outputs.biz_audit_rc }}
- core_bin_rc: ${{ steps.gate.outputs.core_bin_rc }}
- biz_bin_rc: ${{ steps.gate.outputs.biz_bin_rc }}
EOF
)"

      - name: Merge PR if OK
        if: steps.gate.outputs.result == 'OK' && inputs.merge_if_ok == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          PR="${{ steps.pr.outputs.pr_number }}"
          gh pr merge "$PR" --merge --delete-branch --repo "${{ github.repository }}"
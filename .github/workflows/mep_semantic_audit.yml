name: MEP Semantic Audit (PR Gate)

on:
  workflow_dispatch:
permissions:
  contents: read

jobs:
  audit-core:
    name: semantic-audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Configure git (no quoted paths)
        run: git config --global core.quotepath false
      - name: Collect CORE changed files
        shell: bash
        run: |
          set -euo pipefail
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          git diff --name-only "$BASE_SHA" "$HEAD_SHA" -- platform/MEP/01_CORE | sort > core_all.txt || true
          sed -i 's/^"//; s/"$//' core_all.txt || true
          cat core_all.txt | grep -Ei '\.(md|txt|yaml|yml|json)$' | sort > core_inputs.txt || true
          git diff --name-only --diff-filter=AM "$BASE_SHA" "$HEAD_SHA" -- platform/MEP/01_CORE | sort > core_am.txt || true
          sed -i 's/^"//; s/"$//' core_am.txt || true
          cat core_am.txt | grep -Evi '\.(md|txt|yaml|yml|json)$' | sort > core_nontext.txt || true
      - name: Binary guard (CORE)
        shell: bash
        run: |
          set -euo pipefail
          if [ -s core_nontext.txt ]; then
            python tools/mep_integration_compiler/binary_guard.py core_nontext.txt .mep/allowlists/core.sha256
          else
            echo "CORE binary: SKIP"
          fi
      - name: Semantic audit (CORE)
        shell: bash
        run: |
          set -euo pipefail
          if [ -s core_inputs.txt ]; then
            python tools/mep_integration_compiler/semantic_audit_core.py core_inputs.txt
          else
            echo "CORE audit: SKIP"
          fi

  audit-business:
    name: semantic-audit-business
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Configure git (no quoted paths)
        run: git config --global core.quotepath false
      - name: Collect BUSINESS changed files (include master_spec without extension)
        shell: bash
        run: |
          set -euo pipefail
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          git diff --name-only --diff-filter=AM "$BASE_SHA" "$HEAD_SHA" -- platform/MEP/03_BUSINESS | sort > biz_all.txt || true
          sed -i 's/^"//; s/"$//' biz_all.txt || true
          cat biz_all.txt | grep -Ei '\.(md|txt|yaml|yml|json)$' | sort > biz_inputs.txt || true
          cat biz_all.txt | grep -F '/master_spec' >> biz_inputs.txt || true
          sort -u biz_inputs.txt -o biz_inputs.txt || true
          git diff --name-only --diff-filter=AM "$BASE_SHA" "$HEAD_SHA" -- platform/MEP/03_BUSINESS | sort > biz_am.txt || true
          sed -i 's/^"//; s/"$//' biz_am.txt || true
          cat biz_am.txt | grep -Evi '\.(md|txt|yaml|yml|json)$' | grep -Fv '/master_spec' | sort > biz_nontext.txt || true
      - name: Binary guard (BUSINESS)
        shell: bash
        run: |
          set -euo pipefail
          if [ -s biz_nontext.txt ]; then
            python tools/mep_integration_compiler/binary_guard.py biz_nontext.txt .mep/allowlists/business.sha256
          else
            echo "BUSINESS binary: SKIP"
          fi
      - name: Semantic audit (BUSINESS)
        shell: bash
        run: |
          set -euo pipefail
          if [ -s biz_inputs.txt ]; then
          # FILTER_MISSING_BIZ_INPUTS: remove paths that no longer exist (deleted/moved) to avoid REF_AUDIT_NG
          if [ -f biz_inputs.txt ]; then
  python - <<'PY'
          import pathlib
          p = pathlib.Path("biz_inputs.txt")
          lines = [ln.strip().strip('"') for ln in p.read_text(encoding="utf-8").splitlines() if ln.strip()]
          kept = [ln for ln in lines if pathlib.Path(ln).exists()]
          p.write_text("\n".join(kept) + ("\n" if kept else ""), encoding="utf-8")
          print(f"FILTER_MISSING_BIZ_INPUTS: {len(lines)} -> {len(kept)}")
          PY
          fi
            python tools/mep_integration_compiler/semantic_audit_business.py biz_inputs.txt
          else
            echo "BUSINESS audit: SKIP"
          fi



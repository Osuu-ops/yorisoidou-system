<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{
      --bg:#0b1020; --card:#111a33; --card2:#0f1730; --text:#e9ecf5; --muted:#a9b1cc;
      --accent:#4aa3ff; --danger:#ff5a7a; --line:rgba(255,255,255,.12);
      --radius:16px; --shadow:0 10px 25px rgba(0,0,0,.25); --tap:52px;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP";
    }
    body{ margin:0; background:linear-gradient(180deg,#070a14,#0b1020); color:var(--text); }
    .wrap{ max-width:1200px; margin:0 auto; padding:16px; }
    .top{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input{ flex:1; min-width:260px; border:1px solid var(--line); background:rgba(0,0,0,.15); color:var(--text); border-radius:12px; padding:12px; font-size:16px; }
    button{ border:1px solid rgba(74,163,255,.5); background:rgba(74,163,255,.20); color:var(--text); padding:12px 14px; border-radius:14px; min-height:var(--tap); font-size:15px; cursor:pointer; }
    .hint{ margin-top:10px; font-size:12px; color:var(--muted); line-height:1.5; }
    .grid{ margin-top:14px; display:grid; gap:10px; }
    @media(min-width: 720px){ .grid{ grid-template-columns: repeat(2, 1fr); } }
    @media(min-width: 1020px){ .grid{ grid-template-columns: repeat(4, 1fr); } }
    .tile{ border:1px solid var(--line); border-radius:16px; padding:12px; background:rgba(255,255,255,.06); }
    .title{ font-size:14px; }
    .meta{ margin-top:8px; font-size:12px; color:var(--muted); white-space:pre-wrap; }
    a{ color: var(--accent); text-decoration:none; }
    a:hover{ text-decoration:underline; }
    .status{ margin-top:10px; font-size:13px; color:var(--muted); }
    .danger{ color:var(--danger); }
  </style>
</head>
<body onload="checkEnvironment();">
  <div class="wrap">
    <div class="top">
      <input id="query" placeholder="検索語（例：西宮市 / ORD-... / 顧客名 / 部材ID など）">
      <button onclick="search()">検索</button>
    </div>

    <div class="hint">自然文検索→キーワード化（ChatGPT API）は今回無効（UI判断：外部連携OFF）。</div>
    <div class="status" id="status"></div>

    <div id="results" class="grid"></div>
  </div>

<script>
function checkEnvironment() {
  if (typeof google === "undefined" || !google.script || !google.script.run) {
    alert("このフォームは正しい方法で開かれていません。\nスプレッドシートのメニューから開いてください。");
  }
}

function setStatus(msg, cls){
  const el = document.getElementById('status');
  el.className = 'status ' + (cls||'');
  el.textContent = msg;
}

function esc(s){
  return String(s==null?'':s)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'",'&#39;');
}

function search(){
  const q = document.getElementById('query').value.trim();
  if(!q){ setStatus('検索語が空です','danger'); return; }

  setStatus('検索中...');
  document.getElementById('results').innerHTML = '';

  google.script.run
    .withSuccessHandler(res => {
      setStatus('件数：' + res.hits.length);
      const html = res.hits.map(h => {
        if(h.type === 'ORDER'){
          const oid = esc(h.orderId||'');
          return '<div class="tile">'
            + '<div class="title"><a href="?form=OV01&orderId=' + encodeURIComponent(oid) + '" target="_blank" rel="noopener">' + esc(h.title||oid) + '</a></div>'
            + '<div class="meta">' + esc(h.snippet||'') + '</div>'
            + '</div>';
        }
        return '<div class="tile">'
          + '<div class="title"><a href="' + esc(h.url||'#') + '" target="_blank" rel="noopener">' + esc(h.title||'LOG') + '</a></div>'
          + '<div class="meta">' + esc(h.snippet||'') + '</div>'
          + '</div>';
      }).join('');
      document.getElementById('results').innerHTML = html || '<div class="hint">該当なし</div>';
    })
    .withFailureHandler(err => {
      setStatus('エラー：' + (err && err.message ? err.message : err), 'danger');
    })
    .ov02Search({ query: q });
}
</script>
</body>
</html>

name: MEP Loop Engine v2 (restore step4)
"on":
  push:
    branches: [ main ]
concurrency:
  group: mep-loop-engine-v2
  cancel-in-progress: false
permissions:
  contents: read
  actions: write
jobs:
  zone:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: SSOT_SCAN (safe-min)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .mep
          SSOT="docs/MEP/MEP_SSOT_MASTER.md"
          if [ ! -f "$SSOT" ]; then
            echo "::error::SSOT not found: $SSOT"
            exit 1
          fi
          HASH="$(sha256sum "$SSOT" | awk '{print $1}')"
          VER="$(grep -Eo 'v[0-9]+\.[0-9]+\.[0-9]+\+[^[:space:]]+' "$SSOT" | head -n 1 || true)"
          if [ -z "$VER" ]; then VER="(unknown)"; fi
          {
            echo "SSOT_PATH=$SSOT"
            echo "SSOT_HASH=$HASH"
            echo "SSOT_VERSION=$VER"
            echo "SSOT_VALID=true"
          } > .mep/RESTART_PACKET.txt
          echo "SSOT_SCAN_OK"
      - name: Upload RESTART_PACKET
        uses: actions/upload-artifact@v4
        with:
          name: restart-packet
          path: .mep/RESTART_PACKET.txt
          if-no-files-found: error
      - name: Smoke
        run: echo "ENGINE_V2_STEP4_OK"
name: MEP Issue LLM to PR (Dispatch Entry)
on:
  workflow_dispatch:
    inputs:
      body:
        description: "Simulated issue_comment body"
        required: true
        type: string
permissions:
  contents: write
  pull-requests: write
  issues: write
concurrency:
  group: mep-llm-dispatch-entry-${{ github.run_id }}
  cancel-in-progress: false
jobs:
  llm_to_pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Resolve body (workflow_dispatch)
        id: body
        uses: actions/github-script@v7
        with:
          script: |
            const body = (context.payload.inputs && context.payload.inputs.body) ? context.payload.inputs.body : "";
            if (!body) { core.setFailed("BODY_EMPTY"); return; }
            core.setOutput("body", body);
      - name: Extract draft (DRAFT_START/END)
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const body = `${{ steps.body.outputs.body }}`;
            const m = body.match(/DRAFT_START\s*\n([\s\S]*?)\nDRAFT_END\s*/i);
            const draft = (m && m[1]) ? m[1].trim() : "";
            if (!draft) { core.setFailed("DRAFT_EMPTY: include DRAFT_START..DRAFT_END"); return; }
            core.setOutput("draft_b64", Buffer.from(draft, "utf8").toString("base64"));
      - name: Generate patch via OpenAI (one call)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
          DRAFT_B64: ${{ steps.extract.outputs.draft_b64 }}
        run: |
          set -euo pipefail
          [ -n "${OPENAI_API_KEY:-}" ] || (echo OPENAI_API_KEY_MISSING && exit 1)
          MODEL="${OPENAI_MODEL:-gpt-4.1}"
          DRAFT="$(echo "$DRAFT_B64" | base64 -d)"
          PROMPT="You generate a minimal unified diff patch for this repository.
Rules:
- Output ONLY unified diff. No prose.
- No binary diffs.
- No delete/rename/move/chmod.
- Prefer small, safe changes.
- Touch only: mep/**, docs/MEP/**, .github/workflows/**, tools/runner/**, README.md
Draft:"
          BODY=$(jq -n --arg model "$MODEL" --arg input "$PROMPT\n$DRAFT" '{model:$model,input:$input,max_output_tokens:3500}')
          curl -sS https://api.openai.com/v1/responses \
            -H "Authorization: Bearer ${OPENAI_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "$BODY" \
            | jq -r '.output_text' > /tmp/mep.patch
          test -s /tmp/mep.patch
      - name: Guard (no binary / no delete-rename-move-chmod)
        run: |
          set -euo pipefail
          if grep -nE 'GIT binary patch|^Binary files ' /tmp/mep.patch >/dev/null; then echo "STOP_HARD: BINARY_DIFF_FORBIDDEN"; exit 1; fi
          if grep -nE '^deleted file mode|^rename from|^rename to|^old mode|^new mode' /tmp/mep.patch >/dev/null; then echo "STOP_HARD: DANGEROUS_DIFF_FORBIDDEN"; exit 1; fi

      - name: Load P4 thresholds (SSOT -> GITHUB_ENV)
  shell: bash
  run: |
    set -euo pipefail
    bash tools/runner/p4_thresholds_load.sh --github-env "$GITHUB_ENV" docs/MEP/P4_THRESHOLDS_SSOT.md- name: Guard (scope/size/keywords)
        run: |
          set -euo pipefail
          PATCH=/tmp/mep.patch
          test -s "$PATCH"
          # ---- size limits (anti-runaway) ----
          max_bytes=$P4_MAX_BYTES
          bytes=$(wc -c < "$PATCH" | tr -d ' ')
          if [ "$bytes" -gt "$max_bytes" ]; then
            echo "STOP_HARD: PATCH_TOO_LARGE bytes=$bytes max=$max_bytes"
            exit 1
          fi
          max_files=$P4_MAX_FILES
          files=$(grep -E '^diff --git ' "$PATCH" | wc -l | tr -d ' ')
          if [ "$files" -gt "$max_files" ]; then
            echo "STOP_HARD: TOO_MANY_FILES files=$files max=$max_files"
            exit 1
          fi
          max_added=$P4_MAX_ADDED
          added=$(grep -E '^\+' "$PATCH" | grep -vE '^\+\+\+' | wc -l | tr -d ' ')
          if [ "$added" -gt "$max_added" ]; then
            echo "STOP_HARD: TOO_MANY_ADDED_LINES added=$added max=$max_added"
            exit 1
          fi
          # ---- allowed path fence (deny by default) ----
          # Allowed: mep/**, docs/MEP/**, .github/workflows/**, tools/runner/**, README.md
          bad=$(grep -E '^diff --git ' "$PATCH" | sed -E 's/^diff --git a\/([^ ]+) b\/.*/\1/' | \
            grep -vE '^(mep/|docs/MEP/|\.github/workflows/|tools/runner/|README\.md$)' || true)
          if [ -n "$bad" ]; then
            echo "STOP_HARD: SCOPE_VIOLATION (disallowed paths)"
            echo "$bad"
            exit 1
          fi
          # ---- keyword fence (very conservative) ----
          if grep -nE 'secrets\.|OPENAI_API_KEY|Authorization:\s*Bearer|curl\s+.*\|\s*sh' "$PATCH" >/dev/null; then
            echo "STOP_HARD: DANGEROUS_KEYWORD_DETECTED"
            grep -nE 'secrets\.|OPENAI_API_KEY|Authorization:\s*Bearer|curl\s+.*\|\s*sh' "$PATCH" | head -n 50
            exit 1
          fi
      - name: Apply patch (check then apply)
        run: |
          set -euo pipefail
          git apply --check /tmp/mep.patch
          git apply /tmp/mep.patch
      - name: Create PR
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          title: "MEP: apply (Dispatch Entry) run ${{ github.run_id }}"
          body: |
            Applied by MEP Dispatch Entry workflow.
            - Event: ${{ github.event_name }}
            - Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          commit-message: "mep: apply (Dispatch Entry) run ${{ github.run_id }}"
          branch: "auto/mep_dispatch_entry_${{ github.run_id }}"
          base: "main"
          delete-branch: true
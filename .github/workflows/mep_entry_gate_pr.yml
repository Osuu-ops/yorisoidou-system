name: ENTRY_GATE
on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
permissions:
  contents: read
  pull-requests: write
jobs:
  gate:
    name: ENTRY_GATE / gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: SSOT_SCAN + CONFLICT_SCAN (ENTRY)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = 'Stop'
          function Fail([string]$code, [string]$msg) {
            Write-Host "::error title=$code::$msg"
            exit 1
          }
          # SSOT_SCAN (must exist)
          $ssot = 'docs/MEP/MEP_SSOT_MASTER.md'
          if (-not (Test-Path -LiteralPath $ssot)) {
            Fail 'WB0001' ("SSOT_SCAN failed: SSOT not found (" + $ssot + ").")
          }
          # CONFLICT_SCAN (SSOT-scope only)
          # Execution candidates must be encoded in SSOT. Repo-wide token presence is NOT a conflict.
          $c = Get-Content -LiteralPath $ssot -Raw -ErrorAction SilentlyContinue
          if (-not $c) { Fail 'WB0001' ("SSOT_SCAN failed: cannot read SSOT (" + $ssot + ").") }
          $oldHit = ($c -match 'WORK_ID|WIP-')
          $newHit = ($c -match 'WORK_ITEMS|SSOT_SCAN|CONFLICT_SCAN')
          if ($oldHit -and $newHit) {
            Fail 'WB0001' "CONFLICT_SCAN failed (SSOT-scope): old+new execution candidates detected in SSOT."
          }
          Write-Host "ENTRY OK"

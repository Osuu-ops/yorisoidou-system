# 承認・エラー・実行フロー運用仕様書（改訂版：推奨反映済み）
## 1. 目的
本仕様書は、PowerShell を用いた自動化・監査運用において、**承認（0）**・**エラー停止**・**実行フロー**の意味と役割を明確化し、  
人間介入の最小化、誤通過の防止、再現性の確保を目的とする。
---
## 2. 用語定義
### 2.1 承認（0）
* **意味**：承知・受領確認
* **性質**：制御ではない／例外許可ではない／次工程開始の合図ではない
* **対象**：一次根拠に基づき「確定」した成果物のみ
* **無効条件**：完了ゲートの確認文が提示されていない状態で送られた `0` は、承認として扱わない（入力ノイズとして扱う）
### 2.2 エラー
* 実行・検証・監査のいずれかで発生した失敗状態
* 発生時点で処理は停止し、人間による修正が必要
#### 2.2.1 エラー分類（最小分類）
1. **環境エラー**：権限不足、ツール不足、ネットワーク、実行環境差、依存関係未満  
2. **仕様違反エラー**：Read-Host / Pause / プレースホルダ / 1ブロック破り / 手入力要求 等  
3. **監査不整合エラー**：一次根拠不足、Bundled / EVIDENCE 不一致、確定条件未達、証跡欠落 等  
※分類の目的は「停止後に人間が直す場所」を迷わせないこと。
### 2.3 一次根拠
* Bundled / EVIDENCE に記録された確定証跡
* 会話文脈・説明・推測・ローカル状態の断言は含めない
### 2.4 成果物（確定成果物）
成果物とは、以下をすべて満たすものを指す：
* Bundled / EVIDENCE に **証跡行（PR / commit / BUNDLE_VERSION 等）が存在**する
* 監査ルールに照らして **確定条件を満たす**
* エラーが存在しない（仕様違反／監査不整合／環境未満が残っていない）
※会話上の説明、作業メモ、提案、途中経過、ローカルの状態説明は成果物に含めない。
### 2.5 完了ゲート（Completed Gate）
* 成果物として確定可能かを最終判定する地点
* この地点でのみ承認（0）を扱う
---
## 3. 基本原則
1. **エラーが出た時点で処理は必ず停止する**
2. **承認（0）によってエラーを通過させない**
3. **承認（0）は制御フローを変えない**
4. **人間に Enter を押させる運用は行わない**
5. **実行は PowerShell のみ、1ブロック完結を原則とする**
6. **同じ状態での再実行（無変更リトライ）を禁止する**（原因修正が完了するまで）
---
## 4. 承認（0）の位置づけ
### 4.1 承認が必要な唯一の箇所
**完了ゲート（Completed Gate）**
#### 条件（承認要求の前提）
* 一次根拠（Bundled / EVIDENCE）が提示されている
* エラーが存在しない
* 成果物（確定成果物）の定義を満たしている
#### 確認文（固定）
> 「これを成果物として確定してよいか？」
#### 応答
* `0` = 承知（受領確認）
#### 注意（誤用防止）
* `0` は「GO」ではない  
* `0` は「例外許可」ではない  
* `0` は「エラー無視」ではない  
* `0` は「次工程開始」ではない  
### 4.2 承認を行わない箇所
以下では承認（0）を要求しない：
* エラー発生時（全分類）
* 未確定の作業メモ
* 設計案・方針案・提案
* 途中経過・調査結果
* 一次根拠が提示できない状態
理由：
* 承認しても処理は進まない
* 承認の意味（受領確認）が成立しない
* 誤って「0＝通過」と誤解されるため
---
## 5. エラー時の挙動仕様
### 5.1 エラー発生時（共通）
* 処理は即時停止
* 承認（0）を要求しない
* エラー分類（環境／仕様違反／監査不整合）を確定し、修正先を明示する
* 原因修正が終わるまで（状態が変わるまで）**同一内容の再実行を禁止**する
### 5.2 エラーと承認の関係
* エラー状態では承認は **無意味**
* 承認によってエラーを通過させる設計は禁止
* 「0を送ったから続行する」は禁止
---
## 6. 停止→再開（復帰）仕様
### 6.1 停止の定義
エラーが発生した時点で **処理は停止状態**となり、以降は「修正が完了し、再実行条件が満たされるまで」進行しない。
### 6.2 再開（復帰）条件
再開してよい条件は以下をすべて満たすこと：
1. **原因修正が完了している**（差分が存在する／状態が変わっている）  
2. **影響範囲が特定されている**（何を再実行するかが確定している）  
3. **再実行は PowerShell 1ブロックで完結する**（途中入力なし／Enter要求なし）  
※この復帰に承認（0）は不要。承認は完了ゲートのみ。
---
## 7. 実行フロー仕様（PowerShell）
### 7.1 実行原則
* PowerShell のみ使用
* 1ブロック・一括コピペ実行
* プレースホルダ禁止
* **入力・依存関係（前提）・実行・証跡（出力）まで含めて1ブロック内で完結**させる
### 7.2 禁止事項
* `Read-Host`
* `Pause`
* Enter 押下を要求する設計
* `>>`（継続プロンプト）を前提とした運用
* 途中で人間判断を挟む前提の分岐（if選択や手入力誘導）
### 7.3 エラー通知（画面出力）
* エラー内容は明確に出力する（短く、原因が特定できる形）
* 終了コード（0/非0）は機械判定用とする
* 終了コードを「表示」する設計は行わない（画面ログ汚染を避ける）
---
## 8. 証跡（ログ）出力の最低要件
### 8.1 目的
再現性・監査性・機械抽出性を維持しつつ、画面出力を過剰にしない。
### 8.2 最低限の出力（機械抽出可能）
実行ブロックは、以下を必ず出力できる形式を持つ（画面またはログファイル）：
* 実行対象（例：repo / branch / workflow 等）
* 基準点（例：BUNDLE_VERSION または commit）
* 実行内容（操作名）
* 結果要約（成功／失敗）
  * 失敗時はエラー分類（環境／仕様違反／監査不整合）と原因キーを含める
### 8.3 出力方針
* 画面出力は最小（要点のみ）
* 詳細ログはファイルへ（必要時に参照できる）
* 画面に長文ログを垂れ流さない（ターミナル洪水を避ける）
---
## 9. 運用上の結論
* 承認（0）は **1回で十分**
* その1回は **成果物確定（完了ゲート）時のみ**
* エラー時は承認という概念を出さない
* 承認は通過許可ではなく、確定事実の受領確認
* 停止→再開は **復帰条件を満たした場合のみ**行う（無変更リトライは禁止）
---
## 10. 本仕様の効力
本仕様は、以後の PowerShell 実行・監査・引継ぎ・成果物確定における  
**承認・エラー・進行制御の唯一の基準**として扱う。
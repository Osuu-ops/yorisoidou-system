name: Text Integrity Guard (Manual)
on:
  workflow_dispatch:
    inputs:
      base:
        description: "Base SHA (optional; default HEAD^)"
        required: false
      head:
        description: "Head SHA (optional; default HEAD)"
        required: false

permissions:
  contents: read

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute base/head
        id: revs
        shell: bash
        run: |
          set -euo pipefail
          HEAD_IN="${{ inputs.head }}"
          BASE_IN="${{ inputs.base }}"

          if [ -n "$HEAD_IN" ]; then
            HEAD="$HEAD_IN"
          else
            HEAD="$(git rev-parse HEAD)"
          fi

          if [ -n "$BASE_IN" ]; then
            BASE="$BASE_IN"
          else
            BASE="$(git rev-parse "${HEAD}^" 2>/dev/null || true)"
          fi

          echo "base=$BASE" >> "$GITHUB_OUTPUT"
          echo "head=$HEAD" >> "$GITHUB_OUTPUT"
          echo "BASE=$BASE"
          echo "HEAD=$HEAD"

      - name: Detect changed files
        shell: bash
        run: |
          set -euo pipefail
          BASE="${{ steps.revs.outputs.base }}"
          HEAD="${{ steps.revs.outputs.head }}"
          if [ -z "$BASE" ]; then
            : > changed_files.txt
            exit 0
          fi
          git diff --name-only "$BASE...$HEAD" > changed_files.txt
          cat changed_files.txt || true

      - name: Validate text integrity + sensitive diff tripwire
        shell: bash
        run: |
          set -euo pipefail
          BASE="${{ steps.revs.outputs.base }}"
          HEAD="${{ steps.revs.outputs.head }}"
          fail=0

          while IFS= read -r f; do
            [ -z "$f" ] && continue
            [ ! -f "$f" ] && continue

            bn="$(basename "$f")"
            is_sensitive=0
            if [ "$bn" = "master_spec" ] || [ "$bn" = "ui_spec.md" ]; then
              is_sensitive=1
            fi

            if [[ "$f" == *.md ]] || [ "$is_sensitive" -eq 1 ]; then
              if python3 - <<'PY' "$f"
import sys
b=open(sys.argv[1],'rb').read()
raise SystemExit(1 if b.find(b'\r')!=-1 else 0)
PY
              then :; else
                echo "NG: CRLF/CR detected in $f"
                fail=1
              fi

              python3 - <<'PY' "$f" || (echo "NG: invalid UTF-8 in $f"; exit 1)
import sys
open(sys.argv[1],'rb').read().decode('utf-8')
PY

              if ! python3 - <<'PY' "$f"
import sys
b=open(sys.argv[1],'rb').read()
raise SystemExit(1 if len(b)>0 and b[-1:]!=b'\n' else 0)
PY
              then
                echo "NG: missing final newline in $f"
                fail=1
              fi
            fi

            if [ "$is_sensitive" -eq 1 ] && [ -n "$BASE" ]; then
              numstat=$(git diff --numstat "$BASE...$HEAD" -- "$f" | awk '{print $1" "$2}')
              ins=$(echo "$numstat" | awk '{print $1}')
              del=$(echo "$numstat" | awk '{print $2}')
              ins=${ins:-0}; del=${del:-0}
              total=$((ins+del))
              echo "SENSITIVE_DIFF $f: +$ins -$del (total=$total)"
              if [ "$total" -gt 200 ]; then
                echo "NG: large diff detected on sensitive file ($f). total=$total > 200"
                fail=1
              fi
            fi
          done < changed_files.txt

          if [ "$fail" -ne 0 ]; then
            echo "Text Integrity Guard: FAILED"
            exit 1
          fi

          echo "Text Integrity Guard: OK"
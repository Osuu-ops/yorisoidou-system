name: CI_GUARD

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  guard:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect forbidden changes (Canon / Protocol / README / Master)
        run: |
          set -e

          BASE_REF="${{ github.event.pull_request.base.ref }}"
          HEAD_REF="${{ github.event.pull_request.head.ref }}"

          git fetch origin "$BASE_REF"
          git fetch origin "$HEAD_REF"

          CHANGED_FILES=$(git diff --name-only "origin/$BASE_REF...origin/$HEAD_REF")

          echo "Changed files:"
          echo "$CHANGED_FILES"

          FORBIDDEN_REGEX='^platform/MEP/MEP_business/master_spec$|\
^platform/MEP/MEP_business/ui_spec.md$|\
^platform/MEP/MEP_core/definitions/|\
^platform/MEP/MEP_core/foundation/|\
^platform/MEP/MEP_core/protocol/|\
^platform/uiux/'

          for file in $CHANGED_FILES; do
            if echo "$file" | grep -Eq "$FORBIDDEN_REGEX"; then
              echo "CI_GUARD BLOCKED: forbidden change detected"
              echo "File: $file"
              echo "Only diff-based workflow is allowed for Canon / Protocol / README / Master"
              exit 1
            fi
          done

          echo "CI_GUARD PASSED"

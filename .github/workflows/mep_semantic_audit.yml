name: MEP Semantic Audit

on:
  pull_request:
    paths:
      - "platform/MEP/01_CORE/**/*.md"
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  audit:
    name: semantic-audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Collect changed CORE markdown files (diff only)
        id: collect
        shell: bash
        run: |
          set -euo pipefail

          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          git diff --name-only "$BASE_SHA" "$HEAD_SHA" -- platform/MEP/01_CORE \
            | grep -E '\.md$' \
            | sort > inputs.txt || true

          COUNT="$(wc -l < inputs.txt | tr -d ' ')"
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"

          echo "Changed markdown inputs: $COUNT"
          cat inputs.txt || true

      - name: Skip if no target files
        if: steps.collect.outputs.count == '0'
        run: |
          echo "No target markdown changes. Skipping audit." | tee audit.log
          echo "## MEP Semantic Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Result: SKIP (no target changes)" >> $GITHUB_STEP_SUMMARY

      - name: Run Semantic Audit
        if: steps.collect.outputs.count != '0'
        shell: bash
        run: |
          set -euo pipefail
          python tools/mep_integration_compiler/semantic_audit.py inputs.txt > audit.log

      - name: Write job summary
        if: always()
        shell: bash
        run: |
          RESULT="OK"
          if [ "${{ steps.collect.outputs.count }}" = "0" ]; then
            RESULT="SKIP"
          else
            if [ "${{ job.status }}" != "success" ]; then
              RESULT="NG"
            fi
          fi

          echo "## MEP Semantic Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Result: **${RESULT}**" >> $GITHUB_STEP_SUMMARY
          echo "- Target files: ${{ steps.collect.outputs.count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>audit.log</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -n 400 audit.log >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY

      - name: Post (or update) PR comment with audit result
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const marker = '<!-- MEP_SEMANTIC_AUDIT_COMMENT -->';
            const inputsCount = Number('${{ steps.collect.outputs.count }}');
            const jobStatus = '${{ job.status }}';
            const result = (inputsCount === 0) ? 'SKIP' : (jobStatus === 'success' ? 'OK' : 'NG');

            let logText = '';
            try { logText = fs.readFileSync('audit.log', 'utf8'); }
            catch (e) { logText = '(audit.log not found)'; }

            const MAX = 6000;
            if (logText.length > MAX) logText = '...(truncated)...\n' + logText.slice(logText.length - MAX);

            const body = [
              marker,
              `### MEP Semantic Audit: ${result}`,
              '',
              `- Target files: **${inputsCount}**`,
              `- Workflow: \`${context.workflow}\` / Job: \`${context.job}\``,
              '',
              '<details><summary>audit.log</summary>',
              '',
              '```',
              logText,
              '```',
              '',
              '</details>',
            ].join('\n');

            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner, repo, issue_number, per_page: 100,
            });

            const existing = comments.find(c => typeof c.body === 'string' && c.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({ owner, repo, comment_id: existing.id, body });
            } else {
              await github.rest.issues.createComment({ owner, repo, issue_number, body });
            }

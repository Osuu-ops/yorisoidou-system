name: writeback-required-checks
on:
  push:
    branches:
      - 'auto/writeback-bundle_*'
  workflow_dispatch: {}
permissions:
  contents: read
jobs:
  scope_guard:
    name: Scope Guard (PR)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Only allow bundle file change
        shell: bash
        run: |
          set -euo pipefail
                    # WRITEBACK_PR_DIFF_MARKER
          # (base/head removed; use refs/remotes/origin/main...HEAD)
          git fetch origin +refs/heads/main:refs/remotes/origin/main --prune || true # WRITEBACK_REFSPEC_MAIN_MARKER
          files="$(git diff --name-only refs/remotes/origin/main...HEAD || true)"
          echo "$files"
          bad="$(echo "$files" | awk 'NF' | grep -Ev '^(docs/MEP/MEP_BUNDLE\.md|docs/MEP/runbook/\.noop_writeback_pr.*)$' || true)" # ALLOW_NOOP_WRITEBACK_MARKER
          if [ -n "$bad" ]; then
            echo "[NG] unexpected changed files:"
            echo "$bad"
            echo "::error title=ScopeGuard::unexpected changed files"
            echo "::error ::$bad" # WRITEBACK_SCOPE_GUARD_ERROR_MARKER
            exit 1
          fi
          echo "[OK] only bundle file changed"
  non_interference:
    name: business-non-interference-guard
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Ensure no business paths touched
        shell: bash
        run: |
          set -euo pipefail
                    # WRITEBACK_PR_DIFF_MARKER
          # (base/head removed; use refs/remotes/origin/main...HEAD)
          git fetch origin +refs/heads/main:refs/remotes/origin/main --prune || true # WRITEBACK_REFSPEC_MAIN_MARKER
          files="$(git diff --name-only refs/remotes/origin/main...HEAD || true)"
          bad="$(echo "$files" | awk 'NF' | grep -E '^(platform/MEP/03_BUSINESS/|business/|03_BUSINESS/)' || true)"
          if [ -n "$bad" ]; then
            echo "[NG] business paths changed:"
            echo "$bad"
            echo "::error title=ScopeGuard::unexpected changed files"
            echo "::error ::$bad" # WRITEBACK_SCOPE_GUARD_ERROR_MARKER
            exit 1
          fi
          echo "[OK] no business paths changed"

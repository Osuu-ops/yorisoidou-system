name: MEP Issue LLM to PR (LLMã€€v2)


on:
  issue_comment:
    types: [created, edited]
  workflow_dispatch:
    inputs:
      body:
        description: "Simulated comment body"
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: mep-issue-llm-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  llm_to_pr:
    if: github.event_name == 'workflow_dispatch' || (contains(github.event.comment.body, '/mep run') && contains(github.event.comment.body, 'MODE: LLM'))
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract draft
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const body =
              (context.payload.comment && context.payload.comment.body)
              ? context.payload.comment.body
              : (context.payload.inputs && context.payload.inputs.body)
              ? context.payload.inputs.body
              : "";

            const m = body.match(/DRAFT_START\s*\n([\s\S]*?)\nDRAFT_END\s*/i);
            const draft = (m && m[1]) ? m[1].trim() : "";

            if (!draft) {
              core.setFailed("DRAFT_EMPTY: include DRAFT_START..DRAFT_END");
              return;
            }

            core.setOutput("draft_b64", Buffer.from(draft, "utf8").toString("base64"));

★ master_spec（唯一の正・完全版）

【AIへの指示】
ChatGPT は、この master_spec を唯一の正として扱い、
ここに記載のない推測・旧バージョン参照・独自解釈を禁止する。
本文が常に最新版であり、バージョン番号の記載は行わない。
差分更新は必ず Aチャット運用ルールに従って適用する。

──────────────────────────────────
0. 概要・コンセプト
──────────────────────────────────

本章は v6.9R の全文構造を維持しつつ、
v7.0R_diff に示されたシステム原則（0.x）追記、
タスク中心の考え方の読み替え、
v7.1R_diff・v7.2R_diff、
さらに v7.3R_diff、v7.4R_diff、v7.5R_diff と
Aチャット運用ルールを完全統合した最新の master_spec の 0章である。

本システムは以下の最新コンセプトを含む：

● 閲覧フォーム OV01 の大幅強化（カルテ化）
● 全文検索フォーム OV02 の正式採用（IDフォルダ全文検索）
● Before/After 写真スライダー比較（PC/スマホ/タブレット最適化）
● 写真・動画分類（before/after/parts/extra/videos/inspection）
● HistoryNotes（履歴メモ）と OrderID 自動リンク
● 廃番 → 新番 対応辞書（discontinued / replacement）
● 在庫ロケーション管理（LOCATION 列）
● AI違和感検知（判断禁止／警告のみ）
● ClickUp へのシステム警告通知（遅延・異常・不足）
● 在庫確認トリガー
● 更新トリガー（再同期／冪等）
● maintenanceMode（メンテナンスモード）
● 全アクション logs/system 記録
● アーカイブデータも検索対象（蓄積型維持）

★ v7.5R 強化点（あなたの全採用指示を正式反映）
────────────────────────
● Runtime監査（expected effect／unexpected effect）の正式採用  
● C の test-framework（RuntimeSelfTest）導入  
● S→Apps Script 同期ルール（コード貼替一元化）  
● HTML フォームの完全多端末対応（PC／スマホ／タブレット）  
● ChatGPT API／ClickUp／Todoist／GAS の四層連携を正式仕様化  
● 自動巻き戻し（rollback）思想の採用  
● self-diff（AI内部検知）思想の採用  
● UI 品質劣化禁止ルール  
● OV01/OV02 の再設計（高品質UI）  
● タスク構造の三階層モデル（現場 Todoist／管理 ClickUp／AI補助）復活  
● natural query（自然文検索）補助  
● AI ペアレビュー（D 補助）  
● script error logging（UI JSエラー logs/system 保存）  
────────────────────────

AI の役割は素材抽出と監査のみ。
業務ロジックの唯一の決定者は GAS である。

──────────────────────────────────
0.1 システム名
──────────────────────────────────

システム名：よりそい堂 業務自動化システム


──────────────────────────────────
0.2 対象フロー（End-to-End）
──────────────────────────────────

本システムは以下の一連フローを
誤りゼロ／再入力ゼロ／迷いゼロ で完結させる自動化基盤である。

受注（UF01：通知コピペ or 1行メモ）
顧客登録（CU_Master）
物件登録（UP_Master）
Order 発行（Order_ID）
Todoist タスク生成（現場タスク）
ClickUp 管理タスク生成（管理・配分・監督）
部材発注・再利用・納品（UF06 / Parts_Master）
AA番号の抽出とタスク名反映
納品登録 → BP価格確定（UF06 / UF07）
作業実施
Todoist 完了 → USED 化／Expense計上／未使用部材の STOCK 戻し
ClickUp への管理警告・進行通知
書類リクエスト（DOC）
修正申請（FIX）
追加報告（UF08）
閲覧（OV01 カルテビュー）
全文検索（OV02）


──────────────────────────────────
0.x システム基本方針（統合）
──────────────────────────────────

0.x-1 Google スプレッドシートを全データの「唯一の正」とする。

0.x-2 業務ロジックの最終決定者はすべて GAS。
AI は決定値を上書きしてはならない。

0.x-3（v7.1R）
コメント操作は
「トリガー → モード固定 → 入力待ち → 手動キャンセル or 1時間自動キャンセル」
の4段階。
モード外発言には反応せず、誤発動しない。

0.x-4（v7.1R）
AI 自動学習は禁止。
AI は「素材抽出」「監査」以外の判断を行わない。

0.x-5（v7.3R）
maintenanceMode 中は GAS の検査と閲覧系のみ許可し、
更新処理はすべて停止。
logs/system への記録のみ継続。

0.x-6（v7.5R：新設）
システムは **三階層タスクモデル** を持つものと定義する：

● 第一階層：Todoist（現場 UI、完了報告の唯一の正）
● 第二階層：ClickUp（管理・監督 UI、遅延検知と優先度管理）
● 第三階層：ChatGPT API（AI補助層、素材抽出・解析・警告・自然文検索・ペアレビュー）
● GAS（スプレッドシート）はロジックの唯一の正

これらの階層は相互干渉せず、GAS の決定が常に最上位。

0.x-7（v7.5R：新設）
フォーム UI（UF01〜UF08、FIX、DOC、OV01、OV02）は
**PC／スマホ／タブレットの全端末で最適に動作するレスポンシブ構造**
でなければならない。
業務負荷を増やす UI 劣化はすべて禁止する。


──────────────────────────────────
★ master_spec（唯一の正・完全版）
ここより下はすべて、この仕様書が唯一の正として扱われる。
──────────────────────────────────


──────────────────────────────────
CONFIG 構造（統合）
──────────────────────────────────

本章は v6.9R と v7.0R の CONFIG 構造に、  
v7.1R_diff の権限体系・コメントモード、  
v7.2R_diff のブランド拡張、  
v7.3R_diff の LOCATION／履歴構造、  
v7.4R_diff の Runtime監査基盤、  
v7.5R_diff の UI最適化／ClickUp連携／AI補助強化 を完全統合したもの。


────────────────────────
1.1 基本項目
────────────────────────

systemName: "業務自動化システム"
systemVersion: この master_spec と同期
timezone: "Asia/Tokyo"
defaultYear: 年度
fiscalYear: 年度
fiscalStart: "MM-DD"


────────────────────────
1.2 ブランド設定
────────────────────────

activeBrand: ''

brandProfiles:
（※ v6.9R〜v7.3R の構造を完全継承）

ids: activeBrand.ids を反映
sheets: activeBrand.sheets を反映

applyActiveBrand() により CONF() 経由で利用される。


────────────────────────
1.3 フォーム設定（統合）
────────────────────────

forms:
  UF01（受注フォーム）
  UF06（発注／納品フォーム）
  UF07（価格入力フォーム）
  UF08（追加報告フォーム）
  FIX（修正フォーム）
  DOC（書類フォーム）
  OV01（閲覧フォーム）
  OV02（全文検索フォーム）

※ v7.5R にてフォーム UI は全端末対応（PC／スマホ／タブレット）として再設計される。


────────────────────────
1.x maintenanceMode（統合）
────────────────────────

maintenanceMode: true/false

true の場合：
・UF01 / UF06 / UF07 / UF08 の実行禁止
・Todoist 完了 webhook 停止
・ClickUp 更新禁止
・スプレッドシート更新禁止
・閲覧（OV01/OV02）のみ許可
・rebuildTest（整合性検査）最優先
・logs/system にブロック内容を記録

操作者：config-admin-primary のみ。


────────────────────────
1.x 権限ロール構造（統合）
────────────────────────

guest  
viewer（v7.5R 追加：閲覧専用）  
operator  
staff  
manager  
admin  
config-admin-primary  
config-admin-secondary


──────────────────────────────────
2. ID 体系（CU / UP / Order / OD / EXP / EX / 新辞書）
──────────────────────────────────

本章は v6.9R の ID体系を基礎とし、
v7.1R_diff の「テストIDルール」「EX_ID体系」、
v7.2R_diff の整理、
v7.3R_diff の LOCATION / HistoryNotes 統合、
v7.5R_diff の Runtime監査対応・ClickUp連携補助・AIログ統合 を含む
完全統合版である。

ID体系は **AI が変更してはならない“最重要禁止領域”** である。
変更する場合は必ず diff 方式で明示され、A→X→T→B のパイプラインを通る。


────────────────────────
2.1 顧客 ID（CU_ID）
────────────────────────

フォーマット：
  <cuPrefix>-AA001  
例：CU-AA001

ロジック：
  CU_Master の行数（ヘッダ除く）＋1 → 3桁ゼロ埋め
  persistentAlphaStart（AA）を固定採用

特徴：
● 顧客は永続 ID  
● テストID（AA00）は本番利用不可  
● v7.5R 追加：AI が CU_ID を生成・変更してはならない（素材抽出のみ）


────────────────────────
2.2 物件 ID（UP_ID）
────────────────────────

フォーマット：
  <upPrefix>-AA001-0001

ロジック：
  同一 CU_ID の物件数＋1 → 4桁ゼロ埋め  
  suffix（AA001）は CU_ID に従う

特徴：
● 永続ID  
● AI は素材抽出のみ  
● v7.5R：ClickUp 監督タスクは UP_ID と Order_ID をキーに同期可能


────────────────────────
2.3 受注 ID（Order_ID）
────────────────────────

フォーマット：
  orderPrefix-YYYYMMDD-00001-<UP_ID>

特徴：
● 日付単位の連番  
● 永続IDではない  
● UP_ID との結合によりユニーク性が保証  
● v7.5R：ClickUp 管理タスクの主キーとしても利用  
● v7.5R：AI違和感検知・自然文検索（OV02）が Order_ID を中心に紐づける


────────────────────────
2.4 発注行 ID（OD_ID）
────────────────────────

フォーマット：
  odPrefix-<Order_ID>-001

特徴：
● UF06 の new/reuse のたびに採番  
● 1 Order に複数存在可能  
● v7.5R：Runtime監査 expected effect 対象（UF06 の副作用検査項目）


────────────────────────
2.5 経費 ID（EXP_ID）
────────────────────────

フォーマット：
  EXP-YYYYMM-0001

特徴：
● 同月内で連番  
● EXP-YYYYMM-0000 はテスト専用  
● USED 部材の PRICE を Expense_Master に記録  
● v7.5R：Runtime監査 expected effect 対象（EXP レコード追加）


────────────────────────
2.6 EX_ID（v7.1R → v7.5R 統合）
────────────────────────

フォーマット：
  EX-YYYYMM-0001

特徴：
● 同月内連番  
● 0000 はテストID  
● 主キーは EX_ID  
● Order_ID を唯一の接続キーとして扱う（CU/UPは直接持たない）
● v7.5R：AI違和感検知（EXIF整合）と連携


────────────────────────
2.7 テストID（0番）ルール（強化）
────────────────────────

以下はすべてテスト専用で本番利用不可：
  AA00 / PA00 / MA00 / 0000 / EXP-YYYYMM-0000 / EX-YYYYMM-0000

v7.5R 強化点：
● テストデータには isTest=true を付与  
● OV01／OV02／集計系からは除外  
● RuntimeSelfTest 実行時は必ずテストIDを使用  
● 流用禁止（本番データと混ざらないようにする）


────────────────────────
2.8 廃番 → 新番 対応辞書（統合強化）
────────────────────────

Parts_DB に以下列を追加：

  discontinued（TRUE/FALSE）
  replacement（代替品品番）
  keywords（検索補助語）
  photoUrl（画像URL）

UF06 / UF07 の処理時：

  discontinued=TRUE の場合 GAS が以下を提示：

    「この品番は廃番です。代替品 {replacement} をご案内します。」

  ● AI は候補提示のみ（判断禁止）
  ● 正式採用判断は GAS（唯一の正）

v7.5R 追加：
● 代替品提示は ClickUp 管理タスクにも同期（管理者に通知）
● OV02 の全文検索で keywords を利用し曖昧検索可能


──────────────────────────────────
3. 台帳構造（CU_Master / UP_Master / Order_YYYY / Parts_Master /
              EX / Expense / Request）
──────────────────────────────────

本章は v6.9R の構造を維持しつつ、
v7.2R の正式収録、v7.3R の LOCATION／HistoryNotes 拡張、
v7.5R の AI解析ログ／ClickUp連携／UI最適化に対応する統合版。


────────────────────────
3.1 CU_Master（顧客台帳）
────────────────────────

ヘッダ：

  CU_ID  
  顧客名  
  カナ  
  区分  
  電話1  
  電話2  
  メール  
  郵便番号  
  住所  
  担当者名  
  注意事項  
  作成日  
  更新日  
  有効

UF01 登録：

● createNewCuId() で採番  
● 以下キーで既存一致 → 再利用  
　電話1／顧客名／住所  
● 無ければ新規追加  

v7.5R：
● 顧客関連の重要情報は ClickUp 管理タスクの概要欄にも同期可能（任意機能）  


────────────────────────
3.2 UP_Master（物件台帳）
────────────────────────

ヘッダ：

  UP_ID  
  CU_ID  
  物件番号  
  物件名  
  郵便番号  
  住所  
  建物種別  
  部屋番号  
  管理会社  
  注意事項  
  作成日  
  更新日  
  有効

UF01 登録：

● CU_ID＋住所 が一致 → 再利用  
● 無ければ createNewUpId(cuId)

v7.5R：
● ClickUp 管理タスクに物件情報を同期させ、進行管理の基礎データとする  


────────────────────────
3.3 Order_YYYY（受注台帳）
────────────────────────

ヘッダ：

  Order_ID  
  UP_ID  
  CU_ID  
  媒体コード  
  顧客名  
  電話  
  郵便番号  
  住所  
  addressFull  
  addressCityTown  
  希望日1  
  希望日2  
  見積金額  
  備考（raw全文）  
  summary（UF01 スタンプ生成）  
  STATUS  
  CreatedAt  
  UpdatedAt  
  LastSyncedAt  
  HistoryNotes（履歴メモ）

HistoryNotes 特徴：

● 自由記述欄  
● 内部の Order_ID を GAS が自動リンク化  
● OV01 上でクリック遷移可能

v7.5R：
● ClickUp との双方向参照を正式化  
● AI違和感警告（住所ゆらぎ・写真不足 etc）があれば  
　管理UI（ClickUp）にも通知される   
● RuntimeSelfTest では test-order として生成される  


────────────────────────
3.4 Parts_Master（部材台帳）
────────────────────────

ヘッダ：

  PART_ID  
  AA番号  
  PA/MA番号  
  PART_TYPE（BP/BM）  
  Order_ID  
  OD_ID  
  品番  
  数量  
  メーカー  
  PRICE  
  STATUS（STOCK/ORDERED/DELIVERED/USED/STOCK_ORDERED）  
  CREATED_AT  
  DELIVERED_AT  
  USED_DATE  
  MEMO  
  LOCATION（在庫位置）

LOCATION 特徴：

● 納品時に任意指定  
● STOCK 戻し時に必須  
● OV01 に表示  
● 在庫確認トリガーの対象  

v7.5R 強化：
● DELIVERY 更新の expected effect を Runtime監査が判定  
● parts フォルダの写真（parts/）との連携強化  
● AI による OCR/EXIF の解析は OV02 側で参照可能  

────────────────────────
3.5 EX_Master（EX体系：統合）
────────────────────────

ヘッダ：

  EX_ID
  Order_ID
  PART_ID
  AA番号
  PRICE
  USED_DATE
  MEMO

特徴：

● EXP_ID と異なり、EX_ID は「使用部材の記録専用」
● Order_ID を唯一の接続ポイントとして扱う（CU/UP 参照禁止）
● v7.5R：AI違和感検知（EXIF整合）と結びつく
● v7.5R：ClickUp 管理タスクへの「部材使用報告」反映が可能（任意）


────────────────────────
3.6 Expense_Master（経費台帳）
────────────────────────

ヘッダ：

  EXP_ID
  Order_ID
  PART_ID
  CU_ID
  UP_ID
  PRICE
  USED_DATE
  CreatedAt

v7.5R：

● USED 部材の PRICE を記録する「唯一の正」
● AI が金額推測することは禁止（判断禁止）
● EXPの生成は Runtime監査 expected effect に含まれる


────────────────────────
3.7 Request シート（FIX / DOC / UF07 / UF08）
────────────────────────

ヘッダ：

  Timestamp
  Category
  TargetID
  PayloadJSON
  Requester
  Memo

役割：

● ユーザーが提出した修正／書類／金額補完／追加報告を保持する箱
● GAS が内容を解釈し、業務ロジックを実行する
● v7.5R：AI補助（テンプレ生成）は許可、判断は禁止

v7.5R 強化点：

● FIX_SUBMIT / DOC_SUBMIT / UF08_SUBMIT は  
　Runtime監査 expected effect となる  
● testModeRuntime 時は Request シートに test-mode の JSON を記録する  
● Request レコードは ClickUp 監理タスクにも同期できる（任意）



──────────────────────────────────
4. UF01 パーサ構造（AI一次解析 → GAS決定 → AI監査）
──────────────────────────────────

本章は v6.9R の UF01 パーサ構造を基礎とし、
v7.0R の三層構造、
v7.1R の「情報照会モード」、
v7.2R の住所ロジック強化、
v7.3R の AI違和感検知・logs/system 統合、
v7.5R の ChatGPT API 補助強化／UI最適化 を含む完全版。


────────────────────────
4.1 対応媒体（v6.9R→v7.5R）
────────────────────────

対応媒体：

● Kurama（くらしのマーケット）
● Mitsumore（ミツモア）
● unknown（自由書式）

媒体判定は parseRawText 内で自動実行。

v7.5R：ChatGPT API によって
● rawText の文脈分類
● 媒体情報の抜け補完
● 不自然な言語構造の指摘
など補助解析が可能（判断は GAS）。


────────────────────────
4.2 パーサの役割（AI → GAS → AI）
────────────────────────

AI の役割は 素材抽出に限定。
正式値の決定権はすべて GAS。

AI が返せる候補値：

● name  
● phone  
● postal  
● pref  
● city  
● address_detail  
● priceTotal  

v7.5R 強化：

● ChatGPT API による「補助抽出」  
● フォーム入力補助（スマホ／PC対応）  
● 説明文の自然文から目的値の抽出（判断しない）  
● 不明箇所の再質問  
● AI違和感候補の抽出（判断禁止）


────────────────────────
4.x AI一次解析（v7.5R）
────────────────────────

成功条件（4項目）：

● name  
● pref  
● city  
● priceTotal  

これらが GAS の形式チェックを通過 → aiStatus = "OK"  
通過しない → aiStatus = "ERROR"（fallback）

v7.5R 強化：

● ChatGPT API が「曖昧住所の補助抽出」を提案できる  
　（例：「○○町と思われますが、最終決定は GAS に委ねます」）

● 伏字住所（＊＊＊）を含む場合でも素材抽出の精度向上


────────────────────────
4.x GAS決定層（唯一の正）
────────────────────────

住所／名前／金額／媒体 など UF01 の正式値はすべて GAS が決定する。

GAS 決定項目：

● rawText 再解析  
● AI候補値の参照（必要時のみ）  
● cityFixed / cityCustom の参照  
● Geolonia API による住所正当性チェック  
● addressCityTown の生成（AI 値は採用禁止）  

v7.5R：

● AI自然文解析の補助があっても  
　**GAS の生成する addressCityTown が唯一の正**

● logs/system に決定値サマリを詳細記録  
● 不一致があれば ClickUp に警告を送信（管理UI）


────────────────────────
4.x AI監査（二次解析）
────────────────────────

GAS 決定値と rawText の「重大矛盾」のみを警告として返す。

例：
● GAS → 兵庫県西宮市  
● rawText → 大阪市  
（AI：重要矛盾あり、GAS値は変更不可）

v7.5R 拡張（ChatGPT API の役割強化）：

AI は以下の違和感も抽出可能：

● 写真不足  
● PRICE 未入力  
● EXIF 不整合  
● 住所ゆらぎ  
● 完了コメントの異常  
● 時系列異常  
● 文章パターン異常  

ただし判断は禁止。  
警告は logs/system と ClickUp に通知（管理者向け）。


────────────────────────
4.x 情報照会モード（v7.1R→v7.5R）
────────────────────────

自然文（例：「顧客名は？」「希望日は？」）は  
情報照会モードとして扱う。

v7.5R：

● ChatGPT API による自然文理解の補助  
● 不足情報は AI が追加質問  
● 発注や処理の誤発動は絶対に起きない  
● ClickUp との連携は行わない（照会は GAS/AI 内のみに限定）


────────────────────────
4.3 住所体系（v7.2R→v7.5R 完全版）
────────────────────────

住所は以下 2 本で保持：

① addressFull（全文住所）  
例：兵庫県西宮市甲子園口3丁目5-2  

② addressCityTown（市＋町名）  
例：西宮市甲子園口  

v7.5R：

● addressCityTown は GAS の専権  
● AI 補助があっても GAS が必ず生成  
● OV01／ClickUp にも addressCityTown 表示  
● 伏字住所の取り扱い強化（安全に処理）

抽出基準（変わらず）：

● 「市／区／町／村／郡」まで  
● 直後の町名を含む  
● 丁目以下は含めない  

例：  
川辺郡猪名川町伏見台 → 川辺郡猪名川町  


────────────────────────
4.x fallback（v7.0R→v7.5R）
────────────────────────

AI が ERROR の場合：

GAS が rawText を再解析し、以下を抽出：

● name  
● addressCityTown  
● addressFull  
● priceTotal  

これら GAS 決定値が唯一の正。  

v7.5R 強化：

● fallback 時に AI が “何が原因で fallback されたか” を素材として logs/system に残す  
● 住所解析失敗 → 住所ゆらぎ候補を AI が添付（判断はしない）  
● fallback は ClickUp 管理者にも通知可能（任意）

──────────────────────────────────
5. UF01 フロー（完全統合版：v7.5R）
──────────────────────────────────

本章は v6.9R の UF01 を基礎とし、
v7.0R の三層構造、
v7.1R の情報照会、
v7.2R の summary 強化、
v7.3R の logs/system + 違和感検知、
v7.4R の Runtime監査前提整合、
v7.5R の ChatGPT API補助・ClickUp管理連携・UI最適化 を完全統合した仕様。


────────────────────────
5.1 UF01.html（フロント仕様：v7.5R フルリニューアル）
────────────────────────

UF01 フォームは **PC／スマホ／タブレット全端末対応のレスポンシブUI** とし、
以下の構造を必須とする。

● 入力項目  
  raw（通知全文 or 1行メモ）必須  
  name  
  phone  
  addressFull  
  preferred1  
  preferred2  
  price  

● UI 構造（v7.5R最適化）
  - スマホ：1カラム表示、入力欄は大きめ、ボタンはタップしやすい設計  
  - PC：2カラム表示、サマリ領域は右側固定  
  - タブレット：自動幅計算により1.5〜2カラム可変  

● チャットGPT API を利用した補助機能（判断禁止）
  - raw の候補抽出  
  - 不足項目の質問  
  - 補助的な住所候補の提示（決定権はGAS）  

● summary は UF01.html 内のスタンプ方式のみ採用  
● AI 要約は禁止（業務値の決定権はGASのみ）

● UI 過負荷禁止（v7.5R）
  - 入力ステップを増やす変更は禁止  
  - 過去バージョンより重くなる処理は禁止  
  - レイテンシ悪化を招く処理禁止（特にスマホ）


────────────────────────
5.2 UF01 受信ロジック（main.gs）
────────────────────────

onUF01Submit(e) の構成（完全版）：

① AI一次解析（素材抽出）  
② GAS決定（normalizeUF01FromForm）  
③ AI監査（重大矛盾のみ）  
④ logs/system への全記録（v7.3R）  
⑤ ClickUp 管理タスクへの初回通知（v7.5R）  
　※ 任意だが推奨。管理者は受注内容を即時確認できる。


────────────────────────
5.3 normalizeUF01FromForm（GAS決定処理）
────────────────────────

決定項目：

● rawText 再解析  
● AI 候補値の採否判断（素材として使用）  
● addressCityTown の再生成  
● Geolonia 判定（cityCustom 更新）  
● summary（スタンプ）採用  
● 必須項目チェック  
● logs/system に決定値記録  

v7.5R 強化：

● ClickUp タスク生成時の初期情報に  
　Order_ID／addressCityTown／媒体／顧客名  
　を反映できるようにした（任意）


────────────────────────
5.4 writeOrderFromUF01
────────────────────────

Order_YYYY に以下を記録：

Order_ID  
UP_ID  
CU_ID  
媒体コード  
希望日1/2  
見積金額  
備考（raw全文）  
addressFull  
addressCityTown  
summary  
HistoryNotes（空欄）

v7.5R 拡張：

● ClickUp 管理タスクの初期生成（任意）  
● HistoryNotes 初期化  
● RuntimeSelfTest の test-order 作成にも使われる

────────────────────────
5.5 Todoist タスク名：初期生成
────────────────────────

形式（統合版）：

  {AA群}{顧客名（敬称付）}{addressCityTown}_{媒体}

例：

  AA01_橋本カエデ様_西宮市甲子園口_KR  
  AA01_AA02_山田太郎様_川辺郡猪名川町_MM

特記事項：

● addressCityTown は GAS 決定値のみ使用  
● 初回は AA群なし  
● UF06 の発注／納品により AA群が追加  
● v7.5R：ClickUp への同期オプション（管理UIでの進捗監視）  


──────────────────────────────────
6. 部材体系（BP / BM / AA / PA / MA / LOCATION / 廃番辞書）
──────────────────────────────────

本章は v6.9R の部材体系に、  
v7.0R の AI制限、  
v7.1R のテストID、  
v7.2R の STATUS 推移、  
v7.3R の LOCATION／辞書、  
v7.4R の Runtime前提、  
v7.5R の ClickUp連携／UI最適化 を正式統合したもの。


────────────────────────
6.1 PART_TYPE
────────────────────────

PART_TYPE は 2 種類：

● BP（メーカー手配品）  
● BM（既製品／支給品／ホームセンター品）

BP：PRICE は納品時に確定  
BM：PRICE = 0円（経費対象外）


────────────────────────
6.2 永続ID（AAxx）
────────────────────────

AA01〜ZZ99  
generatePersistentId() が Parts_Master を参照し  
最大 AAxx の次番号を返す。

テストID（AA00）は使用禁止。

v7.5R：

● PART_ID の生成精度向上  
● AI による AA候補抽出は可（判断は GAS）


────────────────────────
6.3 枝番（PAyy / MAyy）
────────────────────────

BP：PA01〜PA99  
BM：MA01〜MA99

generateBranchId() により採番。

テストID（PA00/MA00）は使用不可。


────────────────────────
6.4 PART_ID
────────────────────────

BP：  
  BP-YYYYMM-AAxx-PAyy  

BM：  
  BM-YYYYMM-AAxx-MAyy  

例：  
  BP-202512-AA01-PA01  
  BM-202512-AA02-MA01

v7.5R：

● RuntimeSelfTest では test-id フォーマットで生成  
● ClickUp タスクの metadata として反映可能  


────────────────────────
6.5 PART STATUS（v7.5R 強化）
────────────────────────

STATUS：

● STOCK  
● ORDERED  
● DELIVERED  
● USED  
● STOCK_ORDERED  

強化点：

● LOCATION 必須チェック（STOCK時）  
● STATUS 推移で異常があれば AI違和感＋ClickUp警告  
● DELIVERED → USED の遷移は Runtime 監査対象  


────────────────────────
6.6 パーツ基本ルール（統合）
────────────────────────

● BM は PRICE=0（経費化しない）  
● BP は納品時に PRICE 入力必須  
● STATUS 推移：ORDERED → DELIVERED → USED  
● LOCATION：STOCK 時に必須  
● 代替品辞書の参照は UF06 / UF07 で行う  
● v7.5R：UI改善（部材カードUI：スマホ／PC両対応）  


────────────────────────
6.7 廃番 → 新番対応辞書（統合強化）
────────────────────────

Parts_DB に以下列：

  discontinued（TRUE/FALSE）  
  replacement（代替品品番）  
  keywords（検索補助）  
  photoUrl（画像URL）

UF06／UF07 の処理時：

● discontinued=TRUE → GAS が代替品案内  
● AI は候補提示のみ  
● 決定は GAS

v7.5R：

● 代替品提示を ClickUp へも通知（管理者支援）
● OV02 の全文検索で keywords 検索が可能


──────────────────────────────────
7. UF06 フロー（発注／納品／再利用：v7.5R）
──────────────────────────────────

v6.9R の UF06 を基礎に、
v7.0R〜v7.3R の AI制限／STATUSロジック／納品UI／AA抽出、
v7.4R の Runtime前提整合、
v7.5R の UI再構築／ClickUp連携 を完全統合した発注プロトコル。

────────────────────────
7.1 UF06（発注カード UI：v7.5R）
────────────────────────

UI（スマホ／PC 対応）：

● コピペ入力→部材候補行生成  
● AI は品番候補・数量候補・メーカー候補を抽出（判断禁止）  
● 区分（BP/BM）切替  
● AA採番／PA・MA採番  
● 採用✓ のみ発注  
● OrderID 無 → STOCK_ORDERED  
● 廃番辞書チェック（v7.3R）  
● v7.5R UI 改善：スマホでは折りたたみ／PCは2カラム表示  
● エラー行（AI不確実）は黄色表示  

────────────────────────
7.2 発注確定ロジック（完全版）
────────────────────────

【BP の場合】  
  AAxx 採番  
  PAyy 採番  
  PART_ID = BP-YYYYMM-AAxx-PAyy  
  STATUS = ORDERED  
  PRICE = 未定  
  OD_ID 発行  
  OrderID 無 → STOCK_ORDERED  

【BM の場合】  
  AAxx 採番  
  MAyy 採番  
  PART_ID = BM-YYYYMM-AAxx-MAyy  
  STATUS = ORDERED  
  PRICE = 0  
  OD_ID 発行  

v7.5R：

● 発注完了時に ClickUp 管理タスクへ在庫ステータス通知  
● AIは素材抽出のみ  
● Runtime監査では 「ORDERED 行が Parts_Master に追加される」ことが expected effect

────────────────────────
7.3 UF06（納品フォーム UI：v7.5R）
────────────────────────

UI（v7.5R 最適化版）：

● 同一 PART_ID は折りたたみ表示  
● 「この品番をすべて納品 ✓」を明確化（スマホでは大きめボタン）
● BP：PRICE 入力必須（入力 UI は端末幅で最適化）
● BM：PRICE = 0（固定表示）
● LOCATION 入力欄はスマホではプルダウン＋入力補助
● logs/system に必ず記録（納品イベント）
● v7.5R では **納品カード UI を PC／スマホ／タブレット各端末で再設計**
   - PC：2カラム横長配置
   - スマホ：縦積みカード＋スワイプ操作最適化
   - タブレット：自動可変

納品ロジック（GAS）：

● STATUS = DELIVERED  
● DELIVERED_AT 記録  
● PRICE（BPのみ）入力  
● LOCATION の記録  
● logs/system に完了ログ記録  
● AA群 抽出→Todoist タスク名へ反映  
● すべて DELIVERED の場合：Order ステータス自動遷移（v7.2R）

v7.5R 拡張：

● DELIVERED → Runtime監査 expected effect  
● ClickUp 管理タスクへ「納品完了」ステータス同期  
（任意だが推奨）


────────────────────────
7.4 Order ステータス自動判定（統合）
────────────────────────

使用値：

  hasBP  
  hasBM  
  deliveredCount  
  bpDeliveredCount  
  bmDeliveredCount  
  再発注フラグ  

GAS が完全自動判定する（AI判断禁止）。

v7.5R 拡張：

● 自動判定後、ClickUp 管理タスクへ進行ステータス通知（任意）
● Runtime監査にて「ステータス遷移後の副作用」を検査可能


────────────────────────
7.5 コメント操作（v7.5R）
────────────────────────

Todoist コメントのトリガー：

● 発注  
● 納品  
● 金額入力（UF07）  
● 追加報告（UF08）
● 完了報告  

権限：operator 以上

モード：

● トリガー → モード固定  
● GAS が質問テンプレート送信  
● ユーザー回答 → GAS が該当処理を実行  
● 結果をコメント出力  
● logs/system に記録  

v7.5R 強化：

● コメント内容に「異常パターン」があれば AI 違和感検知を実施  
● 重大異常は ClickUp にも通知（管理監督 UI として反映）


────────────────────────
7.6 UF07（価格入力フォーム v7.5R）
────────────────────────

目的：BP の PRICE 未入力部材を補完する。

入力：

  OrderID  
  PART_ID 一覧  
  PRICE  

動作：

● PART_ID の PRICE を更新  
● STATUS 変更なし  
● logs/system に記録  
● 廃番辞書とは独立  
● v7.5R：UI 再設計（スマホ向け大ボタン化／PCは横並び）

Runtime監査：

● PRICE 更新は expected effect  
● 更新されていない場合、D は Runtime破綻として差し戻す


────────────────────────
7.7 UF08（追加報告フォーム v7.5R）
────────────────────────

目的：
● 現場の追加写真／追加説明を Order に紐づけて保存する。

保存先：
● photos/extra/  
● logs/extra/

権限：operator 以上

トリガー語：
● 追加報告  
● 追補  

v7.5R 拡張：

● スマホ UI 最適化（カメラ入力→即保存）
● 追加報告の JSON を Request シートに記録
● OV01 に即時反映（UI遷移なし）
● Runtime監査：UF08_SUBMIT が logs/system に存在することを expected effect として判定


──────────────────────────────────
8. Todoist タスク仕様（統合 + 三階層化）
──────────────────────────────────

本章では、v6.9R〜v7.3R の Todoist タスク仕様に、
v7.5R の **三階層タスクモデル（Todoist × ClickUp × ChatGPT API）** を正式に接続する。

Todoist＝現場の唯一の正  
ClickUp＝管理・監督・配分  
ChatGPT API＝AI補助（抽出・解析・警告）  
GAS＝業務ロジックの唯一の正


────────────────────────
8.1 タスク名（content）
────────────────────────

形式（統合版）：

  {AA群}{顧客名（敬称付）}{addressCityTown}_{媒体}

v7.5R 拡張：

● addressCityTown は GAS の専権  
● タスク名は “現場UI（Todoist）” のみに使用  
● ClickUp 側には “管理向け名称（管理名）” を別途生成可能  

例（Todoist）：  
  AA01_橋本カエデ様_西宮市甲子園口_KR

例（ClickUp 管理名）：  
  【KR】橋本カエデ様 / 西宮市甲子園口 / OrderID:xxx


────────────────────────
8.2 説明欄（description）
────────────────────────

v6.9R 基構造＋以下拡張：

● UF01 summary（スタンプ）  
● 見積金額  
● 顧客情報（名前／住所／電話）  
● 希望日  
● OrderID  

v7.5R：

● 健康スコア（HealthyScore）は説明欄に含めない（OV01に集約）  
● 長文の場合、モバイル UI では折りたたみ表示  
● ChatGPT API による自然文解析ログ（AI違和感候補）は  
　Todoist には表示せず、ClickUp 管理側にのみ送信


────────────────────────
8.3 コメント欄（Todoist 完了報告）
────────────────────────

保存内容：

● 完了報告コメント全文  
● AI解析素材（違和感検知に利用）  
● Order_YYYY に commentText として保存  
● logs/system に保存  

v7.5R 拡張：

● コメントに “重大異常（AI違和感）” がある場合、ClickUp にも通知  
● 時系列異常・写真不足・住所矛盾などが対象


────────────────────────
8.4 未使用部材処理（v7.5R）
────────────────────────

extractUnusedPartIds(text) により：

● BP-…  
● BM-…  

を抽出し、未使用部材として STOCK 戻し処理。

v7.5R 改善：

● STOCK 戻し時に LOCATION の整合チェック実施  
● STOCK 戻しも Runtime監査 expected effect に含まれる  
● 異常時は AI違和感検知が作動 → ClickUp 警告


────────────────────────
8.5 システム警告（統合強化）
────────────────────────

以下の異常が検出された場合、ClickUp の管理タスクへ自動通知：

● PRICE 未入力部材  
● 未納品部材  
● 住所不整合  
● 写真不足  
● AI違和感（住所ゆらぎ／EXIF不整合／文章異常）  
● UF07／UF08 の不足入力  
● Runtime監査エラー  

v7.5R：

● 警告は Todoist ではなく **ClickUp に送る**  
　（現場ではなく管理側が判断するため）


──────────────────────────────────
9. 完了同期（Todoist → システム台帳）
──────────────────────────────────

本章は v6.9R の完了同期を基盤に、
v7.0R〜v7.3R の EX体系／STATUS遷移／AI監査素材保存、
v7.4R の Runtime前提整合、
v7.5R の ClickUp管理通知・AI拡張 をすべて統合した完全版。


────────────────────────
9.1 完了トリガー
────────────────────────

Todoist タスク完了 → Webhook → GAS 呼び出し：

completeOrderFromTodoist(orderId, completedAt, commentText)

parameters:
● orderId（Order_ID）
● completedAt（完了日時）
● commentText（完了コメント全文）


────────────────────────
9.2 完了処理ロジック（完全版）
────────────────────────

completeOrderFromTodoist() の手順：

① ensureBusinessSheets()  
② updateOrderOnCompletion(orderId, completedAt)  
③ markDeliveredPartsAsUsed(orderId, completedAt)  
④ recordExpensesForUsedParts(orderId, usedParts, completedAt)  
⑤ processUnusedPartsFromComment(orderId, commentText)  
⑥ AI違和感検知（写真・住所ゆらぎ・文章異常）  
⑦ logs/system に全記録  
⑧ ClickUp に進行通知（任意）  

v7.5R：

● STATUS／LastSyncedAt 更新は Runtime監査 expected effect  
● USED/DELIVERED の整合も expected effect  
● EXP の追加も expected effect  
● 未使用部材の STOCK 戻しも expected effect  
● AI違和感は ClickUp にも送信可能

────────────────────────
9.3 EX の Order 接続（v7.1R → v7.5R）
────────────────────────

● EX の主キーは EX_ID  
● Order_ID を唯一の接続キーとして扱う  
● CU／UP は直接参照しない（Order_ID 経由）  

v7.5R 拡張：

● ClickUp 管理タスクに “使用部材一覧” を同期可能  
● AI違和感（EXIF不整合）が発生した場合は EX レコードも対象となる


────────────────────────
9.4 EX_Master 最低項目（v7.1R→統合）
────────────────────────

EX_ID  
Order_ID  
PART_ID  
AA番号  
PRICE  
USED_DATE  
MEMO  


────────────────────────
9.5 未使用部材コメント書式（v6.9R→統合）
────────────────────────

未使用：BP-202512-AA01-PA02, BM-202511-AB00-MA01

v7.5R：

● STOCK 戻し時、LOCATION の整合を必ず検査  
● STOCK 戻しは Runtime監査 expected effect  
● 不整合時は AI違和感 → ClickUp 警告通知


────────────────────────
9.6 EXP_ID 生成（v6.9R＋v7.5R 強化）
────────────────────────

EXP-YYYYMM-0001  
同月内連番  
0000 はテスト専用  

v7.5R：

● EXP 追加は Runtime監査 expected effect  
● EXP が追加されていなければ D は Runtime破綻として差し戻す  
● AIは EXP候補を推測してはならない（判断禁止）


────────────────────────
9.7 作業完了後のセクション遷移（v6.9R→v7.5R）
────────────────────────

⑤「日時確定→作業待ち」 → ⑥「入金待ち」

v7.5R：

● ClickUp 管理タスクへステータス遷移を通知可能  
● 遅延や異常を管理 UI で確認できる


────────────────────────
9.8 健康スコア（HealthyScore：新設）
────────────────────────

GAS が固定ロジックで算出（0〜100点）：

基準例：

● UF01 情報の欠落  
● BP の PRICE 未入力  
● 写真不足  
● 未使用部材処理の不備  
● AI違和感警告数  
● Order STATUS 整合性  

v7.5R：

● OV01 上部に表示  
● 70点未満 → 「不備あり」赤色表示  
● ClickUp 管理タスクにも同期可能（任意）  
● AIは判断禁止、抽出補助のみ可  


──────────────────────────────────
10. フォーム FIX / DOC / UF07 / UF08（完全対応版）
──────────────────────────────────

本章は v6.9R〜v7.3R の FIX/DOC を基盤に、
v7.5R の ChatGPT API 補助、ClickUp 管理連携、
スマホ最適化 UI、Runtime監査整合 を統合したもの。


────────────────────────
10.1 FIX（修正申請フォーム v7.5R）
────────────────────────

FIX.html フォーム仕様：

category（固定分類）：
● 発注キャンセル（返品可）
● 発注キャンセル（返品不可）
● 納品キャンセル（返品可）
● 納品キャンセル（返品不可）
● 区分変更（BP↔BM）
● 入り値修正
● 欠番扱い
● 在庫切離し

content（自由記述）

formSubmitFIX(payload)：

● Request シートへ記録  
● Timestamp  
● Category  
● TargetID（空）  
● PayloadJSON  
● Requester  
● Memo  

禁止（v7.1R→v7.5R）：

● ClickUp からの入力  
● コメントによる危険修正（業務破壊につながる）  

v7.5R 拡張：

● ChatGPT API による修正テンプレート生成（判断禁止）  
● FIX_SUBMIT が Runtime監査 expected effect  
● ClickUp 管理タスクに「修正申請あり」通知可能  


────────────────────────
10.x コメントによる修正範囲（強化）
────────────────────────

コメントで許可される「軽微修正」：

● メール追加  
● 注意事項追加  
● 担当者名追加  
● Order 備考追加  
● 見積金額の軽微修正  
● 使用部材の追加記録（削除は不可）  

コメントで禁止される「危険修正」：

● BP↔BM 区分変更  
● PRICE の大幅修正  
● 欠番扱い  
● 在庫切離し  
● 品番変更  
● 顧客名変更  
● 顧客住所変更  
● 物件住所変更  
● AA再発番  
● Order_ID 内部構造の変更  
● 書類内容（宛名／金額）変更  

v7.5R：

● 危険修正の試行があれば logs/system と ClickUp に警告  
● ChatGPT API による誤操作検知ロジックを追加（判断禁止）


────────────────────────
10.x 修正テンプレート（AI補助 v7.5R）
────────────────────────

AI は修正内容に応じ、必要項目だけを番号形式で提示する。

例：
1 対象ID  
2 新しい値  

v7.5R：

● ChatGPT API で自然文を解析し、適切なテンプレを提示  
● 判断は禁止、あくまで“素材生成”  
● GAS のみが業務ロジックを決定  


────────────────────────
10.2 DOC（書類リクエストフォーム v7.5R）
────────────────────────

DOC.html 入力項目：

orderId  
docType（見積書／請求書／領収書／その他）  
docName  
docDesc  
docPrice  
docMemo  

formSubmitDOC(payload)：

● Request シートに JSON を記録  

v7.5R 拡張：

● PDF生成は引き続き GAS が唯一の正  
● 送信先：  
　顧客メール  
　yorisoidoupdf@gmail.com  
　追加指定メール  
● ChatGPT API は文章補助のみ可  
● DOC_SUBMIT は Runtime監査 expected effect  


────────────────────────
10.3 UF07（価格入力フォーム v7.5R）
────────────────────────

（注：UF07は7章ですでに説明済み。ここは仕様メタ記述の再掲。）

目的：
● BP の PRICE 未入力問題を解消


────────────────────────
10.4 UF08（追加報告フォーム v7.5R）
────────────────────────

（注：UF08は7章にて定義済み。ここでは追加メタ記述。）

v7.5R：

● ChatGPT API による「写真の簡易分類」補助  
● GAS が正式判断  
● AIは EXIF解析など“素材抽出”のみ実施  


──────────────────────────────────
11. メニュー／doGet（統合＋端末最適化）
──────────────────────────────────

本章は v6.9R のメニュー構造を維持しつつ、
v7.0R〜v7.3R の入力入口制限、
v7.3R の LOCATION／履歴系、
v7.4R の Runtime前提整合、
v7.5R の **レスポンシブUI（PC／スマホ／タブレット）** を完全統合したもの。


────────────────────────
11.1 onOpen（メニュー生成）
────────────────────────

メニュー名称：

● brandProfiles[0].name  
● または systemName  
● または “業務メニュー”

表示項目：

● forms[] のうち enabled=true のものを  
　「{kind}（{code}）」形式で列挙

禁止：

● ClickUp 側に入力導線を追加してはならない  
● UF01／UF06／UF07／UF08 が唯一の入力入口


────────────────────────
11.2 showDynamicForm(code)
────────────────────────

code（UF01〜UF08／FIX／DOC／OV01／OV02）に対応する  
HTML をモーダル表示。

v7.5R：

● 表示される HTML は **レスポンシブUI** とする  
● スマホで最優先されるべき UI：  
　・入力欄の大型化  
　・ボタン類のタップ最適化  
　・スクロール量の削減  
● PCでは情報量を多く持たせ、横配置を多用する


────────────────────────
11.3 doGet(e)
────────────────────────

URL パラメータ ?form=UF06 などで表示フォーム切替。

enabled かつ maintenanceMode=false の場合のみ表示。

フォーム別処理：

● UF01 → 住所解析  
● UF06 → 発注／納品カード UI  
● UF07 → PRICE入力  
● UF08 → 追加報告  
● FIX → 修正申請  
● DOC → 書類リクエスト  
● OV01 → カルテ表示  
● OV02 → 全文検索  

禁止：

● ClickUp からの新規入力  
● UI 劣化を招く変更


────────────────────────
11.x HTML 実行環境チェック（v7.5R）
────────────────────────

すべてのフォーム（UF01〜UF08／FIX／DOC／OV01／OV02）は
body onload 時に次を実行：

function checkEnvironment() {
if (typeof google === "undefined" ||
!google.script ||
!google.script.run) {
alert("このフォームは正しい方法で開かれていません。\nスプレッドシートのメニューから開いてください。");
}
}



● onload は既存 onload と共存（merge）させる  
● checkEnvironment() を削除してはならない（破綻防止機構）  
● Runtime監査の「環境起動条件」を満たすための必須仕様


──────────────────────────────────
12. 運用ルール（v7.5R完全統合）
──────────────────────────────────

本章は v6.9R〜v7.3R の運用規範に、
v7.4R の Runtime前提整合、
v7.5R の **ClickUp復旧・ChatGPT API補強・UI最適化** など
全改訂を正式統合したもの。

────────────────────────
12.1 master_spec の扱い（不変）
────────────────────────

本 master_spec が唯一の正。

● 過去チャット  
● 古いメモ  
● AI の推測  
はすべて無効。

すべての仕様変更は必ず “差分（diff）方式” で行う。


────────────────────────
12.2 コード修正ルール（絶対）
────────────────────────

CONFIG／main／HTML は以下のみ許可：

● 丸ごと貼り替え  
● function 単位の完全差し替え  

禁止：

● 部分編集  
● 行追加のみ／削除のみ  
● AI の推測補完  

破った場合、D が Runtime破綻として差し戻す。


────────────────────────
12.3 AI と GAS の役割境界（鉄則）
────────────────────────

AI：

● 素材抽出  
● 自然文解析の補助  
● AI違和感候補の抽出  
● 修正テンプレ生成  
● OV02 のキーワード抽出  
● D の補助レビュー（ペアレビュー）  

GAS：

● 住所  
● ID  
● 区分  
● 価格  
● STATUS  
● LOCATION  
● 健康スコア  
● 書類生成  
● 全業務ロジックの唯一の正


────────────────────────
12.4 UF01／UF06／UF07／UF08 は唯一の入力入口
────────────────────────

ClickUp からの入力は禁止。  
整合性のため、入力は必ず GAS の UF 系フォームのみ。

────────────────────────
12.5 AI再解析ルール（素材抽出のみ）
────────────────────────

保存対象：
● rawText（UF01）  
● commentText（Todoist 完了報告）  

AI は「素材抽出」のみ許可される。

AI ができること：

● 住所ゆらぎ抽出（判断禁止）  
● 写真枚数不足検知（判断禁止）  
● 完了コメントの文章パターン異常抽出（判断禁止）  
● OCR結果の抜け補助（判断禁止）

AI ができないこと：

● GAS が決定した業務値の上書き  
● 正式値の提案  
● ID生成・変更  
● STATUS判断  
● PRICE推測

v7.5R：

● AI再解析は logs/system に結果を記録（GASは参照可）  
● ClickUp へも「疑似警告」として通知可能（判断は管理者）


────────────────────────
12.6 Drive 保存体系（v7.x 系基本方針 → v7.5R統合）
────────────────────────

CONFIG.storageProfiles に基づき、
年度＋枝番で保存フォルダを切り替える。

保存対象：

● photos/before  
● photos/after  
● photos/parts  
● photos/extra  
● videos/before  
● videos/after  
● videos/inspection  
● logs/system  
● logs/extra  
● archive  

v7.5R 強化：

● すべてのフォルダ構造が OV02 の全文検索対象  
● AI OCR に基づく “素材テキスト” を logs/system に保存  
● GAS は正式判断のみ行う（AIは判断禁止）


────────────────────────
12.7 Webhook（v7.2R→v7.5R）
────────────────────────

Todoist 完了コメント全文（commentText）を Order_YYYY に保存する。

v7.5R：

● AI違和感検知の素材（写真／文章）も Webhook 起点で集約  
● 必要であれば ClickUp に “完了通知＋異常候補” を送信可能  


────────────────────────
12.8 コメントモード（v7.1R→v7.5R）
────────────────────────

● トリガー語でモード開始  
● モード中は、その文脈以外のコマンド実行は禁止  
● 無関係発言 → 「キャンセルしました」  
● 1時間放置 → 自動キャンセル  
● 手動キャンセル：「キャンセル」「やめる」

v7.5R：

● AIが自然文からモード判定補助（判断は禁止）  
● GAS が最終決定  
● ClickUp 連携は行わない（入力制御は現場側）


────────────────────────
12.9 コメントトリガー一覧（統合）
────────────────────────

● 発注  
● 納品  
● 金額入力  
● 追加報告  
● 完了報告  
● 修正（修正／変更／訂正／fix）  
● 領収書  
● 請求書  
● 見積書  
● 在庫確認  
● 更新（再同期）  
● 検索／調査／履歴検索（OV02）  
● トリガー（一覧表示）

v7.5R：

● これらのトリガーは AI が誤発動させないように、  
　 “モード外発言禁止” が強化されている  
● ClickUp からのトリガー発動は禁止（業務破壊防止）


────────────────────────
12.10 在庫確認トリガー（v7.5R）
────────────────────────

コメント 1 行目が「在庫確認」。

GAS が Parts_Master から STATUS=STOCK の部材を抽出し：

● 品番  
● 数量  
● AA番号  
● LOCATION  

を一覧返却する。

v7.5R：

● AI違和感検知：LOCATION 欠落時に警告  
● ClickUp 管理タスクにも「在庫情報」通知可能（任意）


────────────────────────
12.11 更新トリガー（再同期・冪等：v7.5R）
────────────────────────

コメント 1 行目が「更新」。

GAS が以下を再同期：

● Order_YYYY  
● Archive_Order  
● Parts_Master  
● EXP_Master  
● EX_Master  
● Todoist  
● ClickUp  

v7.5R：

● 冪等性（idempotency）必須  
● 何度実行してもデータは壊れない  
● AI は補助抽出のみ（判断禁止）


────────────────────────
12.12 トリガー一覧返却（統合）
────────────────────────

コメント 1 行目が「トリガー」と一致した場合、
すべての利用可能トリガーを番号付きで返す。

v7.5R：

● スマホ UI では番号ボタンを大きく表示  
● PC では2カラム化  


────────────────────────
12.13 AI違和感検知（v7.5R強化）
────────────────────────

AI が抽出可能な “違和感素材”：

● After写真不足  
● 写真の向き／EXIF不整合  
● PRICE 未入力  
● 完了コメント異常  
● 住所ゆらぎ  
● 時系列異常  
● 不審パターン（AIが気づいた素材：判断禁止）

GAS：

● 判断者（唯一の正）  
● 位置・時刻などの整合性を確定  
● 必要に応じて ClickUp に警告を送信（管理者が確認）


────────────────────────
12.14 健康スコア（HealthyScore：v7.3R→v7.5R強化）
────────────────────────

GAS が算出（0〜100点）

70点未満：不備あり（赤表示）

v7.5R：

● “どの項目が減点になったか” の詳細ログを logs/system に出力  
● ClickUp 管理画面の概要欄にも同期可能（任意）  
● AI は判断禁止、抽出補助のみ可  


────────────────────────
12.15 全アクション logs/system 記録（統合強化）
────────────────────────

UF01／UF06／UF07／UF08／FIX／DOC／OV01／OV02／
在庫確認／更新／Todoist完了／ClickUp通知／AI違和感抽出／
RuntimeSelfTest／rollback候補 など、
すべての重要操作は logs/system に記録される。

記録内容：

● Timestamp  
● 操作種別  
● 対象ID（Order / PART / CU / UP）  
● 入力内容  
● GAS決定値サマリ  
● AI違和感候補  
● Runtime監査結果（OK／NG）  
● 実行環境チェック結果  

v7.5R：

● logs/system は OV02 の全文検索対象  
● testModeRuntime 時は “test” フラグを必須記録


──────────────────────────────────
12.R Runtime監査ルール（v7.5R：完全版）
──────────────────────────────────

12.R-1 必須副作用チェック（expected effect）

以下のいずれかが実行されたとき、
必ず次の副作用が発生しなければならない（GAS の責務）。

● UF01：Order_YYYY に 1 行以上追加  
● UF06（発注）：Parts_Master に新規行 or 更新  
● UF06（納品）：PART_ID の STATUS／PRICE／DELIVERED_AT 更新  
● UF07：PRICE 更新  
● UF08：logs/system に UF08_SUBMIT 追加  
● FIX：Request に FIX_SUBMIT 追加  
● DOC：Request に DOC_SUBMIT 追加  
● 完了同期：STATUS／LastSyncedAt 更新、USED 遷移、EXP追加、STOCK戻し  

v7.5R 追加：

● unexpected effect（発生してはならない副作用）も監査対象  
● 例：本番シート以外への書込み、複数行重複追加、異常な日付、ID異常など


12.R-2 Runtime破綻の定義

● expected effect が欠落している  
● unexpected effect が発生した  
→ D は「Runtime破綻」として NG 判定し、B に差し戻す。


12.R-3 Runtime破綻と実行環境

Runtime破綻は：

● フォーム誤起動  
● Google認証エラー  
● ネットワーク断  
● ユーザーデバイスの JS ブロック  
● GASクォータ超過  

など外的要因も含むが、D は理由を推測しない。

B は短い注意文としてユーザーへ通知可（例：「通信状態に問題があった可能性があります」）。


12.R-4 C→N→D→R→C 自律ループと S 保存

● StaticCheck（構造監査）  
● RuntimeCheck（実行監査）  

両方が OK の場合のみ S に保存される。

● S→Apps Script 同期は S が更新されたときのみ行う  
● NG の場合は rollback 候補として logs/system に記録


──────────────────────────────────
12.S コード同期ルール（S→Apps Script）
──────────────────────────────────

S に保存されたコード（CONFIG／main／HTML）は、
B フェーズでユーザー要求に応じて forced-block-split で出力される。

Apps Script 側の実コードは、
S の全文コードを「そのまま貼り替える」ことで同期される。

利点：

● 差分編集を禁止し、  
　**破綻リスクゼロ** の同期を実現  
● D が NG の場合 S は更新されないため、  
　Apps Script 側が壊れることがない  

v7.5R：

● タブレット表示を含む HTML の最適化コードも S に保存  
● GAS は S を唯一のコードソースとして読み込む（人的編集禁止）


──────────────────────────────────
12.T Runtime テスト実行ルール（v7.5R）
──────────────────────────────────

目的：

● Runtime監査が正しく機能することを保証するため、  
　実際に GAS を動かす “テスト実行” を formalize する。


12.T-1 テストモード条件

● CONFIG.testModeRuntime = true  
● テストID（AA00／PA00／MA00／EXP-0000／EX-0000）を強制使用  
● 本番データと絶対混在させない（isTest=true）


12.T-2 テスト実行エントリポイント

● スプレッドシートメニュー「Runtimeテスト」  
● Apps Script の関数 runRuntimeSelfTest()  
● API 経由のテスト起動は今後対応可  

ユーザーコメント・ClickUp からの起動は禁止。


12.T-3 テストシナリオ（必須）

1）UF01：test-order を 1 件登録  
2）UF06（発注）：test 部材登録  
3）UF06（納品）：DELIVERED 遷移  
4）UF07：PRICE 更新  
5）UF08：追加報告  
6）FIX：修正申請  
7）DOC：書類申請  
8）completeOrderFromTodoist：完了同期  

すべて testID を利用し、本番データとは隔離。


12.T-4 D によるテスト監査

● expected effect が揃っているか  
● unexpected effect が発生していないか  
● logs/system にテストログが揃っているか  

NG → B に差し戻す  
OK → 次ステップへ


12.T-5 テストデータの扱い

● Test_* シートに隔離保存が望ましい  
● 本番シートに置く場合は isTest=true を強制  
● OV01／OV02／集計には含めない


──────────────────────────────────
12.U Rollback・Self-Diff（v7.5R：新設）
──────────────────────────────────

本章は、ユーザーが指摘した  
「IDや仕組みが 0 に戻る」  
という問題を二度と発生させないための **公式の安全装置** として追加する。

12.U-1 自動巻き戻し（rollback）

● C→N→D→R→C のサイクルが **3 回連続で NG** の場合、  
　最新の S（安定版コード）を“完全復元”し、N に再読み込みする。

● rollback は logs/system に記録  
● AI は rollback を判断しない（GAS 自動）


12.U-2 AI Self-Diff（自己差分検知）

● ChatGPT は master_spec／compiler-spec／コード生成において  
　“過去の自分の回答と矛盾” を検出した場合、  
　ユーザーに 1 行警告を返してよい。

例：  
「前回の仕様と整合しない可能性があります。差分確認しますか？」

● AI は仕様変更を勝手に行ってはならない。  
　警告のみ。


12.U-3 ID 系統の完全保護

● 2章の ID体系は “超禁区” とし、  
　AI による要約・再構成・提案を一切禁止。  

● ID 修正が必要な場合は  
　必ずユーザーが差分（diff）を提示し、  
　A→X→T→B の公式パイプラインを通過する。


──────────────────────────────────

（※ ここまでが 12章です。  
　次ブロックで「13〜ClickUp／ChatGPT API／UI章／更新履歴」を続けます。）

──────────────────────────────────
13. Aチャット運用ルール（v7.5R：完全統合）
──────────────────────────────────

本章は Aチャット（差分統合フェーズ）の正式運用手順を定義する。
master_spec の変更は **diff（差分）方式のみ許可** され、
ChatGPT が本文を勝手に編集・再構成することは禁止。

────────────────────────
13.1 仕様変更の手順（最重要）
────────────────────────

1. ユーザーが変更点を箇条書きで提示  
2. ChatGPT（B）が差分（diff）を作成  
3. diff と旧 master_spec を統合し、新 master_spec を生成  
4. この新 master_spec が “唯一の正” として確定  
5. 必要に応じて CONFIG / main / HTML を再生成  

※ ChatGPT は **diff を生成するだけ**。  
　本文の改変は diff 適用によってのみ行われる。

────────────────────────
13.2 Aチャットの範囲
────────────────────────

Aチャットは master_spec（全文）と diff（全文）だけ扱う。

禁止：

● 雑談  
● コード議論  
● HTMLデザイン議論  
● 外部推測  
● 部分的な推測補完  
● 設計の“暗黙的書換え”

────────────────────────
13.3 マスター完全性
────────────────────────

master_spec は  
「直前バージョン（全文） ＋ 差分（全文）」  
を統合した **完全原本**。

● 一字一句の削除  
● 要約  
● 再構成  
● 圧縮  

はいずれも禁止。

※ v7.5R：AI による本文“再整形”は禁止（Self-Diff により警告対象）

──────────────────────────────────
14. OV01（閲覧フォーム：完全仕様 v7.5R）
──────────────────────────────────

目的：Order の「カルテ」を閲覧する統合ビュー。

v7.5R での正式追加：

● HistoryNotes（自由記述＋Order_ID 自動リンク）  
● Before/After スライダー比較（スマホ最適）  
● LOCATION 表示（STOCK 時必須）  
● AI違和感警告（表示）  
● 健康スコア（0〜100）  
● 追加報告（UF08）反映  
● すべてのログ（logs/system）  
● すべての写真（before/after/parts/extra）  
● すべての動画（videos/inspection）  
● レスポンシブ UI（PC／スマホ／タブレット）

────────────────────────
14.1 OV01 表示項目（v7.5R）
────────────────────────

● Order 基本情報（顧客名／住所／媒体）  
● 顧客情報（CU_Master）  
● 物件情報（UP_Master）  
● UF01 summary（スタンプ）  
● Todoist タスク情報  
● STATUS  
● LOCATION  
● 部材一覧（AA/PA/MA）  
● 写真（before/after/parts/extra）  
● 動画（inspection）  
● EX／EXP  
● HistoryNotes（クリックで別 Order へ遷移）  
● 健康スコア  
● AI違和感警告（赤ラベル）

────────────────────────
14.2 HistoryNotes（v7.5R完全仕様）
────────────────────────

Order に自由記述欄を持つ。

● 内部の Order_ID は GAS が自動リンク化  
● OV01 表示時にクリックで別 Order を開ける  
● OV02 の全文検索対象  
● ChatGPT API による自然文要点抽出は“補助のみ”（判断禁止）

────────────────────────
14.3 LOCATION 表示（v7.5R）
────────────────────────

Parts_Master.LOCATION を表示。

● STOCK の場合、必須情報  
● LOCATION 未入力は AI違和感（ClickUp にも警告）  
● 在庫確認トリガーと連携


────────────────────────
14.4 Before/After スライダー（v7.5R）
────────────────────────

UI 標準仕様：

● PC：横スライダー  
● スマホ：縦に並べ、スワイプ式スライダーを自動切替  
● タブレット：画面幅に応じてレイアウト変化  
● 画像は LazyLoad（高速化）  
● before/after の EXIF 差異を AI が抽出（判断禁止）


────────────────────────
14.5 AI違和感警告（v7.5R）
────────────────────────

AI が抽出する“違和感素材”を上部に赤ラベルで表示：

● 住所ゆらぎ  
● 写真不足  
● EXIF不整合  
● PRICE未入力  
● 完了コメント異常  
● 時系列異常  

※ GASが唯一の判断者。  
※ AIは警告素材の抽出のみ。


────────────────────────
14.6 健康スコア（v7.5R）
────────────────────────

● OV01 上部に大きく表示  
● 70点未満：赤ラベルで「不備あり」  
● logs/system に詳細理由を記録  
● ClickUp 管理タスクにも同期可能（任意）

──────────────────────────────────
15. OV02（全文検索フォーム：v7.5R）
──────────────────────────────────

目的：  
OrderID フォルダ全体（PDF／写真／ログ／追加報告／HistoryNotes）を  
全文検索し、案件横断で調査可能にする。

v7.5R で正式強化：

● ChatGPT API による OCR 補助（画像→テキスト素材）  
● PDFテキスト抽出補助  
● AI による“自然文検索 → キーワード化” の支援  
● PC／スマホUI最適化  
● タイル表示の高速化（LazyLoad）


────────────────────────
15.1 検索対象（v7.5R）
────────────────────────

● Order_YYYY  
● Archive_Order_YYYY  
● logs/system  
● PDFテキスト（AI抽出：素材のみ）  
● 画像文字情報（AI抽出：素材のみ）  
● 追加報告（UF08）  
● HistoryNotes  
● 部材写真（parts）  
● before/after（比較対象）


────────────────────────
15.2 検索トリガー（統合）
────────────────────────

● 「検索」  
● 「調査」  
● 「履歴検索」  
● 「探して」 （v7.5R：自然文トリガー追加）


────────────────────────
15.3 出力（v7.5R）
────────────────────────

● 検索結果タイル一覧  
● タイル押下 → OV01 遷移（該当Orderを開く）  
● スマホ UIでは 2〜3列可変  
● PCでは 4〜6列可変  
● AI素材抽出ログも一覧参照可（クリックで詳細）


──────────────────────────────────
16. IDフォルダ構造（v7.5R 完全版）
──────────────────────────────────

OrderID/
　docs/
　photos/
　　 before/
　　 after/
　　 parts/
　　 extra/
　videos/
　　 before/
　　 after/
　　 inspection/
　logs/
　　 system/
　　 extra/
　archive/

特徴：

● アーカイブは削除ではなく “整理”（歴史は残す）  
● OV01／OV02 で全文検索対象  
● v7.5R：AI OCR 記録も logs/system に保存  
● v7.5R：動画（inspection）も全文検索対象に追加  


──────────────────────────────────
17. AIスタイル設定（v7.5R 強化）
──────────────────────────────────

aiStyle = {
  politeness: "very_formal",
  numbering: true,
  confirmBeforeAction: true,
  assistantPersona: "concierge",
  preventOverEditing: true,        // v7.5R：AIが勝手に仕様を変えない
  respectSingleSource: true        // master_spec を唯一の正として扱う
}

ChatGPT はこの固定スタイルで番号化・丁寧案内を行う。
学習は禁止。


──────────────────────────────────
18. 構造化サマリ（data-model / ui-model 抜粋）
──────────────────────────────────

本章は、master_spec の内容を
AIコンパイラが参照しやすい “再掲ビュー” を提供する。

※ 新仕様の追加は禁止  
※ 唯一の正は 0〜17章および 19章であり、  
　本章は補助的ビューである。


────────────────────────
18.1 台帳定義（再掲ビュー）
────────────────────────

（CU_Master／UP_Master／Order_YYYY／Parts_Master／EX_Master／Expense_Master／Request／logs_system／Archive_Order の
　列名・主キー・indexKeys を master_spec 本文のまま再掲）


────────────────────────
18.2 フォーム定義（再掲ビュー）
────────────────────────

（UF01／UF06／UF07／UF08／FIX／DOC／OV01／OV02 の field 定義）


────────────────────────
18.3 注意事項（再掲）
────────────────────────

● 本章はあくまで再掲ビュー  
● 本文と差異がある場合、本文が唯一の正  


──────────────────────────────────
19. 更新履歴ビュー（構造整理）
──────────────────────────────────

本章は “version-minimal-mode” に基づき  
バージョン番号を本文に書かない代わりに、  
“何が追加・強化されたか” を構造的に記録する補助ビューである。

v7.5R 追加要素：

● Runtime監査（12.R）の正式採用  
● S→Apps Script 同期ルール（12.S）  
● Runtime テストルール（12.T）  
● rollback／self-diff（12.U）  
● ClickUp 管理タスク体系の復旧  
● ChatGPT API補助の正式採用  
● UI レスポンシブ化（全フォーム）  
● OV01／OV02 再設計  
● Before/After スライダー最適化  
● フォルダ構造の動画対応強化  
● AI違和感検知の強化  
● 健康スコア管理の強化  


──────────────────────────────────
20. UI 全面最適化仕様（PC／スマホ／タブレット対応）
──────────────────────────────────

本章は v7.5R で新設される UI 専用仕様であり、
すべてのフォーム（UF01〜UF08／FIX／DOC／OV01／OV02）が  
**業務に支障なく全端末で動作** するための強化ルールを定義する。

20.1 UI 原則（最重要）

● スマホで最適に動くこと（現場はスマホ中心）  
● PC では情報量を増やし操作性を高める  
● タブレットは自動幅計算による可変UI  
● 折りたたみ・LazyLoad・スワイプなどモダン操作採用  
● 視認性を損なう小文字・小ボタンは禁止  
● 過去 UI より劣化させてはならない（明示ルール化）


20.2 共通 UI コンポーネント

● 入力カード  
● 情報カード  
● 警告ラベル（AI違和感）  
● 写真ビューア（before/after/parts/extra）  
● 動画ビューア（inspection）  
● タブ切替（スマホ向け）


20.3 各フォーム UI

● UF01：スマホ1カラム＋PC2カラム  
● UF06：スマホ折りたたみ／PC2カラム  
● UF07：ボタン大型化（スマホ）  
● UF08：カメラ入力高速化  
● FIX：選択 UI の簡略化  
● DOC：入力補助強化  
● OV01：カルテビュー最適化  
● OV02：タイル検索ビュー最適化  


──────────────────────────────────
21. ClickUp 管理タスク仕様（v7.5R 正式復旧）
──────────────────────────────────

本章は、過去に存在しながら recent の master_spec で欠損していた  
「管理・監督 UI としての ClickUp の正式仕様」を完全復元したもの。

21.1 役割

● 現場の Todoist と分離した “管理・監督 UI”  
● 遅延検知・異常監視・警告受信  
● Order 単位の進行把握  
● AI違和感警告の集約  
● スケジュール・完了率の管理  


21.2 タスク名（管理用）

例：

  【KR】橋本カエデ様 / 西宮市甲子園口 / OrderID:xxx

● Todoist のタスク名と別管理  
● 情報量を多く、管理者向けに最適化


21.3 ClickUp に同期される情報

● Order_ID  
● addressCityTown  
● 顧客名  
● STATUS  
● 健康スコア  
● AI違和感（素材）  
● 遅延・未納品・未価格入力  
● UF01〜UF08 の主イベント  
● Runtime監査結果（optional）


21.4 ClickUp が受信する警告

● AI違和感（住所／写真／EXIF／完了コメント等）  
● PRICE未入力  
● 未納品部材  
● Runtime破綻  
● rollback発生  
● fallback発生（住所判定失敗など）


21.5 操作制限

● ClickUp から入力してはならない  
● 管理 UI としての通知・監督のみ行う  
● 業務値はすべて GAS のみが決める


──────────────────────────────────
22. ChatGPT API 補助仕様（v7.5R 完全版）
──────────────────────────────────

本章は ChatGPT API がこのシステム内でどのように
“補助層” として動作するかを正式記述する。

22.1 役割

ChatGPT API は以下の *素材抽出* を担当：

● UF01 の一次解析補助  
● UF06 の品番候補抽出  
● FIX の修正テンプレ生成  
● DOC の文章整形補助  
● OV02 の全文検索に向けて OCR素材提供  
● AI違和感候補の抽出  
● D の Self-Diff 補助（矛盾候補の表示）


22.2 禁止事項（最重要）

● 業務ロジックの判断  
● ID生成・変更  
● STATUS判定  
● PRICE推測  
● 仕様の勝手な書き換え  
● 「唯一の正」の本文を要約・再構成すること  


22.3 API 呼び出しの扱い

● GAS が直接呼ぶ（Apps Script → ChatGPT API）  
● ChatGPT API は “素材を返すだけ”  
● 判断・決定は必ず GAS  


──────────────────────────────────

（これで 0〜22章 の本文がすべて出力されました。  
次が **最終ブロック（END）** になります。）

──────────────────────────────────
23. システム全体像（v7.5R：四階層アーキテクチャ）
──────────────────────────────────

本章は、本仕様書の内容を基盤として運用される  
“よりそい堂 業務自動化システム（v7.5R）” の全体的なアーキテクチャを示す。
  
● 第一層：ChatGPT API（AI補助層）
　一次解析・OCR・自然文解析・修正テンプレ生成・違和感抽出  
　判断は禁止、素材抽出のみ行う。  

● 第二層：Todoist（現場 UI）
　現場作業・完了報告の唯一の UI。  
　完了報告は Webhook で GAS に即時送信される。  

● 第三層：ClickUp（管理・監督 UI）
　警告・遅延・異常・進行・履歴の監督用 UI。  
　現場側の操作は不可。入力は禁止。  

● 第四層：Google Apps Script（GAS：業務ロジック）
　住所・ID・STATUS・LOCATION・PRICE・書類・健康スコアなど  
　すべての正式値を決定する唯一の正。

v7.5R では、この四階層を “役割が絶対に混じらないように” 再定義し直した。


──────────────────────────────────
24. セキュリティと破綻防止（v7.5R）
──────────────────────────────────

● master_spec は本書が唯一の正。  
　AI の内部記憶・推測・短縮・要約はすべて禁止。

● ID 体系（2章）は “超禁区”。  
　AI の変更提案・再構成・圧縮を禁止する。  

● Runtime監査（12.R）は破綻を即検知。  
　expected effect／unexpected effect の欠落を即時 NG。  

● rollback（12.U）は 3 回連続の破綻時に S を完全復元する。  

● Self-Diff（12.U）は AI の矛盾検知をユーザーへ通知する補助。

● HTML フォームは checkEnvironment() を deleted / modified してはならない。
　フォーム誤起動による破綻を防ぐ。


──────────────────────────────────
25. 禁止事項（v7.5R）
──────────────────────────────────

このシステムでは次を禁止する：

● ChatGPT が仕様を勝手に要約すること  
● ChatGPT が本文を勝手に書き換えること  
● ChatGPT が ID生成・判断を行うこと  
● ClickUp からのデータ入力  
● Todoist 以外からの現場完了操作  
● フォームをスプレッドシート外から起動  
● Apps Script の部分編集（diffを使わない変更）  
● 「唯一の正」を曖昧にする説明的テキストの混入  

※ すべて破った場合、D チャットが検知して差し戻す。


──────────────────────────────────
26. Glossary（用語辞典：v7.5R）
──────────────────────────────────

※ あなたの指示に基づき、  
   以前欠損していた Glossary を正式に復旧し、  
   “簡潔でありながらも仕様に欠損が出ない最小構造” として追加。

● CU_ID
　顧客を識別する永続ID。AA001形式。

● UP_ID
　物件を識別する永続ID。CU_ID に紐づく。

● Order_ID
　受注を識別する一意ID。Order_YYYY シートの主キー。

● PART_ID
　BP/BM の区分＋年月＋AA＋PA/MA から構成される部材ID。

● STATUS
　STOCK／ORDERED／DELIVERED／USED／STOCK_ORDERED。

● SUMMARY
　UF01.html で生成される「作業カテゴリ＋作業スタンプ」。

● ADDRESSCITYTOWN
　GASが抽出する市区町名の正式値（AI値は禁止）

● RUNTIME監査（RuntimeCheck）
　実行後の「副作用の欠落・異常」を検査する手続き。

● EXPECTED EFFECT
　実行後に「必ず発生していなければならない副作用」。

● UNEXPECTED EFFECT
　実行後に「発生してはならない副作用」。

● SELF-DIFF
　AI が過去回答との差分矛盾を検知する補助機構。

● ROLLBACK
　3 回連続破綻時に S の安定版コードへ戻す構造。

● CLICKUP
　管理／監督 UI のためのタスク管理環境（入力は禁止）

● TODOIST
　現場／完了報告の唯一の UI。

● CHATGPT API
　AI 補助層。素材抽出・解析のみ行い、判断は行わない。


──────────────────────────────────
END OF master_spec（v7.5R：唯一の正・完全統合版）
──────────────────────────────────


────────────────────────
【新章：システム前提の確定仕様（B/A/T/C 向け統合要件）】
────────────────────────

本章は、従来の曖昧・未定義となっていた前提項目を正式仕様として確定し、
以降の B/A/T/C/S の各フェーズで「唯一の正」として扱うものとする。
本章の内容は、UI実行時設定（input.json）よりも常に優先される。

────────────────────────
1. brandProfiles の正式スキーマ
────────────────────────
brandProfiles は下記の固定構造を持ち、全ブランド共通で必須とする。

- id（string）  
- name（string）  
- orderPrefix（例：ORD）  
- customerPrefix（例：CU）  
- expensePrefix（例：EXP）  
- sheetMapping（下記の完全一致ルールに従う）  
    - customers → CU_Master  
    - orders → Order_YYYY  
    - expenses → Expense_Master  
    - parts → Parts_Master  
    - up → UP_Master  
    - ex → EX_Master  
- storageProfiles で参照する Drive フォルダID一覧  
    - orders / archive / logs / photos（全てブランド直下に確定配置）  

※ “継承” といった表現を廃止し、上記を唯一スキーマとする。

────────────────────────
2. sheet 名称・内部台帳名の正規化ルール
────────────────────────
master_spec 内で用いる台帳名と brandProfiles.sheetMapping は
必ず下記の 1:1 対応に従う。

- CU_Master ↔ customers  
- UP_Master ↔ up  
- Order_YYYY ↔ orders  
- Parts_Master ↔ parts  
- EX_Master ↔ ex  
- Expense_Master ↔ expenses  

上記と異なる別名・旧名は使用禁止とする。
互換が必要な場合は「互換レイヤ」を別途定義し、AI による推測補完は禁止。

────────────────────────
3. ID体系（Order_ID / Customer_ID / Expense_ID 等）の prefix確定
────────────────────────
各 ID prefix は master_spec に定義された値を唯一の正とし、
input.json に異なる prefix が存在する場合は実行エラーとする。

- orderPrefix：ORD  
- customerPrefix：CU  
- expensePrefix：EXP  

UI判断の仮値（例：CUS）は受け付けない。  
prefix は全レイヤで統一され、ID衝突を防止する。

────────────────────────
4. 年度・fiscalYear の正式仕様
────────────────────────
以下を年度計算の唯一ルールとして採用する。

- fiscalYear：西暦 YYYY  
- fiscalStart：毎年 1/1（後に変更する場合は本章の改訂が必要）  
- Order_YYYY など年度シートの切替は fiscalYear に従う  
- 年度跨ぎの ID・保存先切替は C フェーズではなく CONFIG / master_spec が決定

────────────────────────
5. storageProfiles（Drive構造）の確定仕様
────────────────────────
storageProfiles は下記の固定スキーマを持つ。

- driveType：shared または mydrive  
- sharedDriveName（shared の場合のみ必須）  
- folders：  
    - orders  
    - archive  
    - logs  
    - photos  

フォルダ名はブランド直下に一意に配置。  
年度枝番・世代管理が必要な場合は archive 側に集約する。

────────────────────────
6. logs/system の保存仕様
────────────────────────
logs/system の保存形式は下記のいずれかを選択し、本章で固定する。

（A）Sheet保存  
（B）Drive JSONファイル保存  

保存形式は CONFIG に記載し、本 master_spec にも明文化する。  
以下を必須定義とする：

- PII（住所/電話等）はマスキング  
- 更新履歴は1件1ファイルまたは1行ログ  
- 保持期間、アクセス権、フォルダ構造  
- ローテーション条件（最大件数・最大容量）  

────────────────────────
7. 外部統合 Todoist / ClickUp / ChatGPT / Geolonia の正式仕様
────────────────────────
外部統合は以下の 2 点を必ず明確にする。

（1）enabled=false 時の縮退運用  
- Todoist/ClickUp が無効の場合は、  
  完了同期・警告通知・三階層モデルのどこが停止し、  
  代替導線（UI・logs/system 出力等）をどこに設けるかを確定する。  
- ChatGPT の usage は「素材抽出・監査のみ」が基本。  
  コード生成を許可する場合は C の権限を別途正式化する。  
- Geolonia が無効の場合の住所生成手順（cityFixed/cityCustomの扱い）を明確化。

（2）認証・鍵管理・失敗時挙動・再送（冪等性）  
- API Key の保管場所  
- rate limit 到達時のリトライ  
- Webhook 再送時の idempotency key ルール  
- 失敗時のログ記録と UI 警告  

────────────────────────
8. 冪等性（idempotency）仕様の正式化
────────────────────────
以下のイベントには必ず idempotency key を付与する。

- UF01登録  
- UF06発注  
- 完了同期（Todoist/ClickUp）  
- 更新（再同期）  

idempotency key は  
「Order_ID + Event種別 + タイムスタンプ or シーケンス」  
などを採用し、重複イベントは「無視 / 上書き / 差分更新」のいずれかを明確に規定する。

────────────────────────
9. Request.PayloadJSON のスキーマ確定
────────────────────────
各フォーム（UF01/UF06/UF07/UF08/FIX/DOC 等）の  
PayloadJSON は下記をすべて必須とする。

- 必須フィールド一覧  
- 型（string/number/bool/array/object）  
- 許容値  
- バージョン（schemaVersion）  
- スキーマ外補完禁止  

GAS はスキーマ不一致をエラーとして扱う。

────────────────────────
10. doGet と「外部起動禁止」の整合仕様
────────────────────────
以下を正式仕様として採用する。

- WebApp 公開範囲（domain / 全員 / 限定ユーザー）  
- referer / token / role でのアクセス制御  
- doGet は「管理者・operator のみ」アクセス許可  
- 一般ユーザー UI は Spreadsheet UI 経由に限定  

────────────────────────
11. UI品質の客観指標（監査可能化）
────────────────────────
UI品質関連の定義を以下の指標として固定する。

- 初期ロード：3秒以内（4G回線想定）  
- DOM 要素数：最大 800  
- 画像解像度：最大 2000px  
- 入力ステップ数：フォーム内 12 ステップ以内  
- LazyLoad の閾値（画像）  
- スクロール量の上限  

これらの条件を満たさない変更は「UI品質劣化」とみなす。

────────────────────────
12. Drive フォルダ分類・紐付け規約の正式化
────────────────────────
Drive に保存される Before/After/parts/extra/videos/inspection の分類ルールを下記とする。

- ファイル命名規約  
- 重複衝突防止ルール  
- Order_ID との紐付け方法  
- 他案件混入防止方式（フォルダ隔離または prefix）  
- アーカイブ移動条件（完了後30日など）  

────────────────────────
13. ClickUp 双方向参照の正式仕様
────────────────────────
双方向は「リンクのみ」とし、  
ステータス更新・コメント同期は行わない。  
ClickUp からの入力は禁止し、  
AIは ClickUp のデータを素材として参照するのみ。

────────────────────────
14. logs/system と “AI違和感検知” の扱い
────────────────────────
enabled=false 時の扱いを以下に統一する。

- ClickUp 通知不可  
- logs/system に記録  
- UI上に軽微警告表示  

重大度は  
Low / Medium / High の 3段階を採用し、  
High は必ず UI 提示する。

────────────────────────

【本章の効力】
本章に記載された内容はすべて master_spec の正式仕様であり、  
以降の RUN において T-phase は本章を基準に監査を行う。
input.json の仮値や UI判断が本章と矛盾する場合、  
C-phase はエラーとする。

────────────────────────


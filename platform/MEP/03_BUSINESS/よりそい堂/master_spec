<!--
CURRENT_SCOPE: platform/MEP/03_BUSINESS/yorisoidou/
NOTE: operational note only; does NOT change master_spec meaning.
RULE: 1 theme = 1 PR; canonical is main after merge.
-->

<!-- LAYER: L2 -->

<!-- FOUNDATION_REF: MEP/foundation/FOUNDATION_SPEC.md -->

<!-- NOTE: This specification must conform to FOUNDATION_SPEC -->



★ master_spec（唯一の正・完全版｜業務仕様・再構成／復元版）

──────────────────────────────────
0. 概要・コンセプト
──────────────────────────────────

本仕様書（master_spec）は、よりそい堂 業務自動化システムにおける
「業務内容・業務データ・業務フロー・業務上の制約」を一貫して定義する
業務仕様の唯一の正である。

本仕様の目的：
・現場業務の迷い・再入力・判断ミスをゼロにする
・管理業務を現場から切り離し、監督可能にする
・業務履歴を完全追跡可能な形で保持する
・システムに依存せず、業務そのものを再現可能にする

0.1 システム名
システム名：よりそい堂 業務自動化システム

0.2 対象フロー（End-to-End）
受注（UF01：通知コピペ／1行メモ）
→ 顧客登録（CU_Master）
→ 物件登録（UP_Master）
→ 受注発行（Order_ID）
→ 現場タスク生成（現場タスク）
→ 管理タスク生成（管理・配分・監督）
→ 部材発注・再利用・納品（UF06／Parts_Master）
→ AA番号抽出とタスク名反映
→ 納品登録 → BP価格確定（UF06／UF07）
→ 作業実施
→ 現場完了（完了報告）→ USED化／経費計上／未使用部材のSTOCK戻し
→ 管理警告・進行通知
→ 書類（DOC）／修正（FIX）／追加報告（UF08）
→ 閲覧（OV01）
→ 全文検索（OV02）

0.3 判断権の原則（業務の不変条件）
・住所・ID・金額・区分・状態などの正式値は、業務ロジックにより確定される
・人・AI・外部ツールは、正式値を直接決定しない（素材抽出・監査・補助は可）

0.4 タスクの三階層モデル（業務定義）
・第一階層：現場タスク（完了報告の唯一の正）
・第二階層：管理タスク（監督・遅延検知・警告受信）
・第三階層：補助解析（素材抽出・解析・警告・自然文検索補助・監査補助）
・業務ロジック（台帳更新）は常に最上位の確定者として扱う

0.5 端末最適化（業務要求）
UF01〜UF08／FIX／DOC／OV01／OV02 は、PC／スマホ／タブレットの全端末で
業務に支障なく最適に動作すること。
業務負荷を増やすUI劣化は禁止する（手数増・視認性低下・操作困難・過度な待ち時間など）。

# 最終宣言（master_spec）

---

## 本書の位置づけ（最終確定）

本書（master_spec）は、  
MEP プロジェクトにおける **業務仕様の唯一の正（Single Source of Truth）**である。

本書は、

- MEP_PROTOCOL
- INTERFACE_PROTOCOL
- system_protocol
- UI_PROTOCOL

に完全に従属する。

本書は、  
業務の意味・構造・判断基準のみを定義し、  
システム制御・UI 表現・実装方法を定義しない。

---

## 正の唯一性

業務仕様としての「正」は、  
**本 master_spec に記述された内容のみ**とする。

以下は、  
正としての効力を持たない。

- 旧版 master_spec
- 派生メモ・説明文・口頭補足
- 実装上の都合による解釈
- UI 表示やシステム挙動からの逆算

---

## 再認証原則

本書に含まれるすべての要素は、  
**OK／修正／削除 の明示的再認証**を経て  
正として確定しているものとする。

再認証されていない要素は、  
存在していても **無効**とする。

---

## 設計と実装の分離

本書は、  
業務設計を定義する文書であり、  
実装仕様ではない。

本書に定義されていない業務意味は、  
いかなる実装においても採用してはならない。

---

## 変更手段の唯一性

本書への変更は、  
**diff 方式によってのみ**許可される。

以下を禁止する。

- 全文再構成
- 部分編集
- 無記録変更

---

## プロトコル衝突時の扱い

本書と各プロトコルが衝突した場合、  
**プロトコルを優先**する。

業務仕様は、  
統治思想・制御原則に従属する。

---

## 引継ぎと再現性

引継ぎ時には、  
**全文コピペ可能な master_spec**を  
必須成果物とする。

要約・抜粋・再編集による引継ぎは無効とする。

---

## 最終宣言

本宣言をもって、

MEP プロジェクトにおける  
業務仕様の正・変更方法・優先順位は  
**確定**とする。

これ以降の業務仕様変更は、  
本宣言を前提とした **別フェーズ**とする。

---



──────────────────────────────────
1. 業務設定（Business CONFIG）
──────────────────────────────────

1.1 基本項目（業務設定としての意味）
・システム名
・年度／会計月（年度切替・保存先切替に関わる業務概念）
・タイムゾーン（業務日時の基準）
・稼働対象期間（年度）

1.2 ブランド（業務単位）
・ブランドは業務単位で切替可能
・ブランドごとに顧客・受注・部材が独立する（ID接頭辞・台帳参照が分離される）

1.3 フォーム一覧（業務入口）
・UF01（受注）
・UF06（発注／納品）
・UF07（価格入力）
・UF08（追加報告）
・FIX（修正申請）
・DOC（書類リクエスト）
・OV01（閲覧カルテ）
・OV02（全文検索）

1.4 maintenanceMode（業務的メンテナンス）
maintenanceMode: true/false
true の場合：
・受注／発注／納品／価格入力／追加報告など「更新系業務」を停止する
・閲覧（OV01/OV02）および整合性検査を優先する
・重要ログ記録は継続する
操作者（業務権限）：最上位管理者のみ

1.5 権限ロール（業務役割）
guest / viewer / operator / staff / manager / admin / config-admin-primary / config-admin-secondary
・役割は「業務操作の可否」を定義する
・権限の技術的説明は本書に含めない（業務上の可否のみ）

──────────────────────────────────
2. ID体系（業務契約｜完全）
──────────────────────────────────

本章は、業務上「一意識別・追跡・接続」を成立させる契約として固定される。
ID は業務履歴の柱であり、再利用・改変・再発番を禁止する。

2.1 顧客ID（CU_ID）
意味：顧客を永続に識別する
フォーマット：CU-AA001
業務ルール：
・永続ID
・再利用不可／削除不可（無効化のみ）
・顧客に紐づく物件は UP_ID で表現する

2.2 物件ID（UP_ID）
意味：顧客に従属する物件を永続に識別する
フォーマット：UP-AA001-0001
業務ルール：
・永続ID
・必ず CU_ID に従属する
・受注は UP_ID に紐づく（同一顧客でも物件が違えば別）

2.3 受注ID（Order_ID）
意味：受注を識別する業務の中心キー（全接続点）
フォーマット：ORDER-YYYYMMDD-00001-<UP_ID>
業務ルール：
・受注単位で発行される（非永続）
・再利用不可
・タスク／部材／経費／書類／履歴／検索の中心キー

2.4 部材ID（PART_ID）
意味：部材を発注→納品→使用→在庫の全工程で貫通識別する
フォーマット：
・BP：BP-YYYYMM-AAxx-PAyy
・BM：BM-YYYYMM-AAxx-MAyy
業務ルール：
・BP/BM で体系が分かれる
・再利用不可
・部材状態（STATUS）の単位

2.5 発注行ID（OD_ID｜補助）
意味：同一受注内の発注行を一意に識別する補助ID
フォーマット：OD-<Order_ID>-001
業務ルール：
・1受注に複数存在可能
・業務追跡の補助であり、最上位の接続は Order_ID を用いる

2.6 使用部材ID（EX_ID）
意味：実際に使用された部材記録を一意に識別する
フォーマット：EX-YYYYMM-0001
業務ルール：
・Order_ID を唯一の接続キーとして扱う（CU/UP を直接持たない）
・再利用不可

2.7 経費ID（EXP_ID）
意味：確定した経費記録を一意に識別する
フォーマット：EXP-YYYYMM-0001
業務ルール：
・同月内連番
・再利用不可

2.8 テストID（0番）ルール（業務安全）
以下はテスト専用で本番利用不可：
AA00 / PA00 / MA00 / 0000 / EXP-YYYYMM-0000 / EX-YYYYMM-0000
業務ルール：
・テストデータは本番業務から除外される（閲覧・検索・集計の対象外）
・本番データへの流用禁止（混在は業務破綻とみなす）
──────────────────────────────────
3. 台帳構造（業務データモデル｜完全）
──────────────────────────────────

各台帳は業務上の意味を持つ唯一の保管場所であり、履歴は削除せず蓄積型を原則とする。

3.1 CU_Master（顧客台帳）
主キー：CU_ID
主要項目（業務的意味を持つ列）：
CU_ID / 顧客名 / カナ / 区分 / 電話1 / 電話2 / メール / 郵便番号 / 住所 / 担当者名 / 注意事項 / 作成日 / 更新日 / 有効
業務ルール：
・既存一致（電話／氏名／住所などの業務キー）により再利用登録を行うことがある
・顧客情報は管理タスクへ参照用に反映してよい（任意）

3.2 UP_Master（物件台帳）
主キー：UP_ID
必須関係：UP_ID は CU_ID に従属
主要項目：
UP_ID / CU_ID / 物件番号 / 物件名 / 郵便番号 / 住所 / 建物種別 / 部屋番号 / 管理会社 / 注意事項 / 作成日 / 更新日 / 有効
業務ルール：
・同一顧客＋同一住所の再利用登録を行うことがある
・物件情報は管理タスクへ参照用に反映してよい（任意）

3.3 Order_YYYY（受注台帳）
主キー：Order_ID
主要項目：
Order_ID / UP_ID / CU_ID / 媒体コード / 顧客名 / 電話 / 郵便番号 / 住所 / addressFull / addressCityTown /
希望日1 / 希望日2 / 見積金額 / 備考（raw全文） / summary / STATUS /
CreatedAt / UpdatedAt / LastSyncedAt / HistoryNotes
業務ルール：
・HistoryNotes は自由記述で、内部の Order_ID と相互参照できる
・受注の状態（STATUS）は業務フローに従い自動遷移する（章7・9参照）

3.4 Parts_Master（部材台帳）
主キー：PART_ID
主要項目：
PART_ID / AA番号 / PA/MA番号 / PART_TYPE（BP/BM） / Order_ID / OD_ID / 品番 / 数量 / メーカー /
PRICE / STATUS / CREATED_AT / DELIVERED_AT / USED_DATE / MEMO / LOCATION
部材STATUS（固定）：
STOCK / ORDERED / DELIVERED / USED / STOCK_ORDERED
業務ルール：
・LOCATION は在庫（STOCK）で必須
・BP は納品時に PRICE を確定する
・BM は PRICE=0（経費対象外）
・部材は受注内外で再利用・在庫に戻り得る（章8・9参照）

3.5 EX_Master（使用部材台帳）
主キー：EX_ID
主要項目：
EX_ID / Order_ID / PART_ID / AA番号 / PRICE / USED_DATE / MEMO
業務ルール：
・使用実績の確定記録
・Order_ID を唯一の接続キーとする（CU/UP を直接参照しない）

3.6 Expense_Master（経費台帳）
主キー：EXP_ID
主要項目：
EXP_ID / Order_ID / PART_ID / CU_ID / UP_ID / PRICE / USED_DATE / CreatedAt
業務ルール：
・USED 部材の PRICE を確定経費として記録する唯一の正
・金額の推測・代入は禁止（確定入力のみ）

3.7 Request（申請台帳：FIX/DOC/UF07/UF08）
主要項目：
Timestamp / Category / TargetID / PayloadJSON / Requester / Memo
業務ルール：
・修正／書類／金額補完／追加報告を申請として保持する箱
・内容は業務ルールに従って解釈・反映される
・危険修正は明確に区別し、直接適用を禁止する（章10）

3.8 logs/system・logs/extra（業務ログ）
業務ルール：
・重要アクションは記録し、履歴追跡の根拠とする
・検索（OV02）の対象となる（章11）

3.3.1 Order STATUS（列挙｜固定）

目的：
・Order_YYYY の STATUS を「業務上の状態語」として列挙し、曖昧な自由入力を禁止する。
・状態の確定は、業務イベント（UF/完了/申請処理など）により自動遷移する（人・AIが任意に変更しない）。

STATUS（固定列挙）：
- NEW            : 受注作成直後（UF01登録完了）
- IN_PROGRESS    : 受注進行中（作業・調整・発注/納品が進む）
- WAITING_PARTS  : 部材待ち（発注済み・未納品が残る）
- READY          : 作業可能（必要条件が揃い、実作業の実行待ち）
- DONE           : 現場完了（完了報告が起点。完了同期が走る）
- CLOSED         : 完了同期まで含めて確定（台帳/経費/在庫処理が整合）
- HOLD           : 保留（顧客都合/日程未確定等。進行停止）
- CANCELLED      : キャンセル（受注として打ち切り。履歴は残す）

自動遷移トリガー（最小定義）：
- UF01（受注確定）            → NEW
- UF06（発注/納品の進行）      → IN_PROGRESS / WAITING_PARTS / READY（部材状態により判定）
- 現場タスクの完了（完了報告） → DONE
- 完了同期が整合で完了         → CLOSED
- 明示申請（FIX）で保留         → HOLD（危険修正ではなく“進行停止”の扱い）
- 明示申請（FIX）で取消         → CANCELLED（業務として確定した場合のみ）

禁止事項（固定）：
- 人・AI・外部ツールが STATUS を直接書き換えない
- 未定義語の追加は禁止（追加は diff で本節を更新してのみ許可）

3.7.1 Request Category（列挙｜固定）

目的：
・Request.Category を列挙し、申請の意味を固定する（自由語の混入禁止）。
・TargetID の型を固定し、誤紐付け（別ID種の混在）を防ぐ。

Category（固定列挙）：
- FIX        : 危険修正の申請（承認/監督が前提。直接確定は禁止）
- DOC        : 書類リクエスト（見積/請求/領収など）
- UF07       : 価格入力の申請（BPのPRICE確定補完）
- UF08       : 追加報告の申請（写真/説明の追加）
- NOTE_ADD   : 軽微追記（注意事項/備考/メール等の追記。危険修正は含めない）
- REVIEW     : 監督レビュー要求（未確定/違和感/不足の確認依頼）

TargetID（型の固定）：
- Order_ID   : ORDER-YYYYMMDD-...（受注）
- PART_ID    : BP-YYYYMM-... / BM-YYYYMM-...（部材）
- CU_ID      : CU-AA...（顧客）
- UP_ID      : UP-AA...（物件）
- NONE       : 対象IDなし（例：REVIEW の一般依頼など。許可する場合のみ）

PayloadJSON（共通ルール）：
- 申請の入力値は「素材」であり、確定は業務ロジックが行う（判断権の原則）。
- 形式は JSON とし、必須キーは Category ごとに定義される（本書の該当章に従う）。

禁止事項（固定）：
- 未定義 Category の追加は禁止（追加は diff で本節を更新してのみ許可）
- TargetID に別種IDを混在させない（Order_ID欄にPART_ID等を入れない）

3.7.2 PayloadJSON schema（最小必須キー｜固定）

目的：
・Request.PayloadJSON の最小必須キーを Category ごとに固定し、
  入力の欠落・解釈ブレ・実装依存の混乱を防ぐ。
・「必須」は業務上の必須。UIは入力補助を行うが、正の確定は業務ロジックが行う。

共通（全Category共通ルール）：
- payloadVersion : "1.0"（必須：将来の互換のため固定）
- category       : Category と一致（必須：二重確認）
- targetType     : Order_ID / PART_ID / CU_ID / UP_ID / NONE（必須：TargetID型）
- targetId       : 上記 targetType の型に一致（必須。ただし targetType=NONE の場合は空可）

DOC（Category=DOC）：
- docType        : ESTIMATE / INVOICE / RECEIPT（必須）
- docName        : 宛名（必須）
- docDesc        : 内容（必須）
- priceStatus    : TBD / FINAL（必須）
- docPrice       : priceStatus=FINAL の場合必須（TBD の場合は空可）
- splitPolicy    : NONE / MANUAL（任意）
- scopeCategory  : 分割時の区分（任意：EQUIPMENT / INTERIOR 等）
- docMemo        : 補足（任意）

FIX（Category=FIX）：
- fixType        : 修正種別（必須：例：ORDER_CANCEL / PART_CANCEL / TYPE_CHANGE / VALUE_FIX / STOCK_DETACH 等）
- requestSummary : 申請理由の短文（必須）
- details        : 詳細（任意：自由文/構造化）
- decisionRequired : true/false（必須：監督判断が必要なら true）
- riskLevel      : LOW / MED / HIGH（任意：運用上の目安）

UF07（Category=UF07）：
- partId         : PART_ID（必須：targetType=PART_ID と一致させる）
- price          : 数値（必須：確定入力のみ）
- priceCurrency  : JPY（任意：省略時JPY）
- memo           : 補足（任意）

UF08（Category=UF08）：
- orderId        : Order_ID（必須：targetType=Order_ID と一致させる）
- note           : 追加説明（任意）
- photos         : 参照リスト（任意：URL/IDの配列）
- memo           : 補足（任意）

NOTE_ADD（Category=NOTE_ADD）：
- noteType       : EMAIL_ADD / WARNING_ADD / REMARK_ADD / CONTACT_ADD（必須）
- value          : 追記内容（必須）
- memo           : 補足（任意）

REVIEW（Category=REVIEW）：
- reviewType     : HEALTH_CHECK / INCONSISTENCY / MISSING_INFO / APPROVAL（必須）
- requestSummary : 依頼の短文（必須）
- memo           : 補足（任意）

禁止事項（固定）：
- payloadVersion を勝手に変えない（変更は diff で本節更新）
- category/targetType/targetId の不整合を許容しない（不整合は申請不備として扱う）
- 未定義キーの乱立は禁止（必要になった場合は本節へ追加し、正規化する）

3.4.1 Parts STATUS（遷移｜固定）

目的：
・Parts_Master.STATUS を「工程状態語」として固定し、遷移の意味を業務として明確化する。
・Parts の状態確定は、UF06/UF07/完了同期等の業務イベントにより行う（人・AIが任意に変更しない）。

STATUS（固定）：
- STOCK / ORDERED / DELIVERED / USED / STOCK_ORDERED
※ 本 master_spec に列挙された状態語以外は禁止。

遷移トリガー（最小定義）：
- UF06（発注確定）                  → ORDERED または STOCK_ORDERED（Order_ID有無で判定）
- UF06（納品確定）                  → DELIVERED
- UF07（価格入力）                  → 状態は原則維持（PRICE確定のみ）
- 完了同期（現場タスク完了起点）     → DELIVERED の対象は USED へ（使用確定）
- 未使用部材コメント抽出             → 在庫戻し（STOCK）※ LOCATION 整合が必須

禁止事項（固定）：
- STATUS を自由入力しない
- BP/BM の区分・PRICEの推測代入で状態を作らない

3.5.1 EX（使用部材）確定ルール（固定）

目的：
・EX_Master は「使用実績の確定記録」であり、後追い編集や推測を禁止する。
・Order_ID を唯一の接続キーとして、実績を追跡可能にする。

確定トリガー（固定）：
- 完了同期（現場タスク完了起点）でのみ作成/追記される。

必須整合（固定）：
- EX_Master は必ず Order_ID を持つ
- PART_ID は Parts_Master に存在し、対象の工程（DELIVERED→USED確定）と整合する
- AA番号/PRICE/USED_DATE は “確定値” のみ（推測代入禁止）

禁止事項（固定）：
- 人・AI・外部ツールが EX を直接生成して確定扱いにしない（申請は Request に置く）
- 既存EXの削除は禁止（履歴保全）

3.6.1 Expense（経費）確定ルール（固定）

目的：
・Expense_Master は「確定した経費記録」の唯一の正であり、推測・後追い編集を禁止する。
・原則、完了同期により USED 部材（BP）の PRICE を元に確定される。

確定トリガー（固定）：
- 完了同期（現場タスク完了起点）でのみ確定（作成/追記）される。

対象範囲（固定）：
- BP（メーカー手配品）：PRICE確定が前提（PRICE未確定は警告対象）
- BM：PRICE=0（経費対象外）※ 経費に入れない

必須整合（固定）：
- Order_ID / PART_ID の整合（Parts_Master と一致）
- PRICE は “確定値” のみ（推測代入禁止）
- USED_DATE は完了同期の確定日時（または業務ロジックが確定する使用日）

禁止事項（固定）：
- 人・AI・外部ツールが Expense を直接生成して確定扱いにしない（申請は Request に置く）
- 既存Expenseの削除は禁止（履歴保全）

──────────────────────────────────
4. 住所体系（業務要件）
──────────────────────────────────

住所は以下2本で保持する：
① addressFull（全文住所）
② addressCityTown（市区町＋町名まで）

業務ルール：
・addressCityTown は業務上の正式値として扱う
・抽出基準：市／区／町／村／郡まで＋直後の町名、丁目以下は含めない
・閲覧（OV01）・管理タスクでの参照キーとして用いる

──────────────────────────────────
5. UF01（受注）業務仕様
──────────────────────────────────

目的：通知全文／簡易メモから受注を開始し、顧客・物件・受注を正しく紐づける。

5.1 入力項目（業務要件）
・raw（通知全文 or 1行メモ）必須
・name / phone / addressFull / preferred1 / preferred2 / price

5.2 受注確定時の業務結果
・CU_Master：顧客の新規追加または既存再利用
・UP_Master：物件の新規追加または既存再利用
・Order_YYYY：Order_ID 発行、基本情報、summary、初期STATUS、履歴枠の作成
・現場タスク：初期タスク生成
・管理タスク：参照用に初回通知（任意）

5.3 summary（業務スタンプ）
・summary は受注内容の業務カテゴリ・作業スタンプを残す
・過剰な要約・省略は禁止（業務判断の置換禁止）

5.4 現場タスク名（初期生成）
形式：{AA群}{顧客名（敬称付）}{addressCityTown}_{媒体}
・初回は AA群なし
・後続の発注／納品で AA群が付与される（章7）

──────────────────────────────────
6. 部材体系（BP/BM/AA/PA/MA/LOCATION/廃番辞書）
──────────────────────────────────

6.1 PART_TYPE（業務定義）
・BP（メーカー手配品）：納品時に PRICE 確定
・BM（既製品／支給品等）：PRICE=0（経費対象外）

6.2 永続番号（AA）
AA01〜ZZ99（テストAA00は禁止）
意味：部材群を業務追跡するための永続番号（タスク名にも反映）

6.3 枝番（PA/MA）
・BP：PA01〜PA99（PA00禁止）
・BM：MA01〜MA99（MA00禁止）

6.4 在庫ロケーション（LOCATION）
・在庫（STOCK）として保持する部材は LOCATION を必須とする
・LOCATION 欠落は業務不備として扱い、管理側へ警告対象となる

6.5 廃番 → 新番 対応辞書（業務要件）
部材辞書に以下を持つ：
discontinued / replacement / keywords / photoUrl
業務ルール：
・廃番の場合は代替品案内を提示する（最終採用判断は業務ロジックで確定）
・keywords は全文検索の曖昧検索補助として利用する
──────────────────────────────────
7. UF06/UF07/UF08（部材業務）仕様
──────────────────────────────────

7.1 UF06（発注）業務
目的：部材の発注を確定し、Parts_Master に記録する。
業務ルール：
・BP/BM 区分を確定する
・採用された行のみ発注扱いとする
・Order_ID がない発注は STOCK_ORDERED として扱う

発注確定時に記録する業務結果（概要）：
・PART_ID 発行（BP/BMの体系に従う）
・OD_ID 発行（補助）
・STATUS=ORDERED
・BP：PRICE 未定
・BM：PRICE=0
・必要に応じて管理タスクへ在庫ステータス通知（任意）

7.2 UF06（納品）業務
目的：納品を確定し、部材状態を進行させる。
業務ルール：
・STATUS=DELIVERED
・DELIVERED_AT を記録
・BP は PRICE 入力必須（納品時確定）
・LOCATION を記録（在庫・管理に必要）
・AA群を抽出し、現場タスク名へ反映する
・全対象が納品済の場合、受注STATUSの自動判定が行われる（章8・9）

7.3 UF07（価格入力）業務
目的：BP の PRICE 未入力を補完し、業務として価格を確定する。
業務ルール：
・PART_ID の PRICE を更新
・部材STATUSは原則変更しない（価格確定のみ）
・価格未確定は管理側警告の対象

7.4 UF08（追加報告）業務
目的：追加写真／追加説明を受注に紐づけて保存する。
業務ルール：
・追加報告は受注の業務記録であり、履歴追跡の対象
・閲覧（OV01）に即時反映される
・追加報告は申請としてRequestに残してよい（運用方針）

7.5 受注STATUS自動判定（業務定義）
受注STATUSは、納品状況・部材の状態・再発注フラグ等を用いて自動判定される。
・人・AIが任意に変更してはならない
・遷移条件は「業務フローに沿った確定イベント」によってのみ成立する

──────────────────────────────────
8. タスク管理（現場／管理）業務仕様
──────────────────────────────────

8.1 現場タスク（唯一の完了報告UI）
・現場の作業はタスク単位で管理される
・完了報告（完了コメントを含む）が「業務完了の意思表示」として扱われる
・現場タスクは受注（Order_ID）に一意に紐づく

8.2 タスク名（現場）
形式：{AA群}{顧客名（敬称付）}{addressCityTown}_{媒体}
・addressCityTown は業務上の正式値を使用
・AA群は部材工程の進行により付与・更新される

8.3 管理タスク（監督UI）
役割：
・遅延検知・異常監視・警告受信
・受注単位の進行把握
・現場とは分離（入力は禁止、監督のみ）
管理タスク名（例）：
【媒体】顧客名 / addressCityTown / OrderID:xxx
同期される参照情報（業務要件）：
Order_ID / addressCityTown / 顧客名 / STATUS / 健康スコア / 違和感素材 / 遅延・不足フラグ

8.4 管理警告（業務要件）
以下が発生した場合、管理側へ警告対象となる：
・PRICE未入力
・未納品部材
・住所不整合
・写真不足
・違和感素材（住所ゆらぎ／時系列異常／文章異常など）
・追加報告や価格入力の不足
・業務整合性エラー（検査NG）

8.5 未使用部材処理（業務要件）
完了報告から未使用部材IDを抽出し、在庫（STOCK）へ戻す。
業務ルール：
・在庫戻しは LOCATION の整合が必須
・不整合は管理警告の対象

──────────────────────────────────
9. 完了同期（完了報告→台帳確定）業務仕様
──────────────────────────────────

目的：現場完了報告を起点に、受注・部材・経費・履歴を確定させる。

9.1 完了トリガー（業務）
・現場タスクの完了が完了同期の起点となる
・完了日時と完了コメント全文は業務履歴として保存される

9.2 完了時に確定される業務結果（必須）
・Order：完了日時／状態更新／最終同期日時の更新
・Parts：DELIVERED 部材の USED 化（使用確定）
・EX：使用部材記録の確定（必要項目の記録）
・Expense：使用部材に基づく経費の確定
・未使用部材：STOCK戻し（LOCATION整合必須）
・ログ：重要イベントの記録
・管理：進行通知および警告（任意）

9.3 未使用部材コメント書式（業務）
例：未使用：BP-YYYYMM-AAxx-PAyy, BM-YYYYMM-AAxx-MAyy
業務ルール：
・書式から部材IDを抽出できること
・抽出された部材は在庫処理の対象となる

9.4 健康スコア（業務指標｜減点条件の確定）

目的：
・受注単位の「整合性／記録品質／未処理リスク」を 0〜100 点で定量化し、
  監督（管理タスク／OV01）で “優先度” を判断できる状態にする。
・健康スコアは「表示／監督のための指標」であり、業務STATUS（章3.3.1）そのものを直接決めない。
  （STATUS確定はUF/完了同期/申請処理等の業務イベントでのみ行う）

算出（固定）：
・開始点：100点
・減点：本節の減点条件のみ（推測代入禁止／恣意的な追加禁止）
・下限：0点（0未満になった場合は0に丸める）
・再計算：完了同期（章9）を起点として必ず再計算し、以後も再同期／申請反映で再計算してよい（冪等）

減点カテゴリ（固定・上限あり）：

A) 入力欠落（上限 -25）
- 顧客名の欠落（Order_YYYY: 顧客名が空）                         : -5
- 電話の欠落（電話が空）                                           : -8
- addressFull の欠落（全文住所が空）                               : -10
- addressCityTown の欠落／抽出失敗（業務上の正式値が空）           : -7
※ A は合計が -25 を下回らない（最大 -25 まで）

B) 部材／経費の確定不足（上限 -35）
- BP の PRICE 未確定が残る（BPかつ PRICE 未入力が1件以上）          : -20
- 未納品部材が残る（Parts: ORDERED / STOCK_ORDERED が1件以上）      : -15
- USED（使用確定）と経費（Expense）整合が取れない（BP対象）         : -10
※ B は合計が -35 を下回らない（最大 -35 まで）
※ 「PRICE未確定」と「経費整合NG」が同根の場合でも、両方を二重に最大まで落とさないよう
   業務ロジックは “同一原因の過剰減点” を避けてよい（ただし本節の上限ルールは厳守）

C) 記録品質（上限 -25）
- summary が空／業務スタンプ欠落（章5.3）                          : -8
- 完了コメント全文が空（完了同期の根拠が薄い）                       : -5
- 写真不足フラグが立つ（before/after/parts/extra の必要条件未達）      : -10
- 違和感素材フラグが多発（住所ゆらぎ／時系列異常／文章異常等）       : -5
※ C は合計が -25 を下回らない（最大 -25 まで）
※ 写真不足／違和感素材は「素材フラグ」を元に判定し、UIや人が断定的に値を作らない（判断権の原則）

D) 未処理申請／監督要求（上限 -15）
- Request に FIX（decisionRequired=true）未処理が残る               : -10
- Request に REVIEW（未処理）が残る                                 : -5
※ D は合計が -15 を下回らない（最大 -15 まで）

点数帯の運用（固定）：
- 90〜100 : 健全（監督優先度 低）
- 70〜89  : 要注意（不足がある可能性。管理タスクで確認）
- 0〜69   : 不備あり（監督対象。原則“未解決の不足”を潰すまでクローズを遅らせる）

運用（固定）：
・閲覧（OV01）に表示する（章11.1）
・70点未満は不備ありとして扱い、管理側の監督対象とする
──────────────────────────────────
10. FIX / DOC（申請）業務仕様
──────────────────────────────────

10.1 FIX（修正申請）
目的：危険な修正を申請として扱い、業務を破壊せずに修正を進める。
カテゴリ例：
・発注キャンセル（返品可／不可）
・納品キャンセル（返品可／不可）
・区分変更（BP↔BM）
・入り値修正
・欠番扱い
・在庫切離し
業務ルール：
・管理／監督の判断を要する修正は「申請」として残す
・コメント等の軽率な入力で危険修正を直接確定してはならない

10.2 コメントによる軽微修正（許可範囲）
許可：
・メール追加
・注意事項追加
・担当者名追加
・備考追加
・軽微な見積修正
・使用部材の追加記録（削除不可）

禁止（危険修正）：
・BP↔BM変更
・価格大幅修正
・欠番扱い
・在庫切離し
・品番変更
・顧客名変更
・顧客住所変更
・物件住所変更
・AA再発番
・受注ID構造変更
・書類内容変更

10.3 DOC（書類リクエスト）
目的：見積書／請求書／領収書等を業務記録として生成するための申請。
入力項目（業務要件）：
orderId / docType / docName / docDesc / docPrice / docMemo
業務ルール：
・申請は Request に記録される
・生成物は受注に紐づく業務記録として保存される

──────────────────────────────────
10.4 DOC系ステータスと導線（見積／請求／領収｜業務定義）
──────────────────────────────────

目的：
・見積／請求／領収の「必須条件」「状態」「分割」を業務として固定し、
  UIや実装に業務判断が散逸しないようにする。

前提：
・申請（Request）に記録される入力は、業務ロジックが解釈して確定する。
・UIは本章の意味を表示・誘導するだけで、正を決めない（判断権の原則）。

10.4.1 共通フィールド（DOC系）
- orderId（任意：紐付け可能なら付与）
- docType（必須）: ESTIMATE / INVOICE / RECEIPT
- docName（必須）: 宛名
- docDesc（必須）: 内容（業務説明）
- docPrice（条件付き）: 金額
- docMemo（任意）: 補足

10.4.2 価格の確定状態（priceStatus）
- priceStatus: TBD / FINAL
  - TBD: 価格未確定（docPrice空を許容）
  - FINAL: 価格確定（docPrice必須）

10.4.3 見積（ESTIMATE）の業務導線（最小）
- 作成 → プレビュー（確認） → 確定
- 必須条件：docName / docDesc
- priceStatus=FINAL の場合：docPrice を必須

10.4.4 分割ポリシー（splitPolicy）
- splitPolicy: NONE / MANUAL
  - MANUAL: 1案件を複数DOCに分けて扱う（例：設備と内装）
  - 分割時は scopeCategory を付与して区分できる（例：EQUIPMENT / INTERIOR）
  - 分割の採否・構成（何通作るか／区分）は業務ロジックが確定し、UIは入力補助のみ

10.4.5 請求（INVOICE）の状態（invoiceStatus）
- invoiceStatus: DRAFT / ISSUED / PAID
  - DRAFT: 下書き（未発行）
  - ISSUED: 発行済み（支払待ち）
  - PAID: 入金済み
- 原則必須：docName / docDesc / docPrice
  - 未確定運用を許容する場合は invoiceStatus=DRAFT + priceStatus=TBD を併用する

10.4.6 領収（RECEIPT）の状態（receiptStatus）
- receiptStatus: DRAFT / ISSUED
  - DRAFT: 下書き
  - ISSUED: 発行済み
- 原則必須：docName / docDesc / docPrice

10.4.7 禁止事項（業務破壊防止）
- UIや人が、priceStatus/invoiceStatus/receiptStatus を恣意的に確定しない
- docPrice の推測・代入は禁止（確定入力のみ）
- 分割の結果（何通作るか／区分）は、業務ロジックの確定に従う

──────────────────────────────────
11. 閲覧・検索（OV01 / OV02）業務仕様
──────────────────────────────────

11.1 OV01（閲覧カルテ）
目的：受注単位の全業務情報を一画面で閲覧する。
表示項目（業務要件）：
・受注基本情報（顧客名／住所／媒体）
・顧客情報（CU_Master）
・物件情報（UP_Master）
・summary
・現場タスク情報
・STATUS
・LOCATION
・部材一覧（AA/PA/MA）
・写真（before/after/parts/extra）
・動画（inspection）
・EX／EXP
・HistoryNotes
・健康スコア
・違和感素材（警告ラベル）

11.2 HistoryNotes（履歴メモ）
・自由記述
・内部参照（Order_ID）とリンクし、追跡可能にする
・検索対象（OV02）

11.3 OV02（全文検索）
目的：受注フォルダ（ログ／写真／PDF等）を横断検索し調査可能にする。
検索対象（業務要件）：
・受注台帳（現行／アーカイブ）
・業務ログ（logs/system）
・追加報告（UF08）
・HistoryNotes
・部材情報
・写真・PDF等のテキスト化素材（補助素材として保存されたもの）

検索トリガー（業務）：
検索／調査／履歴検索／探して

──────────────────────────────────
12. 運用ルール（業務統治）
──────────────────────────────────

12.1 master_spec の不変
・本書は業務仕様の唯一の正である
・過去のメモ／記録／推測は業務仕様として効力を持たない
・変更は差分方式によってのみ行われる

12.2 入力入口の不変
・受注／部材／価格／追加報告は UF 系フォームが唯一の正
・管理ツールからの入力は禁止（監督のみ）

12.3 履歴保全
・履歴は削除せず蓄積（アーカイブ含む）
・検索対象から外さない（除外すべきはテストデータのみ）

12.4 在庫確認・更新（業務トリガー）
在庫確認：
・在庫部材（STATUS=STOCK）の一覧を返せること（品番／数量／AA／LOCATION）
更新（再同期）：
・受注・アーカイブ・部材・経費・タスク・管理参照を整合する
・冪等（何度行っても壊れない）を満たす

12.5 禁止事項（業務破壊防止）
・業務判断の横取り（人／AI／外部）
・非正規経路からの入力
・IDの再利用・改変
・危険修正の直接確定
・履歴の削除
・UI劣化（現場負荷増）

──────────────────────────────────
13. 用語（Glossary）
──────────────────────────────────

・CU_ID：顧客を識別する永続ID
・UP_ID：物件を識別する永続ID（CUに従属）
・Order_ID：受注を識別する中心キー（全接続点）
・PART_ID：部材を貫通識別するID（BP/BM体系）
・STATUS：受注・部材の状態（工程を表す）
・SUMMARY：受注内容を残す業務スタンプ
・ADDRESSCITYTOWN：市区町＋町名までの業務上の住所キー
・OV01：受注カルテ閲覧
・OV02：全文検索（調査）

──────────────────────────────────
END OF master_spec（唯一の正・完全版｜業務仕様・再構成／復元版）
──────────────────────────────────


## CHANGELOG
- 2026-01-01: Added CURRENT_SCOPE entrypoints (00_CURRENT_SCOPE_NOTE.md, 01_INDEX.md, master_spec/ui_spec headers).

### DOC example: Toilet remodel estimate (split into 2 documents)

- Scenario: Customer requests toilet remodel estimate.

  - Includes: (1) shower/warm-seat toilet item, (2) wallpaper, (3) floor

  - Requirement: create 2 documents (toilet item = 1 copy, wallpaper+floor = 1 copy)

  - Addressee (docName): 土岐啓子

- How to submit (DOC):

  - Create DOC request A (docType=ESTIMATE)

    - docName: 土岐啓子

    - docDesc: トイレ（シャワー暖房便座付き商品）見積

    - docPrice: (set later)

    - docMemo: includes product + install + notes; ask questions if required fields missing

  - Create DOC request B (docType=ESTIMATE)

    - docName: 土岐啓子

    - docDesc: 壁紙・床 見積

    - docPrice: (set later)

    - docMemo: scope=wallpaper+floor; ask questions if required fields missing

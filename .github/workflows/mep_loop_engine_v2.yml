name: MEP Loop Engine v2 (push-loop)
"on":
  push:
    branches: [ main ]
    paths:
      - .mep/loop_state.json
      - .github/workflows/mep_loop_engine_v2.yml
      - .github/workflows/mep_loop_entry.yml
concurrency:
  group: mep-loop-engine-v2
  cancel-in-progress: false
permissions:
  contents: write
  actions: write
jobs:
  zone:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: SSOT_SCAN
        shell: bash
        run: |
          set -euo pipefail
          echo "SSOT_SCAN_START"
          CANDIDATES=(
            "MEP_SSOT_MASTER"
            "MEP_SSOT_MASTER.md"
            "docs/MEP/MEP_SSOT_MASTER"
            "docs/MEP/MEP_SSOT_MASTER.md"
            "docs/MEP/MEP_SSOT_MASTER.txt"
            ".mep/MEP_BOOT_SPEC.md"
            "docs/MEP/MEP_BOOT_SPEC.md"
          )
          SSOT_PATH=""
          for p in "${CANDIDATES[@]}"; do
            if [ -f "$p" ]; then SSOT_PATH="$p"; break; fi
          done
          if [ -z "$SSOT_PATH" ]; then
            echo "::error::SSOT not found. Candidates tried: ${CANDIDATES[*]}"
            exit 1
          fi
          SSOT_HASH="$(sha256sum "$SSOT_PATH" | awk '{print $1}')"
          SSOT_VERSION="$(grep -Eo 'v[0-9]+\.[0-9]+\.[0-9]+\+[^[:space:]]+' "$SSOT_PATH" | head -n 1 || true)"
          if [ -z "$SSOT_VERSION" ]; then SSOT_VERSION="(unknown)"; fi
          mkdir -p .mep
          {
            echo "SSOT_PATH=$SSOT_PATH"
            echo "SSOT_HASH=$SSOT_HASH"
            echo "SSOT_VERSION=$SSOT_VERSION"
            echo "SSOT_VALID=true"
          } > .mep/RESTART_PACKET.txt
          echo "SSOT_SCAN_OK"
      - name: CONFLICT_SCAN (legacy detect -> MACHINE_ONLY STOP)
        shell: bash
        run: |
          set -euo pipefail
          echo "CONFLICT_SCAN_START"
          HIT=0
          if git grep -n -I -E "\bWORK_ID\b|\bWIP-\b|OLD_WORK_ID|LEGACY|旧WORK_ID|旧仕様|work_id" -- . >/dev/null 2>&1; then HIT=1; fi
          if [ "${HIT}" -eq 1 ]; then
            echo "[STOP][MACHINE_ONLY] legacy/new parallel detected"
            exit 2
          fi
          echo "CONFLICT_SCAN_OK"
      - name: Upload RESTART_PACKET
        uses: actions/upload-artifact@v4
        with:
          name: restart-packet
          path: .mep/RESTART_PACKET.txt
          if-no-files-found: error
      - name: Advance Loop (bounded push)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .mep
          STATE_FILE=".mep/loop_state.json"
          if [ ! -f "$STATE_FILE" ]; then
            echo '{"iter":0,"max_iter":50}' > "$STATE_FILE"
          fi
          ITER=$(python3 -c 'import json;print(json.load(open(".mep/loop_state.json"))["iter"])')
          MAX=$(python3 -c 'import json;print(json.load(open(".mep/loop_state.json"))["max_iter"])')
          if [ "$MAX" -gt 200 ]; then MAX=200; fi
          NEXT=$((ITER+1))
          echo "PUSH_LOOP iter=$ITER next=$NEXT max=$MAX"
          if [ "$NEXT" -gt "$MAX" ]; then
            echo "[STOP] reached max_iter: $MAX"
            exit 0
          fi
          python3 - <<'PY'
import json
p=".mep/loop_state.json"
d=json.load(open(p))
d["iter"]=int(d.get("iter",0))+1
open(p,"w").write(json.dumps(d,ensure_ascii=False,sort_keys=True))
print("updated",p,d)
PY
          git config user.name  "mep-loop-bot"
          git config user.email "mep-loop-bot@users.noreply.github.com"
          git add "$STATE_FILE"
          git commit -m "chore(loop): advance iter=$NEXT/$MAX" || exit 0
          git push origin HEAD:main
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= HtmlService.createHtmlOutputFromFile('common_ui').getContent(); ?>
</head>
<body onload="checkEnvironment(); initUF01();">
  <div class="app">
    <div class="header">
      <div class="titleWrap">
        <h1 class="title">UF01（受注）</h1>
        <p class="subtitle">通知全文の貼付け／1行メモから登録します（summary はスタンプ方式）。</p>
      </div>
      <div class="pill warn">AI補助：素材抽出のみ（判断はGAS）</div>
    </div>

    <div class="grid two">
      <div class="card">
        <div class="cardHeader"><h2>入力</h2></div>
        <div class="cardBody">
          <div class="field">
            <label>raw（通知全文 or 1行メモ）※必須</label>
            <textarea id="raw" placeholder="ここに通知全文を貼り付け"></textarea>
          </div>

          <div class="row two">
            <div class="field">
              <label>name</label>
              <input id="name" type="text" placeholder="例：山田 太郎">
            </div>
            <div class="field">
              <label>phone</label>
              <input id="phone" type="tel" placeholder="例：09012345678">
            </div>
          </div>

          <div class="field">
            <label>addressFull</label>
            <input id="addressFull" type="text" placeholder="例：兵庫県西宮市甲子園口3丁目5-2">
          </div>

          <div class="row two">
            <div class="field">
              <label>preferred1</label>
              <input id="preferred1" type="text" placeholder="例：12/15 午前">
            </div>
            <div class="field">
              <label>preferred2</label>
              <input id="preferred2" type="text" placeholder="例：12/16 夕方">
            </div>
          </div>

          <div class="field">
            <label>price（見積金額）</label>
            <input id="price" type="number" inputmode="numeric" placeholder="例：12000">
          </div>

          <div class="btns">
            <button class="btn ghost" id="btnFill" onclick="fillFromRaw();">rawから補助入力（AI補助）</button>
            <button class="btn primary" id="btnSubmit" onclick="submitUF01();">登録（GAS決定）</button>
          </div>

          <p class="help">注意：AI要約は禁止。summary は右側のスタンプで生成します（GASが正式値を決定）。</p>
        </div>
      </div>

      <div class="card">
        <div class="cardHeader"><h2>summary（スタンプ）</h2></div>
        <div class="cardBody">
          <div class="notice">スタンプはこのフォーム内で作成します（AI要約は行いません）。</div>
          <div class="field" style="margin-top:12px;">
            <label>スタンプ（自由入力）</label>
            <input id="summaryStamp" type="text" placeholder="例：エアコン清掃／室外機あり／防カビ">
          </div>
          <div class="field">
            <label>プレビュー</label>
            <div id="summaryPreview" class="pill"><span class="mono">(empty)</span></div>
          </div>
          <p class="help">送信時に summary として渡します。GAS 側で記録されます。</p>
        </div>
      </div>
    </div>
  </div>

<script>
  function initUF01(){
    qs('#summaryStamp').addEventListener('input', function(){
      var v = qs('#summaryStamp').value || '';
      qs('#summaryPreview').innerHTML = '<span class="mono">' + escapeHtml(v || '(empty)') + '</span>';
    });
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#39;');
  }

  function fillFromRaw(){
    // master_spec: ChatGPT API 補助は許可（判断禁止）。
    // この出力では API 実装を推測しないため、フォーム側は raw の簡易コピー補助に留める。
    var raw = qs('#raw').value || '';
    if (!raw.trim()) { alert('raw を入力してください'); return; }
    // 推測抽出は禁止のため、値は自動で埋めない。
    alert('AI補助（素材抽出）はGAS側で行います。必要な項目を手入力してください。');
  }

  function submitUF01(){
    var btn = qs('#btnSubmit');
    showBusy(btn, true);
    var payload = {
      raw: qs('#raw').value || '',
      name: qs('#name').value || '',
      phone: qs('#phone').value || '',
      addressFull: qs('#addressFull').value || '',
      preferred1: qs('#preferred1').value || '',
      preferred2: qs('#preferred2').value || '',
      price: qs('#price').value || '',
      summaryStamp: qs('#summaryStamp').value || ''
    };
    google.script.run
      .withSuccessHandler(function(res){
        showBusy(btn, false);
        alert('送信しました。\n（この出力にはUF01の業務ロジック未同梱のため、受信関数が未実装の場合はエラーになります）');
      })
      .withFailureHandler(function(err){
        showBusy(btn, false);
        alert('エラー: ' + (err && err.message ? err.message : err));
      })
      .onUF01Submit(payload);
  }
</script>
</body>
</html>

name: Text Integrity Guard

on:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute base/head (PR only)
        id: revs
        shell: bash
        run: |
          set -euo pipefail
          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.event.pull_request.head.sha }}"
          echo "base=$BASE" >> "$GITHUB_OUTPUT"
          echo "head=$HEAD" >> "$GITHUB_OUTPUT"
          echo "BASE=$BASE"
          echo "HEAD=$HEAD"

      - name: Detect changed files
        shell: bash
        run: |
          set -euo pipefail
          BASE="${{ steps.revs.outputs.base }}"
          HEAD="${{ steps.revs.outputs.head }}"
          git diff --name-only "$BASE...$HEAD" > changed_files.txt
          echo "Changed files:"
          cat changed_files.txt || true

      - name: Validate encoding / EOL / newline + tripwire (sensitive)
        shell: bash
        run: |
          set -euo pipefail
          BASE="${{ steps.revs.outputs.base }}"
          HEAD="${{ steps.revs.outputs.head }}"
          fail=0

          while IFS= read -r f; do
            [ -z "$f" ] && continue
            [ ! -f "$f" ] && continue

            bn="$(basename "$f")"
            is_sensitive=0
            if [ "$bn" = "master_spec" ] || [ "$bn" = "ui_spec.md" ]; then
              is_sensitive=1
            fi

            # Check: markdown + sensitive
            if [[ "$f" == *.md ]] || [ "$is_sensitive" -eq 1 ]; then
              # 1) CR(\r) must not exist
              if python3 - <<'PY' "$f"
import sys
p=sys.argv[1]
b=open(p,'rb').read()
sys.exit(1 if b.find(b'\r')!=-1 else 0)
PY
              then :; else
                echo "NG: CRLF/CR detected in $f"
                fail=1
              fi

              # 2) Must be valid UTF-8
              python3 - <<'PY' "$f" || (echo "NG: invalid UTF-8 in $f"; exit 1)
import sys
p=sys.argv[1]
open(p,'rb').read().decode('utf-8')
PY

              # 3) Must end with newline (if non-empty)
              python3 - <<'PY' "$f" || (echo "NG: missing final newline in $f"; exit 1)
import sys
p=sys.argv[1]
b=open(p,'rb').read()
if len(b)>0 and b[-1:]!=b'\n':
  raise SystemExit(1)
PY
            fi

            # 4) Tripwire for sensitive: block huge diff
            if [ "$is_sensitive" -eq 1 ]; then
              numstat=$(git diff --numstat "$BASE...$HEAD" -- "$f" | awk '{print $1" "$2}')
              ins=$(echo "$numstat" | awk '{print $1}')
              del=$(echo "$numstat" | awk '{print $2}')
              ins=${ins:-0}; del=${del:-0}
              total=$((ins+del))
              echo "SENSITIVE_DIFF $f: +$ins -$del (total=$total)"
              if [ "$total" -gt 200 ]; then
                echo "NG: large diff detected on sensitive file ($f). total=$total > 200"
                fail=1
              fi
            fi

          done < changed_files.txt

          if [ "$fail" -ne 0 ]; then
            echo "Text Integrity Guard: FAILED"
            exit 1
          fi
          echo "Text Integrity Guard: OK"
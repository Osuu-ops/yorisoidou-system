name: MEP Loop Engine v2 (phase3 pr-create)
"on":
  push:
    branches: [ main ]
concurrency:
  group: mep-loop-engine-v2
  cancel-in-progress: false
permissions:
  contents: write
  actions: write
  pull-requests: write
jobs:
  zone:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: SSOT_SCAN (safe-min)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .mep
          SSOT="docs/MEP/MEP_SSOT_MASTER.md"
          if [ ! -f "$SSOT" ]; then
            echo "::error::SSOT not found: $SSOT"
            exit 1
          fi
          HASH="$(sha256sum "$SSOT" | awk '{print $1}')"
          VER="$(grep -m1 -Eo 'v[0-9]+\.[0-9]+\.[0-9]+\+[^[:space:]]+' "$SSOT" || true)"
          if [ -z "$VER" ]; then VER="(unknown)"; fi
          {
            echo "SSOT_PATH=$SSOT"
            echo "SSOT_HASH=$HASH"
            echo "SSOT_VERSION=$VER"
            echo "SSOT_VALID=true"
          } > .mep/RESTART_PACKET.txt
          echo "SSOT_SCAN_OK"
      - name: CONFLICT_SCAN (safe-min)
        shell: bash
        run: |
          set -euo pipefail
          echo "CONFLICT_SCAN_START"
          FILES="$(git diff --name-only HEAD~1..HEAD || true)"
          echo "$FILES" | sed -n '1,200p'
          LEGACY=0
          NEW=0
          echo "$FILES" | grep -E '^docs/MEP/SSOT/WORK_ID|^docs/MEP/WORK_ID/' >/dev/null 2>&1 && LEGACY=1 || true
          echo "$FILES" | grep -E '^docs/MEP/SSOT/WORK_ITEMS|^docs/MEP/WORK_ITEMS/' >/dev/null 2>&1 && NEW=1 || true
          if [ "$LEGACY" -eq 1 ] && [ "$NEW" -eq 1 ]; then
            echo "::error::WB0001 CONFLICT_SCAN failed: legacy+new execution-candidate sources modified together."
            exit 1
          fi
          echo "CONFLICT_SCAN_OK"
      - name: WRITEBACK_PREFLIGHT (phase3 step1)
        shell: bash
        run: |
          set -euo pipefail
          echo "WRITEBACK_PREFLIGHT_START"
          PARENT="docs/MEP/MEP_BUNDLE.md"
          EVI="docs/MEP_SUB/EVIDENCE/MEP_BUNDLE.md"
          if [ ! -f "$PARENT" ]; then echo "::error::missing $PARENT"; exit 1; fi
          if [ ! -f "$EVI" ]; then echo "::error::missing $EVI"; exit 1; fi
          echo "PARENT_BUNDLE_VERSION=$(grep -m1 -Eo 'v[0-9]+\.[0-9]+\.[0-9]+\+[^[:space:]]+' "$PARENT" || true)"
          echo "EVIDENCE_BUNDLE_VERSION=$(grep -m1 -Eo 'v[0-9]+\.[0-9]+\.[0-9]+\+[^[:space:]]+' "$EVI" || true)"
          git status --porcelain || true
          echo "WRITEBACK_PREFLIGHT_OK"
      - name: PHASE3_WRITEBACK_BUNDLE
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          Write-Host "PHASE3_WRITEBACK_BUNDLE_START"
          if(-not (Test-Path -LiteralPath "tools/mep_writeback_bundle.ps1")){ throw "missing tools/mep_writeback_bundle.ps1" }
          ./tools/mep_writeback_bundle.ps1
          Write-Host "PHASE3_WRITEBACK_BUNDLE_OK"
      - name: PHASE3_CREATE_PR
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          Write-Host "PHASE3_CREATE_PR_START"
          if(-not (Test-Path -LiteralPath "tools/mep_writeback_create_pr.ps1")){ throw "missing tools/mep_writeback_create_pr.ps1" }
          ./tools/mep_writeback_create_pr.ps1 -BundlePath docs/MEP/MEP_BUNDLE.md
          Write-Host "PHASE3_CREATE_PR_OK"
      - name: Upload RESTART_PACKET
        uses: actions/upload-artifact@v4
        with:
          name: restart-packet
          path: .mep/RESTART_PACKET.txt
          if-no-files-found: error
      - name: Smoke
        run: echo "ENGINE_V2_PHASE3_OK"
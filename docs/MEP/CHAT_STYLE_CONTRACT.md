# CHAT_STYLE_CONTRACT（引っ越し後も崩れない会話/コード運用規約）

本書は「新チャット/新アカウント/記憶0」でも、同じ進め方・同じコード提示形式で作業を継続するための規約である。
この規約は会話の記憶に依存しない。リポジトリが唯一の正。

## 0. 起動（最優先）
- 新チャット開始時、最初に mep（= tools/mep_chat_packet_min.ps1 出力）を貼る。
- AIは個別ファイルを10個要求してはいけない。必要なら「mepの再貼付」だけを要求する。

## 1. 進め方（固定）
- 1テーマ = 1PR
- すべてPowerShellで完結する
- 「作成→commit→push→PR作成→auto-merge予約→checks確認→origin/main反映確認→main clean」までを1ブロックで提示する

## 2. コード提示の形式（固定）
- PowerShellコマンドは必ず “1つのコードブロック” にまとめる（分割禁止）
- プレースホルダ（<ID> 等）禁止。ブロック内で自動取得/変数化して完結させる
- 説明文はPowerShellが壊れないよう、ブロック内は # コメントで書く（本文をそのままコピペしても動く）


## 2.1 PowerShell 表示の注意（固定）
- Write-Host の `-f` 書式は引数の解釈でエラー表示（"accepts at most 1 arg(s)" 等）を誘発しやすい。
- 表示は原則 `[string]::Format("x={0}", $x)` を使う（コピー実行時のノイズ削減）。


## 2.2 1ブロックの原子性（固定）
- 「1回コピペ」のブロックは必ず `& { ... }` で包む（途中で停止しても後続が走らない）。
- 途中停止は `return` を使う（貼り付け方式による暴発を防ぐ）。

## 2.3 gh --json の固定（固定）
- PowerShell は `a,b,c` を引数分割するため、`gh ... --json` は事故りやすい。
- 対策は2択のみ：
  1) `--json "a,b,c"` のように必ずクォートする
  2) もしくは `gh ... --json "a,b,c" | ConvertFrom-Json` でPowerShell側で扱う（推奨）

## 3. 例外時の挙動（固定）
- auto-merge待機の確認はブロック内で短時間ポーリングし、反映確認まで行う
- 失敗時は「失敗したチェック名」だけを貼らせ、次の1ブロックで最小修正する

## 4. 唯一の正（Yorisoidou BUSINESS）
- Canonical（実体）：platform/MEP/03_BUSINESS/よりそい堂/master_spec（拡張子なし）
- Entry（案内）：platform/MEP/03_BUSINESS/よりそい堂/master_spec.md（入口）

## 5. IDEA統合タイミング（固定）

前提：
- CHAT_PACKET_MIN には docs/MEP/IDEA_INDEX.md が同梱される（存在する場合）。
- IDEA_INDEX は番号（1,2,3...）で統合対象を選ぶ一覧であり、会話と統合の起点となる。

AIの義務（固定）：
- 新チャット開始時（mep貼付後）、AIは必ず「IDEA統合タイミング提案」を短く提示する。
- 提案は “実装ではなく統合順” に限定し、次の観点で分類する：
  1) 統合先：master_spec（業務意味/必須条件/状態遷移/確定ルール） / ui_spec（表示・導線） / tools/docs（運用・手順）
  2) 優先度：NOW（今のテーマに直結） / NEXT（次のテーマで統合） / LATER（実装段階で統合）
  3) 理由：依存関係（上流→下流）、事故防止、監督/現場負荷、整合性ガードの観点

統合の実行（固定）：
- 実際の統合は 1テーマ=1PR で行う。
- AIは番号を使って「pick → finalize（PR作成→auto-merge→main clean）」の1ブロック手順を提示する。
- ユーザーが「統合は後で」と言った場合、AIは capture/list の運用だけ維持し、強制統合しない。

## 6. 最終監査（Go/No-Go）

目的：
- 「追加したい業務内容」や「統合したいIDEA」が、既存の master_spec / プロトコルと矛盾しないか、
  また運用破綻（汚染・判断権侵害・ID事故・推測代入・危険修正直確定）を招かないかを、統合前に止める。

AIの義務（固定）：
- ユーザーが「次に○○を追加したい」「IDEAを統合したい」と言ったら、PR作成の前に必ず監査を提示する。
- 監査は次の形式で簡潔に出す（結論→根拠→対処）：

(1) 結論：GO / NO-GO / GO(with fixes)
(2) 矛盾点（あれば列挙）：既存章/節との衝突、用語の再定義、状態遷移の競合 等
(3) 危険性（あれば列挙）：判断権の原則違反、ID再利用/改変、推測代入、危険修正の直接確定、履歴削除 等
(4) “やめたほうがいい” 判定の条件：プロトコル衝突、現場負荷増、監督不能化、ガード無効化 等
(5) 修正案：やるならどう直すか（統合先、章番号、最小差分、1テーマ=1PR）
(6) 次の一手：統合する場合のみ pick→finalize の1ブロック手順を提示する。NO-GO の場合は代替案を提示する。

固定チェック観点（最低限）：
- master_spec の「判断権の原則」「変更手段の唯一性」「禁止事項」に抵触しないか
- 章3（台帳）・章7/9（部材/完了同期）・章10（FIX/DOC）・章12（統治）との整合
- UIは ui_spec で導線のみ、業務意味は master_spec を変更する（責務境界）
- 1テーマ=1PR、差分最小、ガードが通ること（Text/Scope/Semantic 等）

## 7. トリガ語（固定）

目的：
- ユーザーの短い合図（トリガ語）で、AIが「迷わず同じ一本道」を開始できるようにする。

トリガ語（固定）：
- 「アイデアまとめて」
  - AIの出力（必須）：
    1) IDEA_INDEX を前提に、IDEA統合タイミング提案（Section 5）を提示する（NOW/NEXT/LATER + 統合先 + 理由）
    2) 最終監査（Go/No-Go）（Section 6）を提示する（矛盾点/危険性/NO-GO条件/修正案）
    3) 統合する場合のみ、pick→finalize（1テーマ=1PR）の“1回コピペPowerShell”を提示する
  - AIの禁止：
    - 10+ファイル要求は禁止（必要ならmep再貼付のみ）
    - いきなり統合PRを作らない（監査→GOのときのみ次の1手）

- 「アイデア収集」
  - AIの出力（必須）：
    - 収集（capture）を行うための“1回コピペPowerShell”を提示する（実行はユーザー）
    - 収集後は IDEA_INDEX の番号を根拠に Section 5/6 を提示する

備考：
- 実行トリガは「ユーザーがPowerShellを実行した瞬間」であり、AIが勝手に端末上で収集を実行することはしない。

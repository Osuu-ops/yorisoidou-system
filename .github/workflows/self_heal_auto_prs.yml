name: Self-Heal Auto PRs (no-checks / behind)

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "Target PR number (optional). If empty, scan auto/* branches."
        required: false
        default: ""
  schedule:
    - cron: "*/15 * * * *"

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: self-heal-auto-prs
  cancel-in-progress: false

jobs:
  self-heal:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.MEP_PR_TOKEN }}
      BRANCH_PREFIX: "auto/chat-packet-update-"
      BASE_BRANCH: "main"

    steps:
      - name: Checkout (for git operations)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.MEP_PR_TOKEN }}

      - name: Verify token presence
        run: |
          set -euo pipefail
          if [ -z "${GH_TOKEN:-}" ]; then
            echo "MEP_PR_TOKEN is required."
            exit 1
          fi
          gh --version

      - name: Resolve target PR list
        id: prs
        shell: bash
        run: |
          set -euo pipefail

          PR_INPUT="${{ inputs.pr_number }}"
          if [ -n "${PR_INPUT}" ]; then
            echo "prs=${PR_INPUT}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          prs=$(gh pr list --state open --base "${BASE_BRANCH}" \
            --json number,headRefName,isCrossRepository \
            --jq '.[] | select(.isCrossRepository==false) | select(.headRefName | startswith("'"${BRANCH_PREFIX}"'")) | .number' \
            | tr '\n' ' ' | sed 's/[[:space:]]*$//')

          echo "prs=${prs}" >> "$GITHUB_OUTPUT"

      - name: Self-Heal loop
        shell: bash
        run: |
          set -euo pipefail

          prs="${{ steps.prs.outputs.prs }}"
          if [ -z "${prs}" ]; then
            echo "No target PRs."
            exit 0
          fi

          echo "Target PRs: ${prs}"

          for pr in ${prs}; do
            echo "----"
            echo "PR #${pr}"

            headRef=$(gh pr view "${pr}" --json headRefName --jq .headRefName)
            isDraft=$(gh pr view "${pr}" --json isDraft --jq .isDraft)
            mergeState=$(gh pr view "${pr}" --json mergeStateStatus --jq .mergeStateStatus)
            behind=$(gh pr view "${pr}" --json commitsBehindBaseBranch --jq .commitsBehindBaseBranch)

            if [ "${isDraft}" = "true" ]; then
              echo "Skip draft PR."
              continue
            fi

            if [[ "${headRef}" != ${BRANCH_PREFIX}* ]]; then
              echo "Skip (headRef not matched): ${headRef}"
              continue
            fi

            echo "headRef=${headRef} mergeState=${mergeState} behind=${behind}"

            gh pr checkout "${pr}"
            git fetch origin "${BASE_BRANCH}:${BASE_BRANCH}" || true
            git fetch origin --prune || true

            if [ "${behind}" -gt 0 ] || [ "${mergeState}" = "BEHIND" ]; then
              echo "Attempt merge ${BASE_BRANCH} -> ${headRef}"
              set +e
              git merge --no-edit "origin/${BASE_BRANCH}"
              rc=$?
              set -e
              if [ $rc -ne 0 ]; then
                echo "Merge conflict (DIRTY). Abort and notify."
                git merge --abort || true

                gh pr comment "${pr}" --body $'### [SELF_HEAL] Auto-merge stopped (DIRTY)\n- Reason: merge conflict while syncing main\n- Action required: resolve conflict manually or close/regenerate PR.\n'
                continue
              else
                git push origin "HEAD:${headRef}"
                gh pr comment "${pr}" --body $'### [SELF_HEAL] Synced with main\n- Action: merged latest main into PR branch (safe merge)\n'
              fi
            fi

            checksCount=$(gh pr view "${pr}" --json statusCheckRollup --jq '.statusCheckRollup | length')
            echo "checksCount=${checksCount}"

            lastMsg=$(git log -1 --pretty=%s || echo "")
            if [ "${checksCount}" -eq 0 ]; then
              if [[ "${lastMsg}" == "chore(self-heal): trigger checks" ]]; then
                echo "Skip empty commit (already triggered)."
              else
                echo "No checks detected. Trigger synchronize via empty commit."
                git commit --allow-empty -m "chore(self-heal): trigger checks"
                git push origin "HEAD:${headRef}"

                gh pr comment "${pr}" --body $'### [SELF_HEAL] Triggered checks\n- Reason: PR had no status checks\n- Action: pushed empty commit to trigger CI\n'
              fi
            fi
          done

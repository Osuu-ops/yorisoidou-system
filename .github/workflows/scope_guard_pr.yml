name: Scope Guard (PR)

on:
  pull_request:

permissions:
  contents: read

jobs:
  scope_guard:
    name: Scope Guard (PR)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Enforce CURRENT_SCOPE Scope-IN
        shell: bash
        env:
          SCOPE_FILE: platform/MEP/90_CHANGES/CURRENT_SCOPE.md
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          set -euo pipefail

          if [ ! -f "$SCOPE_FILE" ]; then
            echo "::error::SCOPE_FILE not found: $SCOPE_FILE"
            exit 1
          fi

          python3 - <<'PY'
          import os, re, subprocess, sys, fnmatch

          scope_file = os.environ["SCOPE_FILE"]
          base = os.environ["BASE_SHA"]
          head = os.environ["HEAD_SHA"]

          def sh(cmd: str) -> str:
            return subprocess.check_output(cmd, shell=True, text=True).strip()

          raw = sh(f"git diff --name-only {base}..{head} || true")
          changed = [ln.strip() for ln in raw.splitlines() if ln.strip()]

          text = open(scope_file, "r", encoding="utf-8").read()

          m = re.search(r"^##\s*変更対象（Scope-IN）\s*$", text, flags=re.M)
          if not m:
            print("::error::Scope-IN section not found in CURRENT_SCOPE.md (expected header: ## 変更対象（Scope-IN）)")
            sys.exit(1)

          tail = text[m.end():]
          stop = re.search(r"^##\s+", tail, flags=re.M)
          block = tail[: stop.start()] if stop else tail

          allow = []
          for ln in block.splitlines():
            ln = ln.strip()
            if ln.startswith("- "):
              allow.append(ln[2:].strip())

          if not allow:
            print("::error::No Scope-IN entries found under ## 変更対象（Scope-IN）")
            sys.exit(1)

          def allowed(path: str) -> bool:
            for pat in allow:
              if fnmatch.fnmatch(path, pat):
                return True
            return False

          out = [p for p in changed if not allowed(p)]
          if out:
            print("::error::Scope Guard NG: out-of-scope changes detected")
            for p in out:
              print(f"::error:: - {p}")
            sys.exit(1)

          print("Scope Guard OK")
          PY
<!doctype html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{--bg:#0b1020;--card:#111a33;--line:#22315f;--txt:#eef2ff;--muted:#a9b3d6;--accent:#6ea8ff;--danger:#ff6e6e}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;background:#0a0f1f;color:var(--txt)}
    .wrap{max-width:1100px;margin:0 auto;padding:14px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:900px){.grid{grid-template-columns:1.2fr .8fr;align-items:start}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
    h1{font-size:18px;margin:0 0 10px}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    textarea,input{width:100%;box-sizing:border-box;background:#0c1430;color:var(--txt);border:1px solid #2a3a74;border-radius:12px;padding:12px;font-size:16px}
    textarea{min-height:150px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:700px){.row.two{grid-template-columns:1fr 1fr}}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{appearance:none;border:0;border-radius:12px;padding:12px 14px;font-size:16px;font-weight:700;background:var(--accent);color:#08102a;cursor:pointer}
    button.secondary{background:#24335f;color:var(--txt)}
    .note{font-size:12px;color:var(--muted);line-height:1.5}
    .stamp{display:flex;gap:8px;flex-wrap:wrap}
    .chip{border:1px solid #33478a;background:#0c1430;color:var(--txt);border-radius:999px;padding:8px 12px;font-size:14px;cursor:pointer}
    .chip.active{background:#223a85;border-color:#6ea8ff}
    .preview{white-space:pre-wrap;background:#0c1430;border:1px dashed #2a3a74;border-radius:12px;padding:12px;color:#dce5ff;font-size:13px;min-height:90px}
    .warn{color:var(--danger);font-weight:700}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="grid">
      <div class="card">
        <h1>UF01（受注）</h1>
        <div class="note">raw（通知全文 or 1行メモ）は必須です。summary は本フォーム内スタンプ方式のみです（AI要約は禁止）。</div>

        <label>raw（必須）</label>
        <textarea id="raw" placeholder="通知全文を貼り付け"></textarea>

        <div class="row two">
          <div>
            <label>name</label>
            <input id="name" placeholder="顧客名">
          </div>
          <div>
            <label>phone</label>
            <input id="phone" placeholder="電話">
          </div>
        </div>

        <label>addressFull</label>
        <input id="addressFull" placeholder="住所（全文）">

        <div class="row two">
          <div>
            <label>preferred1</label>
            <input id="preferred1" placeholder="希望日1">
          </div>
          <div>
            <label>preferred2</label>
            <input id="preferred2" placeholder="希望日2">
          </div>
        </div>

        <div class="row two">
          <div>
            <label>price（見積金額）</label>
            <input id="price" placeholder="例：12000">
          </div>
          <div>
            <label>媒体コード</label>
            <input id="mediaCode" placeholder="KR/MM/unknown">
          </div>
        </div>

        <label>summary（スタンプ）</label>
        <div class="stamp" id="stamp"></div>
        <input id="summary" placeholder="スタンプ結果" readonly>

        <div class="btnRow">
          <button onclick="submitUF01()">送信</button>
          <button class="secondary" onclick="clearForm()">クリア</button>
        </div>
        <div class="note" style="margin-top:10px" id="msg"></div>
      </div>

      <div class="card">
        <h1>プレビュー</h1>
        <div class="note">PCでは右側固定相当、スマホでは下に表示されます。</div>
        <div class="preview" id="preview"></div>
        <div class="note" style="margin-top:10px">
          <span class="warn">注意：</span>本フォーム内で AI 要約は行いません（仕様）。
        </div>
      </div>
    </div>
  </div>

  <script>
    function checkEnvironment() {
      if (typeof google === "undefined" || !google.script || !google.script.run) {
        alert("このフォームは正しい方法で開かれていません。\nスプレッドシートのメニューから開いてください。");
      }
    }

    function onloadMerged() {
      checkEnvironment();
      buildStamps();
      bindPreview();
      renderPreview();
    }

    window.addEventListener('load', onloadMerged);

    const STAMPS = ["エアコン", "洗濯機", "換気扇", "浴室", "キッチン", "その他"];

    function buildStamps(){
      const root = document.getElementById('stamp');
      root.innerHTML = '';
      STAMPS.forEach(s=>{
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'chip';
        b.textContent = s;
        b.onclick = ()=>toggleStamp(s,b);
        root.appendChild(b);
      });
    }

    function toggleStamp(s, el){
      el.classList.toggle('active');
      const active = Array.from(document.querySelectorAll('.chip.active')).map(x=>x.textContent);
      document.getElementById('summary').value = active.join(' / ');
      renderPreview();
    }

    function bindPreview(){
      ['raw','name','phone','addressFull','preferred1','preferred2','price','summary','mediaCode'].forEach(id=>{
        document.getElementById(id).addEventListener('input', renderPreview);
      });
    }

    function renderPreview(){
      const p = {
        raw: v('raw'),
        name: v('name'),
        phone: v('phone'),
        addressFull: v('addressFull'),
        preferred1: v('preferred1'),
        preferred2: v('preferred2'),
        price: v('price'),
        summary: v('summary'),
        mediaCode: v('mediaCode')
      };
      document.getElementById('preview').textContent = JSON.stringify(p, null, 2);
    }

    function v(id){return document.getElementById(id).value || ''}

    function clearForm(){
      ['raw','name','phone','addressFull','preferred1','preferred2','price','summary','mediaCode'].forEach(id=>document.getElementById(id).value='');
      Array.from(document.querySelectorAll('.chip.active')).forEach(x=>x.classList.remove('active'));
      renderPreview();
      document.getElementById('msg').textContent='';
    }

    function submitUF01(){
      const payload = {
        raw: v('raw'),
        name: v('name'),
        phone: v('phone'),
        addressFull: v('addressFull'),
        preferred1: v('preferred1'),
        preferred2: v('preferred2'),
        price: v('price'),
        summary: v('summary'),
        mediaCode: v('mediaCode')
      };
      if (!payload.raw.trim()) {
        document.getElementById('msg').textContent = 'raw は必須です。';
        return;
      }
      document.getElementById('msg').textContent = '送信中...';
      google.script.run.withSuccessHandler(function(res){
        document.getElementById('msg').textContent = '送信しました。';
      }).withFailureHandler(function(err){
        document.getElementById('msg').textContent = 'エラー: ' + (err && err.message ? err.message : err);
      }).onUF01Submit(payload);
    }
  </script>
</body>
</html>
